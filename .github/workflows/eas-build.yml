name: EAS Build & Submit (iOS)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - release/**

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Bun
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "BUN_INSTALL=$HOME/.bun" > $GITHUB_ENV
          echo "$HOME/.bun/bin" > $GITHUB_PATH

      - name: Install EAS CLI
        run: npm install -g eas-cli@~3

      - name: Login to Expo
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas whoami || eas login --token "$EXPO_TOKEN"

      - name: EAS build (iOS)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EXPO_NO_TELEMETRY: 1
        run: |
          eas build --platform ios --profile production --non-interactive

      - name: EAS submit (to TestFlight) - optional
        if: ${{ secrets.APPLE_API_KEY_JSON || secrets.APPLE_SPECIFIC_PASSWORD }}
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          APPLE_API_KEY_JSON: ${{ secrets.APPLE_API_KEY_JSON }}
          APPLE_SPECIFIC_PASSWORD: ${{ secrets.APPLE_SPECIFIC_PASSWORD }}
        run: |
          if [ -n "$APPLE_API_KEY_JSON" ]; then
            echo "$APPLE_API_KEY_JSON" > /tmp/apple-api-key.json
            eas submit --platform ios --non-interactive --apple-app-store-connection /tmp/apple-api-key.json
          else
            eas submit --platform ios --non-interactive --apple-id "${{ secrets.APPLE_ID }}" --apple-app-specific-password "$APPLE_SPECIFIC_PASSWORD"
          fi

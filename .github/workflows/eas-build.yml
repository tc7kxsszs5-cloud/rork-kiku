name: EAS Build & Submit (iOS)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - release/**

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install Bun
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "BUN_INSTALL=$HOME/.bun" >> $GITHUB_ENV
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Verify Bun installation
        run: |
          export PATH="$HOME/.bun/bin:$PATH"
          bun --version

      - name: Install dependencies with Bun
        run: |
          export PATH="$HOME/.bun/bin:$PATH"
          bun install --frozen-lockfile

      - name: Install EAS CLI
        run: npm install -g eas-cli@^7.0.0

      - name: Login to Expo
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          if [ -z "$EXPO_TOKEN" ]; then
            echo "Error: EXPO_TOKEN secret is not set"
            exit 1
          fi
          eas whoami || eas login --token "$EXPO_TOKEN"

      - name: EAS build (iOS)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EXPO_NO_TELEMETRY: 1
        run: |
          set -e
          eas build --platform ios --profile production --non-interactive

      - name: EAS submit (to TestFlight) - optional
        if: >-
          ${{
            secrets.APPLE_API_KEY_JSON ||
            secrets.APPLE_SPECIFIC_PASSWORD
          }}
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          APPLE_API_KEY_JSON: ${{ secrets.APPLE_API_KEY_JSON }}
          APPLE_SPECIFIC_PASSWORD: ${{ secrets.APPLE_SPECIFIC_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
        run: |
          set -e
          if [ -n "$APPLE_API_KEY_JSON" ]; then
            echo "Using Apple API Key for submission"
            echo "$APPLE_API_KEY_JSON" > /tmp/apple-api-key.json
            eas submit --platform ios --non-interactive \
              --apple-app-store-connection /tmp/apple-api-key.json
            rm -f /tmp/apple-api-key.json
          elif [ -n "$APPLE_SPECIFIC_PASSWORD" ] && [ -n "$APPLE_ID" ]; then
            echo "Using Apple ID and App-Specific Password for submission"
            eas submit --platform ios --non-interactive \
              --apple-id "$APPLE_ID" \
              --apple-app-specific-password "$APPLE_SPECIFIC_PASSWORD"
          else
            echo "Warning: No valid Apple credentials found."
            echo "Skipping TestFlight submission."
            exit 0
          fi

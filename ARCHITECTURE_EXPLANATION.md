# üèóÔ∏è –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤

## üìä –î–∏–∞–≥—Ä–∞–º–º–∞: Clean Architecture / MVVM

```
UI
‚Üì
ViewModel
‚Üì
UseCase
‚Üì
Repository
‚Üì
WebSocketClient + LocalDB
```

## üîç –ß—Ç–æ —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç?

–≠—Ç–æ **Clean Architecture / MVVM** (Model-View-ViewModel) –ø–∞—Ç—Ç–µ—Ä–Ω —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞ —Å–ª–æ–∏:

### 1Ô∏è‚É£ **UI** (Presentation Layer)
- **–ß—Ç–æ:** –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, —ç–∫—Ä–∞–Ω—ã)
- **–†–æ–ª—å:** –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–ü—Ä–∏–º–µ—Ä –≤ KIKU:** `app/(tabs)/index.tsx`, `components/ChatItem.tsx`

### 2Ô∏è‚É£ **ViewModel** (Presentation Logic)
- **–ß—Ç–æ:** –õ–æ–≥–∏–∫–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º UI
- **–†–æ–ª—å:** –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ UseCase –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è UI, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è UI
- **–ü—Ä–∏–º–µ—Ä –≤ KIKU:** `constants/MonitoringContext.tsx`, `constants/UserContext.tsx`

### 3Ô∏è‚É£ **UseCase** (Business Logic)
- **–ß—Ç–æ:** –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- **–†–æ–ª—å:** –†–µ–∞–ª–∏–∑—É–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ", "–ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∏—Å–∫")
- **–ü—Ä–∏–º–µ—Ä –≤ KIKU:** –°–µ–π—á–∞—Å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ Context, –Ω–æ –º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ UseCase

### 4Ô∏è‚É£ **Repository** (Data Abstraction)
- **–ß—Ç–æ:** –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è –Ω–∞–¥ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
- **–†–æ–ª—å:** –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º, —Å–∫—Ä—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (WebSocket/LocalDB)
- **–ü—Ä–∏–º–µ—Ä –≤ KIKU:** –°–µ–π—á–∞—Å –ø—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã AsyncStorage, –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å Repository

### 5Ô∏è‚É£ **WebSocketClient + LocalDB** (Data Sources)
- **–ß—Ç–æ:** –†–µ–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö
- **–†–æ–ª—å:** WebSocket –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, LocalDB –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è
- **–ü—Ä–∏–º–µ—Ä –≤ KIKU:** `@react-native-async-storage/async-storage`, `lib/trpc.ts` (–¥–ª—è –±—É–¥—É—â–µ–≥–æ WebSocket)

## üÜö –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π KIKU

### –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ KIKU:

```
UI (React Native Components)
‚Üì
Context API (State Management)
  ‚Üì
  ‚îú‚îÄ MonitoringContext ‚Üí AsyncStorage
  ‚îú‚îÄ UserContext ‚Üí AsyncStorage
  ‚îî‚îÄ ParentalControlsContext ‚Üí AsyncStorage
‚Üì
tRPC Client ‚Üí Backend (Hono + tRPC)
```

### –†–∞–∑–ª–∏—á–∏—è:

| –ê—Å–ø–µ–∫—Ç | Clean Architecture | –¢–µ–∫—É—â–∞—è KIKU |
|--------|-------------------|--------------|
| **UI Layer** | ‚úÖ –ï—Å—Ç—å (–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã) | ‚úÖ –ï—Å—Ç—å (`app/`, `components/`) |
| **ViewModel** | ‚úÖ –û—Ç–¥–µ–ª—å–Ω—ã–π —Å–ª–æ–π | ‚úÖ Context API –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–æ–ª—å ViewModel |
| **UseCase** | ‚úÖ –û—Ç–¥–µ–ª—å–Ω—ã–π —Å–ª–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ | ‚ö†Ô∏è –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Å–º–µ—à–∞–Ω–∞ —Å Context |
| **Repository** | ‚úÖ –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö | ‚ùå –ü—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã AsyncStorage |
| **Data Sources** | ‚úÖ WebSocket + LocalDB | ‚úÖ AsyncStorage + tRPC |

## üí° –ù—É–∂–Ω–æ –ª–∏ –≤–Ω–µ–¥—Ä—è—Ç—å —ç—Ç—É –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É?

### ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Clean Architecture:

1. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏** - –∫–∞–∂–¥—ã–π —Å–ª–æ–π –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–≤–æ—é –∑–∞–¥–∞—á—É
2. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ
3. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ø—Ä–æ—â–µ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
4. **–ì–∏–±–∫–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –º–µ–Ω—è—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ–±–∞–≤–∏—Ç—å GraphQL)

### ‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:

1. **–°–ª–æ–∂–Ω–æ—Å—Ç—å** - –±–æ–ª—å—à–µ –∫–æ–¥–∞, –±–æ–ª—å—à–µ —Ñ–∞–π–ª–æ–≤
2. **–û–≤–µ—Ä—Ö–µ–¥** - –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω–æ
3. **–ö—Ä–∏–≤–∞—è –æ–±—É—á–µ–Ω–∏—è** - –∫–æ–º–∞–Ω–¥–µ –Ω—É–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω

### üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è KIKU:

**–í–∞—Ä–∏–∞–Ω—Ç 1: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**
- –û—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å Context API
- –í—ã–Ω–µ—Å—Ç–∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –≤ UseCase –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ
- –°–æ–∑–¥–∞—Ç—å Repository –¥–ª—è AsyncStorage
- –î–æ–±–∞–≤–∏—Ç—å WebSocket –∫–ª–∏–µ–Ω—Ç –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

**–í–∞—Ä–∏–∞–Ω—Ç 2: –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å**
- –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
- Context API –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
- –ú–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∏

## üîß –ö–∞–∫ –≤–Ω–µ–¥—Ä–∏—Ç—å Clean Architecture –≤ KIKU?

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫:

```
app/                        # UI Layer (–æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å)
components/                 # UI Layer (–æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å)

domain/                     # –ù–û–í–´–ô - –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
  useCases/                 # UseCase —Å—Ü–µ–Ω–∞—Ä–∏–∏
    monitoring/
      AnalyzeMessageUseCase.ts
      GetChatsUseCase.ts
    parental/
      CreateSOSAlertUseCase.ts
      UpdateSettingsUseCase.ts

data/                       # –ù–û–í–´–ô - –î–∞–Ω–Ω—ã–µ
  repositories/             # Repository —Å–ª–æ–π
    ChatRepository.ts
    UserRepository.ts
    SettingsRepository.ts
  sources/                  # –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    localStorage/           # AsyncStorage –æ–±–µ—Ä—Ç–∫–∞
    websocket/              # WebSocket –∫–ª–∏–µ–Ω—Ç (–±—É–¥—É—â–µ–µ)
    trpc/                   # tRPC –∫–ª–∏–µ–Ω—Ç (—É–∂–µ –µ—Å—Ç—å)

presentation/               # –ù–û–í–´–ô - ViewModel (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  viewModels/               # –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å Context –∫–∞–∫ –µ—Å—Ç—å
    MonitoringViewModel.ts
```

### –ü—Ä–∏–º–µ—Ä UseCase:

```typescript
// domain/useCases/monitoring/AnalyzeMessageUseCase.ts
export class AnalyzeMessageUseCase {
  constructor(
    private chatRepository: ChatRepository,
    private aiService: AIService
  ) {}

  async execute(message: string, chatId: string): Promise<RiskLevel> {
    // –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    const chat = await this.chatRepository.getChatById(chatId);
    const analysis = await this.aiService.analyzeMessage(message, chat.context);
    await this.chatRepository.updateChatRisk(chatId, analysis.riskLevel);
    return analysis.riskLevel;
  }
}
```

### –ü—Ä–∏–º–µ—Ä Repository:

```typescript
// data/repositories/ChatRepository.ts
export class ChatRepository {
  constructor(
    private localDB: LocalDBStorage,
    private websocketClient?: WebSocketClient
  ) {}

  async getChats(): Promise<Chat[]> {
    // –õ–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —á–∞—Ç–æ–≤: —Å–Ω–∞—á–∞–ª–∞ –∏–∑ LocalDB, –ø–æ—Ç–æ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
    const localChats = await this.localDB.getChats();
    if (this.websocketClient) {
      const remoteChats = await this.websocketClient.getChats();
      return this.mergeChats(localChats, remoteChats);
    }
    return localChats;
  }
}
```

## üìù –ò—Ç–æ–≥

**–î–∏–∞–≥—Ä–∞–º–º–∞ `UI ‚Üí ViewModel ‚Üí UseCase ‚Üí Repository ‚Üí WebSocketClient + LocalDB`** - —ç—Ç–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è Clean Architecture, –∫–æ—Ç–æ—Ä–∞—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

- ‚úÖ –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
- ‚úÖ –õ–µ–≥–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ì–∏–±–∫–æ—Å—Ç—å –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

**–í –ø—Ä–æ–µ–∫—Ç–µ KIKU** —É–∂–µ –µ—Å—Ç—å –ø–æ—Ö–æ–∂–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —á–µ—Ä–µ–∑ Context API, –Ω–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å:

1. **–í—ã–Ω–µ—Å—Ç–∏ UseCase** –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
2. **–°–æ–∑–¥–∞—Ç—å Repository** –¥–ª—è –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
3. **–î–æ–±–∞–≤–∏—Ç—å WebSocket** –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (–∫–æ–≥–¥–∞ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ù–∞—á–Ω–∏—Ç–µ —Å —Å–æ–∑–¥–∞–Ω–∏—è Repository –¥–ª—è AsyncStorage - —ç—Ç–æ —É–ª—É—á—à–∏—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –±–µ–∑ –±–æ–ª—å—à–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π.

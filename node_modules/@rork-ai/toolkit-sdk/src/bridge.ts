import {
  requireOptionalNativeModule,
  type EventSubscription,
} from "expo-modules-core";
import { useEffect, useRef } from "react";

const BridgeModule = requireOptionalNativeModule("Bridge");

export function sendBridgeMessage(
  type:
    | "inspector-element"
    | "merge-inspector-state"
    | "runtime-ready"
    | "runtime-error",
  data?: Record<string, any>,
) {
  if (data) {
    return BridgeModule?.sendMessage({ type, data: JSON.stringify(data) });
  }

  return BridgeModule?.sendMessage({ type });
}

export function addBridgeListener(
  listener: (data: Record<string, any>) => void,
): EventSubscription {
  return BridgeModule?.addListener("onMessage", (data: any) => {
    if (typeof data !== "object") return;
    if (data.data) {
      listener({ ...data, data: JSON.parse(data.data) });
    } else {
      listener(data);
    }
  });
}

export function useBridgeListener(
  listener: (data: Record<string, any>) => void,
) {
  const listenerRef = useRef(listener);
  listenerRef.current = listener;

  useEffect(() => {
    const subscription = addBridgeListener(listenerRef.current);
    return () => subscription.remove();
  }, [listenerRef.current]);
}

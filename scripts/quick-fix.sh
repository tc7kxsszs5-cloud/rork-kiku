#!/bin/bash
# –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –∑–∞–ø—É—Å–∫–æ–º

echo "üîß –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º..."
echo ""

# –¶–≤–µ—Ç–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# 1. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–∞ –ø–æ—Ä—Ç–∞—Ö
echo -e "${YELLOW}1Ô∏è‚É£ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–∞ –ø–æ—Ä—Ç–∞—Ö 8081 –∏ 8082...${NC}"
PID_8081=$(lsof -ti:8081 2>/dev/null)
PID_8082=$(lsof -ti:8082 2>/dev/null)

if [ ! -z "$PID_8081" ]; then
    kill -9 $PID_8081 2>/dev/null && echo -e "${GREEN}   ‚úÖ –ü–æ—Ä—Ç 8081 –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω (PID: $PID_8081)${NC}" || echo -e "${YELLOW}   ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –ø–æ—Ä—Ç 8081${NC}"
else
    echo -e "${GREEN}   ‚úÖ –ü–æ—Ä—Ç 8081 —Å–≤–æ–±–æ–¥–µ–Ω${NC}"
fi

if [ ! -z "$PID_8082" ]; then
    kill -9 $PID_8082 2>/dev/null && echo -e "${GREEN}   ‚úÖ –ü–æ—Ä—Ç 8082 –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω (PID: $PID_8082)${NC}" || echo -e "${YELLOW}   ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –ø–æ—Ä—Ç 8082${NC}"
else
    echo -e "${GREEN}   ‚úÖ –ü–æ—Ä—Ç 8082 —Å–≤–æ–±–æ–¥–µ–Ω${NC}"
fi

# 2. –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞
echo -e "${YELLOW}2Ô∏è‚É£ –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞...${NC}"
rm -rf .expo 2>/dev/null || true
rm -rf node_modules/.cache 2>/dev/null || true
echo -e "${GREEN}   ‚úÖ –ö—ç—à –æ—á–∏—â–µ–Ω${NC}"

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo -e "${YELLOW}3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...${NC}"
if [ ! -d "node_modules" ]; then
    echo -e "${YELLOW}   –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...${NC}"
    bun install
else
    echo -e "${GREEN}   ‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã${NC}"
fi

# 4. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
echo -e "${YELLOW}4Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...${NC}"
bun run test:startup > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo -e "${GREEN}   ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ –ø–æ—Ä—è–¥–∫–µ${NC}"
else
    echo -e "${RED}   ‚ùå –ü—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π${NC}"
    echo -e "${YELLOW}   –ó–∞–ø—É—Å—Ç–∏—Ç–µ: bun run test:startup${NC}"
fi

echo ""
echo -e "${GREEN}‚úÖ –ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –∑–∞–ø—É—Å—Ç–∏—Ç–µ:${NC}"
echo -e "${YELLOW}   bun run start:web${NC}"
echo ""

#!/bin/bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ iOS —Å–∏–º—É–ª—è—Ç–æ—Ä–µ
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: bun run ios:sim [device-name]
#
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:
# 1. –û—á–∏—â–∞–µ—Ç –∑–∞–≤–∏—Å—à–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã launchd_sim (–∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –æ—à–∏–±–∫—É code 60)
# 2. –í—ã–∫–ª—é—á–∞–µ—Ç –≤—Å–µ —Å–∏–º—É–ª—è—Ç–æ—Ä—ã –∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å—ã
# 3. –ü—ã—Ç–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∏–º—É–ª—è—Ç–æ—Ä —á–µ—Ä–µ–∑ simctl boot
# 4. –ï—Å–ª–∏ simctl boot –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–æ—à–∏–±–∫–∞ launchd_sim), –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ–∂–∏–º:
#    - –û—Ç–∫—Ä—ã–≤–∞–µ—Ç Simulator –≤—Ä—É—á–Ω—É—é
#    - –ó–∞–ø—É—Å–∫–∞–µ—Ç Expo –ë–ï–ó --ios —Ñ–ª–∞–≥–∞ (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—à–∏–±–∫–∏)
#    - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç 'i' –≤ –º–µ–Ω—é Expo
# 5. –ï—Å–ª–∏ simctl boot —Ä–∞–±–æ—Ç–∞–µ—Ç, –∑–∞–ø—É—Å–∫–∞–µ—Ç expo start --ios –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

set +e  # –ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –Ω–∞ –æ—à–∏–±–∫–∞—Ö
cd "$(dirname "$0")/.."

DEVICE_NAME="${1:-iPhone 14}"

echo "üçé –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –≤ iOS Simulator"
echo "   –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: $DEVICE_NAME"
echo ""

# 1. –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç—ã
echo "1Ô∏è‚É£  –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç—ã..."
bun run kill-ports 2>&1 >/dev/null || true
echo "   ‚úì –ü–æ—Ä—Ç—ã –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω—ã"
echo ""

# 2. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã Expo
echo "2Ô∏è‚É£  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã..."
pkill -f "expo start" 2>/dev/null || true
pkill -f "rork start" 2>/dev/null || true
sleep 2
echo "   ‚úì –ü—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
echo ""

# 3. –ù–∞—Ö–æ–¥–∏–º ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
echo "3Ô∏è‚É£  –ò—â–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ $DEVICE_NAME..."
DEVICE_ID=$(xcrun simctl list devices available | grep "$DEVICE_NAME" | head -1 | grep -oE '\([A-F0-9-]+\)' | tr -d '()')

if [ -z "$DEVICE_ID" ]; then
    echo "   ‚ö†Ô∏è  –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ '$DEVICE_NAME' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
    echo "   üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:"
    xcrun simctl list devices available | grep "iPhone\|iPad" | head -5
    echo ""
    echo "   üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: bun run ios:sim:auto 'iPhone 15'"
    echo ""
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤–æ–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
    DEVICE_ID=$(xcrun simctl list devices available | grep "iPhone" | head -1 | grep -oE '\([A-F0-9-]+\)' | tr -d '()')
    if [ -z "$DEVICE_ID" ]; then
        echo "   ‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"
        exit 1
    fi
    DEVICE_NAME=$(xcrun simctl list devices available | grep "iPhone" | head -1 | sed 's/.*(\(.*\))/\1/' | awk '{print $1, $2}')
    echo "   ‚úì –ò—Å–ø–æ–ª—å–∑—É–µ–º: $DEVICE_NAME ($DEVICE_ID)"
else
    echo "   ‚úì –ù–∞–π–¥–µ–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: $DEVICE_NAME ($DEVICE_ID)"
fi
echo ""

# 4. –í—ã–∫–ª—é—á–∞–µ–º –≤—Å–µ —Å–∏–º—É–ª—è—Ç–æ—Ä—ã
echo "4Ô∏è‚É£  –í—ã–∫–ª—é—á–∞–µ–º –≤—Å–µ —Å–∏–º—É–ª—è—Ç–æ—Ä—ã..."
xcrun simctl shutdown all 2>/dev/null || true
sleep 2
echo "   ‚úì –°–∏–º—É–ª—è—Ç–æ—Ä—ã –≤—ã–∫–ª—é—á–µ–Ω—ã"
echo ""

# 5. –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã Simulator (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç)
echo "5Ô∏è‚É£  –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã Simulator..."
killall Simulator 2>/dev/null || true
sleep 1
killall com.apple.CoreSimulator.CoreSimulatorService 2>/dev/null || true
sleep 1
echo "   ‚úì –ü—Ä–æ—Ü–µ—Å—Å—ã –∑–∞–∫—Ä—ã—Ç—ã"
echo ""

# 6. –û—á–∏—â–∞–µ–º –∑–∞–≤–∏—Å—à–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã launchd_sim (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ code 60)
echo "6Ô∏è‚É£  –û—á–∏—â–∞–µ–º –∑–∞–≤–∏—Å—à–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã launchd_sim..."
pkill -f launchd_sim 2>/dev/null || true
sleep 3
echo "   ‚úì –ü—Ä–æ—Ü–µ—Å—Å—ã launchd_sim –æ—á–∏—â–µ–Ω—ã"
echo ""

# 7. –ó–∞–≥—Ä—É–∂–∞–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
echo "7Ô∏è‚É£  –ó–∞–≥—Ä—É–∂–∞–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ $DEVICE_NAME..."
xcrun simctl boot "$DEVICE_ID" 2>&1
BOOT_STATUS=$?

if [ $BOOT_STATUS -ne 0 ]; then
    echo "   ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–µ—Ä–µ–∑ simctl boot (–æ—à–∏–±–∫–∞ launchd_sim)"
    echo "   üîÑ –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ–∂–∏–º..."
    echo ""
    
    # –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ–∂–∏–º: –æ—Ç–∫—Ä—ã–≤–∞–µ–º Simulator –≤—Ä—É—á–Ω—É—é, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º simctl boot
    echo "   üì± –û—Ç–∫—Ä—ã–≤–∞–µ–º Simulator –≤—Ä—É—á–Ω—É—é..."
    open -a Simulator 2>/dev/null || {
        echo "   ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å Simulator –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
        echo "   üí° –û—Ç–∫—Ä–æ–π—Ç–µ Simulator –≤—Ä—É—á–Ω—É—é: Xcode ‚Üí Open Developer Tool ‚Üí Simulator"
        echo "   ‚è≥ –ù–∞–∂–º–∏—Ç–µ Enter –∫–æ–≥–¥–∞ —Å–∏–º—É–ª—è—Ç–æ—Ä –±—É–¥–µ—Ç –æ—Ç–∫—Ä—ã—Ç..."
        read -r
    }
    echo "   ‚è≥ –ñ–¥—ë–º 10 —Å–µ–∫—É–Ω–¥, –ø–æ–∫–∞ —Å–∏–º—É–ª—è—Ç–æ—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è..."
    sleep 10
    echo "   ‚úì Simulator –æ—Ç–∫—Ä—ã—Ç"
    echo ""
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
    USE_SAFE_MODE=true
else
    echo "   ‚úì –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —á–µ—Ä–µ–∑ simctl boot"
    sleep 3
    USE_SAFE_MODE=false
fi
echo ""

# 8. –û—Ç–∫—Ä—ã–≤–∞–µ–º Simulator –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –æ—Ç–∫—Ä—ã—Ç)
if [ "$USE_SAFE_MODE" != "true" ]; then
    echo "8Ô∏è‚É£  –û—Ç–∫—Ä—ã–≤–∞–µ–º Simulator –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
    open -a Simulator 2>/dev/null || {
        echo "   ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å Simulator –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
        echo "   üí° –û—Ç–∫—Ä–æ–π—Ç–µ Simulator –≤—Ä—É—á–Ω—É—é: Xcode ‚Üí Open Developer Tool ‚Üí Simulator"
        echo "   ‚è≥ –ù–∞–∂–º–∏—Ç–µ Enter –∫–æ–≥–¥–∞ —Å–∏–º—É–ª—è—Ç–æ—Ä –±—É–¥–µ—Ç –æ—Ç–∫—Ä—ã—Ç..."
        read -r
    }
    echo "   ‚è≥ –ñ–¥—ë–º 8 —Å–µ–∫—É–Ω–¥, –ø–æ–∫–∞ —Å–∏–º—É–ª—è—Ç–æ—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è..."
    sleep 8
    echo "   ‚úì Simulator –≥–æ—Ç–æ–≤"
    echo ""
fi

# 9. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
echo "9Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞..."
DEVICE_STATUS=$(xcrun simctl list devices | grep "$DEVICE_NAME" | grep -i "Booted" || echo "")

if [ -z "$DEVICE_STATUS" ]; then
    echo "   ‚ö†Ô∏è  –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
    echo "   üí° –í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤—Ä—É—á–Ω—É—é –≤ Simulator:"
    echo "      File ‚Üí Open Simulator ‚Üí $DEVICE_NAME"
    echo ""
    echo "   ‚è≥ –ù–∞–∂–º–∏—Ç–µ Enter –∫–æ–≥–¥–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ..."
    read -r
else
    echo "   ‚úÖ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ"
fi
echo ""

# 10. –ó–∞–ø—É—Å–∫–∞–µ–º Expo —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∑–∞–ø—É—Å–∫–æ–º –≤ —Å–∏–º—É–ª—è—Ç–æ—Ä–µ
echo "üîü –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ —Å–∏–º—É–ª—è—Ç–æ—Ä–µ..."
echo "   üì± –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ —Å–∏–º—É–ª—è—Ç–æ—Ä–µ"
echo "   üìå –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: $DEVICE_NAME"
echo ""

# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ–∂–∏–º, –∑–∞–ø—É—Å–∫–∞–µ–º Expo –ë–ï–ó --ios —Ñ–ª–∞–≥–∞
# —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏ simctl boot
if [ "$USE_SAFE_MODE" = "true" ]; then
    echo "   üîí –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ–∂–∏–º: Expo –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –±–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∏–º—É–ª—è—Ç–æ—Ä–∞"
    echo "   ‚¨áÔ∏è  –ö–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è –º–µ–Ω—é Expo ‚Äî –Ω–∞–∂–º–∏—Ç–µ ** i ** –¥–ª—è iOS."
    echo ""
    EXPO_USE_DEV_CLIENT=false bunx expo start --lan
else
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
    DEVICE_STATUS=$(xcrun simctl list devices | grep "$DEVICE_NAME" | grep -i "Booted" || echo "")
    if [ -z "$DEVICE_STATUS" ]; then
        echo "   ‚ö†Ô∏è  –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º..."
        echo "   üí° –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è, –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤—Ä—É—á–Ω—É—é –≤ Simulator"
        echo ""
    fi
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º --ios —Ñ–ª–∞–≥ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –≤ —Å–∏–º—É–ª—è—Ç–æ—Ä–µ
    # Expo –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–µ—Ä–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Å–∏–º—É–ª—è—Ç–æ—Ä (–µ—Å–ª–∏ –æ–Ω –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞–≥—Ä—É–∂–µ–Ω)
    # –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–∏–º—É–ª—è—Ç–æ—Ä–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, Expo –≤—ã–±–µ—Ä–µ—Ç –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π
    EXPO_USE_DEV_CLIENT=false bunx expo start --ios
fi

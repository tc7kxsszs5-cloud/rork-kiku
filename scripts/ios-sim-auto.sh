#!/bin/bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ iOS —Å–∏–º—É–ª—è—Ç–æ—Ä–µ
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: bun run ios:sim:auto [device-name]
#
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:
# 1. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–∏–º—É–ª—è—Ç–æ—Ä
# 2. –î–æ–∂–∏–¥–∞–µ—Ç—Å—è –µ–≥–æ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
# 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ expo start --ios

set +e  # –ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –Ω–∞ –æ—à–∏–±–∫–∞—Ö
cd "$(dirname "$0")/.."

DEVICE_NAME="${1:-iPhone 14}"

echo "üçé –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –≤ iOS Simulator"
echo "   –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: $DEVICE_NAME"
echo ""

# 1. –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç—ã
echo "1Ô∏è‚É£  –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç—ã..."
bun run kill-ports 2>&1 >/dev/null || true
echo "   ‚úì –ü–æ—Ä—Ç—ã –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω—ã"
echo ""

# 2. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã Expo
echo "2Ô∏è‚É£  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã..."
pkill -f "expo start" 2>/dev/null || true
pkill -f "rork start" 2>/dev/null || true
sleep 2
echo "   ‚úì –ü—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
echo ""

# 3. –ù–∞—Ö–æ–¥–∏–º ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
echo "3Ô∏è‚É£  –ò—â–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ $DEVICE_NAME..."
DEVICE_ID=$(xcrun simctl list devices available | grep "$DEVICE_NAME" | head -1 | grep -oE '\([A-F0-9-]+\)' | tr -d '()')

if [ -z "$DEVICE_ID" ]; then
    echo "   ‚ö†Ô∏è  –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ '$DEVICE_NAME' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
    echo "   üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:"
    xcrun simctl list devices available | grep "iPhone\|iPad" | head -5
    echo ""
    echo "   üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: bun run ios:sim:auto 'iPhone 15'"
    echo ""
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤–æ–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
    DEVICE_ID=$(xcrun simctl list devices available | grep "iPhone" | head -1 | grep -oE '\([A-F0-9-]+\)' | tr -d '()')
    if [ -z "$DEVICE_ID" ]; then
        echo "   ‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"
        exit 1
    fi
    DEVICE_NAME=$(xcrun simctl list devices available | grep "iPhone" | head -1 | sed 's/.*(\(.*\))/\1/' | awk '{print $1, $2}')
    echo "   ‚úì –ò—Å–ø–æ–ª—å–∑—É–µ–º: $DEVICE_NAME ($DEVICE_ID)"
else
    echo "   ‚úì –ù–∞–π–¥–µ–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: $DEVICE_NAME ($DEVICE_ID)"
fi
echo ""

# 4. –í—ã–∫–ª—é—á–∞–µ–º –≤—Å–µ —Å–∏–º—É–ª—è—Ç–æ—Ä—ã
echo "4Ô∏è‚É£  –í—ã–∫–ª—é—á–∞–µ–º –≤—Å–µ —Å–∏–º—É–ª—è—Ç–æ—Ä—ã..."
xcrun simctl shutdown all 2>/dev/null || true
sleep 2
echo "   ‚úì –°–∏–º—É–ª—è—Ç–æ—Ä—ã –≤—ã–∫–ª—é—á–µ–Ω—ã"
echo ""

# 5. –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã Simulator (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç)
echo "5Ô∏è‚É£  –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã Simulator..."
killall Simulator 2>/dev/null || true
sleep 2
echo "   ‚úì –ü—Ä–æ—Ü–µ—Å—Å—ã –∑–∞–∫—Ä—ã—Ç—ã"
echo ""

# 6. –ó–∞–≥—Ä—É–∂–∞–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
echo "6Ô∏è‚É£  –ó–∞–≥—Ä—É–∂–∞–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ $DEVICE_NAME..."
xcrun simctl boot "$DEVICE_ID" 2>&1
BOOT_STATUS=$?

if [ $BOOT_STATUS -ne 0 ]; then
    echo "   ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–µ—Ä–µ–∑ simctl boot (–≤–æ–∑–º–æ–∂–Ω–æ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ)"
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
    sleep 2
else
    echo "   ‚úì –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ"
    sleep 3
fi
echo ""

# 7. –û—Ç–∫—Ä—ã–≤–∞–µ–º Simulator –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
echo "7Ô∏è‚É£  –û—Ç–∫—Ä—ã–≤–∞–µ–º Simulator –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
open -a Simulator 2>/dev/null || {
    echo "   ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å Simulator –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
    echo "   üí° –û—Ç–∫—Ä–æ–π—Ç–µ Simulator –≤—Ä—É—á–Ω—É—é: Xcode ‚Üí Open Developer Tool ‚Üí Simulator"
    echo "   ‚è≥ –ù–∞–∂–º–∏—Ç–µ Enter –∫–æ–≥–¥–∞ —Å–∏–º—É–ª—è—Ç–æ—Ä –±—É–¥–µ—Ç –æ—Ç–∫—Ä—ã—Ç..."
    read -r
}
echo "   ‚è≥ –ñ–¥—ë–º 8 —Å–µ–∫—É–Ω–¥, –ø–æ–∫–∞ —Å–∏–º—É–ª—è—Ç–æ—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è..."
sleep 8
echo "   ‚úì Simulator –≥–æ—Ç–æ–≤"
echo ""

# 8. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
echo "8Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞..."
DEVICE_STATUS=$(xcrun simctl list devices | grep "$DEVICE_NAME" | grep -i "Booted" || echo "")

if [ -z "$DEVICE_STATUS" ]; then
    echo "   ‚ö†Ô∏è  –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
    echo "   üí° –í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤—Ä—É—á–Ω—É—é –≤ Simulator:"
    echo "      File ‚Üí Open Simulator ‚Üí $DEVICE_NAME"
    echo ""
    echo "   ‚è≥ –ù–∞–∂–º–∏—Ç–µ Enter –∫–æ–≥–¥–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ..."
    read -r
else
    echo "   ‚úÖ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ"
fi
echo ""

# 9. –ó–∞–ø—É—Å–∫–∞–µ–º Expo —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∑–∞–ø—É—Å–∫–æ–º –≤ —Å–∏–º—É–ª—è—Ç–æ—Ä–µ
echo "9Ô∏è‚É£  –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ —Å–∏–º—É–ª—è—Ç–æ—Ä–µ..."
echo "   üì± –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ —Å–∏–º—É–ª—è—Ç–æ—Ä–µ"
echo ""

# –ò—Å–ø–æ–ª—å–∑—É–µ–º --ios —Ñ–ª–∞–≥ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –≤ —Å–∏–º—É–ª—è—Ç–æ—Ä–µ
EXPO_USE_DEV_CLIENT=false bunx expo start --ios --simulator="$DEVICE_NAME"

#!/bin/bash
# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ "launchd_sim may have crashed / could not bind to session"
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./scripts/fix-simulator.sh

set +e  # –ù–µ –ø–∞–¥–∞—Ç—å –Ω–∞ –æ—à–∏–±–∫–∞—Ö
cd "$(dirname "$0")/.."

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å iOS Simulator..."
echo ""

# 1. –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã —Å–∏–º—É–ª—è—Ç–æ—Ä–∞ (–º—è–≥–∫–æ)
echo "1Ô∏è‚É£  –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã Simulator..."
killall Simulator 2>/dev/null || true
sleep 2
killall com.apple.CoreSimulator.CoreSimulatorService 2>/dev/null || true
sleep 1
echo "   ‚úì –ü—Ä–æ—Ü–µ—Å—Å—ã –∑–∞–∫—Ä—ã—Ç—ã"
echo ""

# 2. –í—ã–∫–ª—é—á–∞–µ–º –≤—Å–µ —Å–∏–º—É–ª—è—Ç–æ—Ä—ã
echo "2Ô∏è‚É£  –í—ã–∫–ª—é—á–∞–µ–º –≤—Å–µ —Å–∏–º—É–ª—è—Ç–æ—Ä—ã..."
xcrun simctl shutdown all 2>/dev/null || true
sleep 2
echo "   ‚úì –°–∏–º—É–ª—è—Ç–æ—Ä—ã –≤—ã–∫–ª—é—á–µ–Ω—ã"
echo ""

# 3. –û—á–∏—â–∞–µ–º –∑–∞–≤–∏—Å—à–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã launchd_sim (–±–µ–∑ -9, –±–æ–ª–µ–µ –º—è–≥–∫–æ)
echo "3Ô∏è‚É£  –û—á–∏—â–∞–µ–º –∑–∞–≤–∏—Å—à–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã launchd_sim..."
pkill -f launchd_sim 2>/dev/null || true
sleep 2
echo "   ‚úì –ü—Ä–æ—Ü–µ—Å—Å—ã –æ—á–∏—â–µ–Ω—ã"
echo ""

# 4. –û—á–∏—â–∞–µ–º –∫–µ—à —Å–∏–º—É–ª—è—Ç–æ—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
# echo "4Ô∏è‚É£  –û—á–∏—â–∞–µ–º –∫–µ—à —Å–∏–º—É–ª—è—Ç–æ—Ä–∞..."
# rm -rf ~/Library/Developer/CoreSimulator/Caches/* 2>/dev/null || true
# echo "   ‚úì –ö–µ—à –æ—á–∏—â–µ–Ω"
# echo ""

# 5. –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–º—É–ª—è—Ç–æ—Ä –≤—Ä—É—á–Ω—É—é
echo "4Ô∏è‚É£  –ó–∞–ø—É—Å–∫–∞–µ–º Simulator –≤—Ä—É—á–Ω—É—é..."
open -a Simulator
echo "   ‚è≥ –ñ–¥—ë–º 15 —Å–µ–∫—É–Ω–¥, –ø–æ–∫–∞ —Å–∏–º—É–ª—è—Ç–æ—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è..."
sleep 15
echo "   ‚úì Simulator –∑–∞–ø—É—â–µ–Ω"
echo ""

# 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "5Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏–º—É–ª—è—Ç–æ—Ä–∞..."
DEVICE_STATUS=$(xcrun simctl list devices | grep Booted | head -1 || echo "")
if [ -z "$DEVICE_STATUS" ]; then
    echo "   ‚ö†Ô∏è  –°–∏–º—É–ª—è—Ç–æ—Ä –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –Ω–æ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç"
    echo "   üí° –í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤—Ä—É—á–Ω—É—é: File ‚Üí Open Simulator ‚Üí iPhone 14"
else
    echo "   ‚úì –°–∏–º—É–ª—è—Ç–æ—Ä —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω: $DEVICE_STATUS"
fi
echo ""

echo "‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "üì± –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–µ–∫—Ç:"
echo "   bun run ios:sim:safe"
echo "   –∏–ª–∏"
echo "   bun run start"
echo "   (–∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ 'i' –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ)"
echo ""

#!/bin/bash
# Bundle Analysis Script
# –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–∞–∑–º–µ—Ä bundle –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

set -e

echo "üì¶ –ê–Ω–∞–ª–∏–∑ bundle —Ä–∞–∑–º–µ—Ä–∞..."
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
if ! command -v bun &> /dev/null; then
  echo "‚ùå Bun –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
  exit 1
fi

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
mkdir -p bundle-analysis

echo "1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
echo ""

# –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üìä –†–∞–∑–º–µ—Ä node_modules:"
du -sh node_modules 2>/dev/null || echo "node_modules –Ω–µ –Ω–∞–π–¥–µ–Ω"

echo ""
echo "üìä –¢–æ–ø-10 —Å–∞–º—ã—Ö –±–æ–ª—å—à–∏—Ö –ø–∞–∫–µ—Ç–æ–≤:"
du -sh node_modules/* 2>/dev/null | sort -hr | head -10 || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å"

echo ""
echo "2Ô∏è‚É£ –ê–Ω–∞–ª–∏–∑ package.json..."
echo ""

# –ü–æ–¥—Å—á–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
DEPENDENCIES=$(cat package.json | grep -c '"' | head -1 || echo "0")
echo "üì¶ –í—Å–µ–≥–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ package.json: –ø—Ä–æ–≤–µ—Ä–∫–∞..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω depcheck)
if command -v depcheck &> /dev/null; then
  echo ""
  echo "3Ô∏è‚É£ –ü–æ–∏—Å–∫ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
  depcheck --ignores="@types/*,eslint-*,@babel/*,jest-*,@testing-library/*" || true
else
  echo "‚ö†Ô∏è  depcheck –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: bun add -d depcheck"
fi

echo ""
echo "4Ô∏è‚É£ –ê–Ω–∞–ª–∏–∑ –∏–º–ø–æ—Ä—Ç–æ–≤..."
echo ""

# –°–æ–∑–¥–∞–µ–º –æ—Ç—á–µ—Ç –æ —Ä–∞–∑–º–µ—Ä–µ —Ñ–∞–π–ª–æ–≤
echo "üìÅ –†–∞–∑–º–µ—Ä –∏—Å—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:"
find app components constants utils -name "*.ts" -o -name "*.tsx" 2>/dev/null | \
  xargs wc -l 2>/dev/null | sort -rn | head -20 || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å"

echo ""
echo "5Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –≤ package.json (–µ—Å–ª–∏ –µ—Å—Ç—å)
if [ -f "package.json" ]; then
  echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
  # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã –≤–µ—Ä—Å–∏–π
  cat package.json | grep -E '"[^"]+":\s*"[^"]+"' | sort | uniq -d || echo "–î—É–±–ª–∏–∫–∞—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
fi

echo ""
echo "‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo ""
echo "üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:"
echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–ø-10 —Å–∞–º—ã—Ö –±–æ–ª—å—à–∏—Ö –ø–∞–∫–µ—Ç–æ–≤"
echo "2. –£–¥–∞–ª–∏—Ç–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
echo "3. –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ code splitting –¥–ª—è –±–æ–ª—å—à–∏—Ö –º–æ–¥—É–ª–µ–π"
echo "4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ tree shaking –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ"

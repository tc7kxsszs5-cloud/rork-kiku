#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –∑–∞–ø—É—Å–∫–æ–º (CocoaPods + Tunnel)

# –ù–µ –∑–∞–≤–µ—Ä—à–∞–µ–º —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
set +e

# –¶–≤–µ—Ç–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –∑–∞–ø—É—Å–∫–æ–º KIKU...${NC}"
echo ""

# 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ CocoaPods
echo -e "${YELLOW}1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ CocoaPods...${NC}"
if ! command -v pod &> /dev/null; then
    echo -e "${YELLOW}   CocoaPods –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
    echo -e "${BLUE}   –ü–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —á–µ—Ä–µ–∑ gem...${NC}"
    
    # –ü–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —á–µ—Ä–µ–∑ gem (–±–µ–∑ sudo, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
    if gem install cocoapods --user-install 2>/dev/null; then
        echo -e "${GREEN}   ‚úÖ CocoaPods —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–µ–∑ gem${NC}"
    elif sudo gem install cocoapods 2>/dev/null; then
        echo -e "${GREEN}   ‚úÖ CocoaPods —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–µ–∑ sudo gem${NC}"
    else
        echo -e "${YELLOW}   ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å CocoaPods –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏${NC}"
        echo -e "${BLUE}   –≠—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è Expo Go —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏${NC}"
        echo -e "${YELLOW}   –î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Ä—É—á–Ω—É—é:${NC}"
        echo -e "      ${BLUE}brew install cocoapods${NC}"
        echo -e "      ${BLUE}–∏–ª–∏: sudo gem install cocoapods${NC}"
    fi
else
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ CocoaPods (–º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–æ —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
    if pod --version >/dev/null 2>&1; then
        echo -e "${GREEN}   ‚úÖ CocoaPods —Ä–∞–±–æ—Ç–∞–µ—Ç: $(pod --version 2>/dev/null || echo '—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')${NC}"
    else
        echo -e "${YELLOW}   ‚ö†Ô∏è  CocoaPods —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–æ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏${NC}"
        echo -e "${BLUE}   –≠—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è Expo Go —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏${NC}"
        echo -e "${YELLOW}   –î–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):${NC}"
        echo -e "      ${BLUE}brew install cocoapods${NC}"
        echo -e "      ${BLUE}–∏–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Ruby 3.0+ —á–µ—Ä–µ–∑ Homebrew${NC}"
    fi
fi

echo ""

# 2. –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
echo -e "${YELLOW}2Ô∏è‚É£ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤...${NC}"
pkill -f "rork start" 2>/dev/null && echo -e "${GREEN}   ‚úÖ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–æ—Ü–µ—Å—Å—ã rork${NC}" || echo -e "${BLUE}   ‚ÑπÔ∏è  –ü—Ä–æ—Ü–µ—Å—Å—ã rork –Ω–µ –Ω–∞–π–¥–µ–Ω—ã${NC}"
pkill -f "expo start" 2>/dev/null && echo -e "${GREEN}   ‚úÖ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–æ—Ü–µ—Å—Å—ã expo${NC}" || echo -e "${BLUE}   ‚ÑπÔ∏è  –ü—Ä–æ—Ü–µ—Å—Å—ã expo –Ω–µ –Ω–∞–π–¥–µ–Ω—ã${NC}"
pkill -f "metro" 2>/dev/null && echo -e "${GREEN}   ‚úÖ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–æ—Ü–µ—Å—Å—ã metro${NC}" || echo -e "${BLUE}   ‚ÑπÔ∏è  –ü—Ä–æ—Ü–µ—Å—Å—ã metro –Ω–µ –Ω–∞–π–¥–µ–Ω—ã${NC}"
sleep 1

# 3. –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–æ—Ä—Ç–æ–≤
echo -e "${YELLOW}3Ô∏è‚É£ –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–æ—Ä—Ç–æ–≤...${NC}"
for port in 8081 8082 3000; do
    PID=$(lsof -ti:$port 2>/dev/null)
    if [ ! -z "$PID" ]; then
        kill -9 $PID 2>/dev/null && echo -e "${GREEN}   ‚úÖ –ü–æ—Ä—Ç $port –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω${NC}" || echo -e "${YELLOW}   ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –ø–æ—Ä—Ç $port${NC}"
    else
        echo -e "${BLUE}   ‚ÑπÔ∏è  –ü–æ—Ä—Ç $port —Å–≤–æ–±–æ–¥–µ–Ω${NC}"
    fi
done

echo ""

# 4. –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞
echo -e "${YELLOW}4Ô∏è‚É£ –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞...${NC}"
rm -rf .expo 2>/dev/null && echo -e "${GREEN}   ‚úÖ –ö—ç—à .expo –æ—á–∏—â–µ–Ω${NC}" || true
rm -rf node_modules/.cache 2>/dev/null && echo -e "${GREEN}   ‚úÖ –ö—ç—à node_modules –æ—á–∏—â–µ–Ω${NC}" || true

echo ""

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo -e "${YELLOW}5Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...${NC}"
if [ ! -d "node_modules" ]; then
    echo -e "${BLUE}   –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...${NC}"
    bun install || {
        echo -e "${YELLOW}   ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏${NC}"
        echo -e "${BLUE}   –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é: bun install${NC}"
    }
    if [ -d "node_modules" ]; then
        echo -e "${GREEN}   ‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã${NC}"
    fi
else
    echo -e "${GREEN}   ‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã${NC}"
fi

echo ""
echo -e "${GREEN}‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!${NC}"
echo ""
echo -e "${BLUE}–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å:${NC}"
echo -e "   ${YELLOW}bun run start${NC}           - —É–º–Ω—ã–π –∑–∞–ø—É—Å–∫ (LAN –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"
echo -e "   ${YELLOW}bun run start:rork:lan${NC}   - –∑–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ —Å LAN"
echo -e "   ${YELLOW}bun run start:simple${NC}     - –ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—É—Å–∫ Expo"
echo ""
echo -e "${YELLOW}‚ö†Ô∏è  –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: Tunnel —Ä–µ–∂–∏–º –Ω–µ—Å—Ç–∞–±–∏–ª–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ LAN –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–π —Ä–∞–±–æ—Ç—ã.${NC}"
echo ""

# –í—Å–µ–≥–¥–∞ –∑–∞–≤–µ—Ä—à–∞–µ–º —É—Å–ø–µ—à–Ω–æ, –¥–∞–∂–µ –µ—Å–ª–∏ –±—ã–ª–∏ –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏
exit 0

{"version":3,"names":["createContextHook","AsyncStorage","Notifications","Constants","Platform","useCallback","useEffect","useMemo","useRef","useState","trpc","useUser","setupNotificationChannels","isUuid","setNotificationHandler","handleNotification","_handleNotification","_asyncToGenerator","shouldShowAlert","shouldPlaySound","shouldSetBadge","shouldShowBanner","shouldShowList","apply","arguments","DEVICE_ID_STORAGE_KEY","PUSH_TOKEN_STORAGE_KEY","createDeviceId","Date","now","Math","random","toString","slice","resolveExpoProjectId","_ref","_ref2","_process$env$EXPO_PUB","_Constants$expoConfig","_easConfig","_Constants$expoConfig2","candidate","_env","EXPO_PUBLIC_PROJECT_ID","expoConfig","extra","eas","projectId","easConfig","undefined","_createContextHook","_syncData$device","_useUser","user","_useState","_useState2","_slicedToArray","deviceId","setDeviceId","_useState3","_useState4","expoPushToken","setExpoPushToken","_useState5","_useState6","permissionStatus","setPermissionStatus","_useState7","_useState8","isRegistering","setIsRegistering","_useState9","_useState10","isRunningDiagnostics","setIsRunningDiagnostics","_useState11","_useState12","lastError","setLastError","_useState13","_useState14","lastDiagnostics","setLastDiagnostics","autoSyncAttemptedRef","isSupported","OS","deviceLabel","_Constants$deviceName","deviceName","registerMutation","notifications","registerDevice","useMutation","onError","error","console","logTestMutation","logDeviceTest","_trpc$notifications$g","getSyncStatus","useQuery","enabled","Boolean","staleTime","retry","refetchOnMount","refetchOnWindowFocus","syncData","data","refetchSyncStatus","refetch","isSyncing","isFetching","syncError","serverRecord","device","ensureDeviceId","stored","getItem","generated","setItem","isMounted","bootstrap","_ref4","storedId","resolvedId","storedToken","permissions","getPermissionsAsync","status","performRegistration","_ref5","requestPermissions","resolvedDeviceId","warn","permissionRequest","requestPermissionsAsync","tokenResponse","getExpoPushTokenAsync","platformValue","_Constants$expoConfig3","mutateAsync","pushToken","platform","appVersion","version","userId","id","mutationError","refetchError","_x","current","catch","refreshStatus","runDiagnostics","Error","tests","push","type","message","timestamp","lastSyncedAt","scheduleNotificationAsync","content","title","body","trigger","results","logError","_serverRecord$testRes","testResults","_createContextHook2","NotificationsProvider","useNotifications"],"sources":["NotificationsContext.tsx"],"sourcesContent":["import createContextHook from '@nkzw/create-context-hook';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nimport * as Notifications from 'expo-notifications';\nimport Constants from 'expo-constants';\nimport { Platform } from 'react-native';\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\nimport { trpc } from '@/lib/trpc';\nimport { NotificationDeviceRecord, NotificationTestResult } from './types';\nimport { useUser } from './UserContext';\nimport { setupNotificationChannels } from '@/utils/soundNotifications';\nimport { isUuid } from '@/utils/validation';\n\nNotifications.setNotificationHandler({\n  handleNotification: async () => ({\n    shouldShowAlert: true,\n    shouldPlaySound: true,\n    shouldSetBadge: false,\n    shouldShowBanner: true,\n    shouldShowList: true,\n  }),\n});\n\nconst DEVICE_ID_STORAGE_KEY = '@kids_device_id';\nconst PUSH_TOKEN_STORAGE_KEY = '@kids_push_token';\n\nconst createDeviceId = () => `device_${Date.now()}_${Math.random().toString(36).slice(2, 10)}`;\n\nconst resolveExpoProjectId = (): string | undefined => {\n  const candidate =\n    process.env.EXPO_PUBLIC_PROJECT_ID ??\n    (Constants.expoConfig as any)?.extra?.eas?.projectId ??\n    (Constants as any)?.easConfig?.projectId ??\n    (Constants.expoConfig as any)?.extra?.projectId;\n\n  return isUuid(candidate) ? candidate : undefined;\n};\n\nexport type PushPermissionState = Notifications.PermissionStatus | 'unavailable' | 'undetermined';\n\nexport interface NotificationsContextValue {\n  deviceId: string | null;\n  permissionStatus: PushPermissionState;\n  expoPushToken: string | null;\n  isRegistering: boolean;\n  isRunningDiagnostics: boolean;\n  lastError: string | null;\n  serverRecord: NotificationDeviceRecord | null;\n  lastDiagnostics: NotificationTestResult[];\n  registerDevice: () => Promise<void>;\n  refreshStatus: () => Promise<void>;\n  runDiagnostics: () => Promise<NotificationTestResult[]>;\n  isSupported: boolean;\n  isSyncing: boolean;\n}\n\nexport const [NotificationsProvider, useNotifications] = createContextHook<NotificationsContextValue>(() => {\n  const { user } = useUser();\n  const [deviceId, setDeviceId] = useState<string | null>(null);\n  const [expoPushToken, setExpoPushToken] = useState<string | null>(null);\n  const [permissionStatus, setPermissionStatus] = useState<PushPermissionState>(() => 'undetermined');\n  const [isRegistering, setIsRegistering] = useState(false);\n  const [isRunningDiagnostics, setIsRunningDiagnostics] = useState(false);\n  const [lastError, setLastError] = useState<string | null>(null);\n  const [lastDiagnostics, setLastDiagnostics] = useState<NotificationTestResult[]>([]);\n  const autoSyncAttemptedRef = useRef(false);\n  const isSupported = Platform.OS !== 'web';\n  const deviceLabel = useMemo(() => Constants.deviceName ?? Platform.OS, []);\n\n  const registerMutation = trpc.notifications.registerDevice.useMutation({\n    onError: (error) => {\n      console.error('[NotificationsContext] Register mutation error (ignored):', error);\n    },\n  });\n  const logTestMutation = trpc.notifications.logDeviceTest.useMutation({\n    onError: (error) => {\n      console.error('[NotificationsContext] Log test mutation error (ignored):', error);\n    },\n  });\n  const {\n    data: syncData,\n    refetch: refetchSyncStatus,\n    isFetching: isSyncing,\n    error: syncError,\n  } = trpc.notifications.getSyncStatus.useQuery(deviceId ? { deviceId } : undefined, {\n    enabled: Boolean(deviceId) && isSupported,\n    staleTime: 15_000,\n    retry: false,\n    refetchOnMount: false,\n    refetchOnWindowFocus: false,\n  });\n\n  useEffect(() => {\n    if (syncError) {\n      console.error('[NotificationsContext] Sync status query error (ignored):', syncError);\n    }\n  }, [syncError]);\n\n  const serverRecord = syncData?.device ?? null;\n\n  const ensureDeviceId = useCallback(async () => {\n    if (deviceId) {\n      return deviceId;\n    }\n    const stored = await AsyncStorage.getItem(DEVICE_ID_STORAGE_KEY);\n    if (stored) {\n      setDeviceId(stored);\n      return stored;\n    }\n    const generated = createDeviceId();\n    await AsyncStorage.setItem(DEVICE_ID_STORAGE_KEY, generated);\n    setDeviceId(generated);\n    return generated;\n  }, [deviceId]);\n\n  useEffect(() => {\n    let isMounted = true;\n    const bootstrap = async () => {\n      try {\n        const storedId = await AsyncStorage.getItem(DEVICE_ID_STORAGE_KEY);\n        let resolvedId = storedId;\n        if (!storedId) {\n          resolvedId = createDeviceId();\n          await AsyncStorage.setItem(DEVICE_ID_STORAGE_KEY, resolvedId);\n        }\n        if (isMounted && resolvedId) {\n          setDeviceId(resolvedId);\n        }\n\n        const storedToken = await AsyncStorage.getItem(PUSH_TOKEN_STORAGE_KEY);\n        if (isMounted && storedToken) {\n          setExpoPushToken(storedToken);\n        }\n\n        if (!isSupported) {\n          setPermissionStatus('unavailable');\n          return;\n        }\n\n        const permissions = await Notifications.getPermissionsAsync();\n        if (isMounted) {\n          setPermissionStatus(permissions.status);\n        }\n      } catch (error) {\n        console.error('[NotificationsContext] Bootstrap error', error);\n        if (isMounted) {\n          setLastError('Не удалось инициализировать уведомления');\n        }\n      }\n    };\n\n    bootstrap();\n\n    return () => {\n      isMounted = false;\n    };\n  }, [isSupported]);\n\n  const performRegistration = useCallback(\n    async (requestPermissions: boolean) => {\n      if (!isSupported) {\n        setPermissionStatus('unavailable');\n        setLastError(null);\n        return;\n      }\n\n      const resolvedDeviceId = await ensureDeviceId();\n      const projectId = resolveExpoProjectId();\n      if (!projectId) {\n        console.warn('[NotificationsContext] Push notifications disabled: missing Expo projectId');\n        setLastError(null);\n        return;\n      }\n\n      setIsRegistering(true);\n      setLastError(null);\n\n      try {\n        let permissions = await Notifications.getPermissionsAsync();\n        let status = permissions.status;\n        if (status !== 'granted' && requestPermissions) {\n          const permissionRequest = await Notifications.requestPermissionsAsync();\n          status = permissionRequest.status;\n        }\n        setPermissionStatus(status);\n        if (status !== 'granted') {\n          setLastError(null);\n          return;\n        }\n\n        // Настройка каналов уведомлений с поддержкой звуков\n        if (Platform.OS === 'android') {\n          await setupNotificationChannels();\n        }\n\n        const tokenResponse = await Notifications.getExpoPushTokenAsync({ projectId });\n        setExpoPushToken(tokenResponse.data);\n        await AsyncStorage.setItem(PUSH_TOKEN_STORAGE_KEY, tokenResponse.data);\n\n        const platformValue: 'ios' | 'android' | 'web' = Platform.OS === 'ios'\n          ? 'ios'\n          : Platform.OS === 'android'\n            ? 'android'\n            : 'web';\n\n        try {\n          await registerMutation.mutateAsync({\n            deviceId: resolvedDeviceId,\n            pushToken: tokenResponse.data,\n            platform: platformValue,\n            appVersion: Constants.expoConfig?.version,\n            userId: user?.id,\n            permissions: status,\n          });\n        } catch (mutationError) {\n          console.error('[NotificationsContext] Register mutation failed (ignored):', mutationError);\n        }\n\n        try {\n          await refetchSyncStatus();\n        } catch (refetchError) {\n          console.error('[NotificationsContext] Refetch sync status failed (ignored):', refetchError);\n        }\n      } catch (error) {\n        console.error('[NotificationsContext] Registration error (ignored)', error);\n        setLastError(null);\n      } finally {\n        setIsRegistering(false);\n      }\n    },\n    [ensureDeviceId, isSupported, refetchSyncStatus, registerMutation, user?.id],\n  );\n\n  useEffect(() => {\n    if (!isSupported || !deviceId || permissionStatus !== 'granted' || autoSyncAttemptedRef.current) {\n      return;\n    }\n\n    if (!resolveExpoProjectId()) {\n      autoSyncAttemptedRef.current = true;\n      console.warn('[NotificationsContext] Auto registration skipped: missing Expo projectId');\n      return;\n    }\n\n    autoSyncAttemptedRef.current = true;\n    performRegistration(false).catch((error) => {\n      console.error('[NotificationsContext] Auto registration failed (ignored)', error);\n    });\n  }, [deviceId, isSupported, permissionStatus, performRegistration]);\n\n  const refreshStatus = useCallback(async () => {\n    if (!deviceId || !isSupported) {\n      return;\n    }\n    try {\n      await refetchSyncStatus();\n    } catch (error) {\n      console.error('[NotificationsContext] Refresh status failed (ignored):', error);\n    }\n  }, [deviceId, isSupported, refetchSyncStatus]);\n\n  const registerDevice = useCallback(async () => {\n    autoSyncAttemptedRef.current = true;\n    await performRegistration(true);\n  }, [performRegistration]);\n\n  const runDiagnostics = useCallback(async () => {\n    if (!deviceId) {\n      throw new Error('Идентификатор устройства не готов');\n    }\n\n    setIsRunningDiagnostics(true);\n    const now = Date.now();\n    const tests: NotificationTestResult[] = [];\n\n    tests.push({\n      id: `perm_${now}`,\n      type: 'permissions',\n      status: permissionStatus === 'granted' ? 'passed' : 'failed',\n      message:\n        permissionStatus === 'granted'\n          ? 'Разрешение на уведомления выдано'\n          : 'Разрешение на уведомления отсутствует',\n      timestamp: now,\n      deviceLabel,\n    });\n\n    tests.push({\n      id: `token_${now + 1}`,\n      type: 'token',\n      status: expoPushToken ? 'passed' : 'failed',\n      message: expoPushToken ? 'Expo push токен получен' : 'Expo push токен отсутствует',\n      timestamp: now + 1,\n      deviceLabel,\n    });\n\n    tests.push({\n      id: `sync_${now + 2}`,\n      type: 'sync',\n      status: serverRecord?.lastSyncedAt ? 'passed' : 'failed',\n      message: serverRecord?.lastSyncedAt ? 'Сервер синхронизирован' : 'Нет данных синхронизации на сервере',\n      timestamp: now + 2,\n      deviceLabel,\n    });\n\n    if (!isSupported) {\n      tests.push({\n        id: `delivery_${now + 3}`,\n        type: 'delivery',\n        status: 'failed',\n        message: 'Веб-платформа не поддерживает локальные уведомления',\n        timestamp: now + 3,\n        deviceLabel,\n      });\n    } else {\n      try {\n        await Notifications.scheduleNotificationAsync({\n          content: {\n            title: 'Тестовое уведомление KIDS',\n            body: 'Проверка доставки уведомлений',\n            data: { type: 'diagnostic' },\n          },\n          trigger: null,\n        });\n        tests.push({\n          id: `delivery_${now + 3}`,\n          type: 'delivery',\n          status: 'passed',\n          message: 'Локальное уведомление успешно запланировано',\n          timestamp: now + 3,\n          deviceLabel,\n        });\n      } catch (error) {\n        console.error('[NotificationsContext] Delivery test failed', error);\n        tests.push({\n          id: `delivery_${now + 3}`,\n          type: 'delivery',\n          status: 'failed',\n          message: 'Не удалось запланировать локальное уведомление',\n          timestamp: now + 3,\n          deviceLabel,\n        });\n      }\n    }\n\n    try {\n      try {\n        await logTestMutation.mutateAsync({\n          deviceId,\n          results: tests,\n        });\n      } catch (logError) {\n        console.error('[NotificationsContext] Log test mutation failed (ignored):', logError);\n      }\n      setLastDiagnostics(tests);\n      try {\n        await refetchSyncStatus();\n      } catch (refetchError) {\n        console.error('[NotificationsContext] Refetch after diagnostics failed (ignored):', refetchError);\n      }\n      return tests;\n    } finally {\n      setIsRunningDiagnostics(false);\n    }\n  }, [deviceId, deviceLabel, expoPushToken, isSupported, logTestMutation, permissionStatus, refetchSyncStatus, serverRecord?.lastSyncedAt]);\n\n  return useMemo(\n    () => ({\n      deviceId,\n      permissionStatus,\n      expoPushToken,\n      isRegistering,\n      isRunningDiagnostics,\n      lastError,\n      serverRecord,\n      lastDiagnostics: serverRecord?.testResults ?? lastDiagnostics,\n      registerDevice,\n      refreshStatus,\n      runDiagnostics,\n      isSupported,\n      isSyncing,\n    }),\n    [\n      deviceId,\n      expoPushToken,\n      isRegistering,\n      isRunningDiagnostics,\n      lastDiagnostics,\n      lastError,\n      permissionStatus,\n      registerDevice,\n      refreshStatus,\n      runDiagnostics,\n      serverRecord,\n      isSupported,\n      isSyncing,\n    ],\n  );\n});\n"],"mappings":"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","ignoreList":[]}
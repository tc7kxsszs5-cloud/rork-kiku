{"version":3,"names":["createContextHook","useState","useCallback","useEffect","useRef","AsyncStorage","checkSubscriptionStatus","checkStatus","PREMIUM_STORAGE_KEY","cov_1ho1g3yqpv","s","FREE_FEATURES","advancedAnalytics","extendedHistory","multipleChildren","prioritySupport","customAlerts","exportData","aiRecommendations","PREMIUM_FEATURES","TRIAL_DURATION_DAYS","DEFAULT_PREMIUM_STATUS","tier","features","_ref","f","_ref3","_ref4","_slicedToArray","premiumStatus","setPremiumStatus","isMountedRef","current","loadPremiumStatus","_ref5","_asyncToGenerator","stored","getItem","b","parsed","JSON","parse","error","console","apply","arguments","savePremiumStatus","_ref6","status","setItem","stringify","_x","now","Date","result","updated","newStatus","startTrial","trialEndDate","subscribe","_ref9","subscriptionId","subscriptionEndDate","subscriptionStartDate","_x2","cancelSubscription","hasFeature","feature","isPremium","isTrial","_ref2","PremiumProvider","usePremium"],"sources":["PremiumContext.tsx"],"sourcesContent":["import createContextHook from '@nkzw/create-context-hook';\nimport { useState, useCallback, useEffect, useRef } from 'react';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nimport { Platform } from 'react-native';\nimport { checkSubscriptionStatus as checkStatus } from '@/utils/premiumStatus';\n\nconst PREMIUM_STORAGE_KEY = '@kiku_premium_status';\n\nexport type PremiumTier = 'free' | 'premium' | 'trial';\n\nexport interface PremiumFeatures {\n  advancedAnalytics: boolean; // Extended history, detailed reports\n  extendedHistory: boolean; // History beyond 30 days\n  multipleChildren: boolean; // More than 3 children\n  prioritySupport: boolean; // Priority customer support\n  customAlerts: boolean; // Custom alert rules\n  exportData: boolean; // Export analytics data\n  aiRecommendations: boolean; // Advanced AI recommendations\n}\n\nexport interface PremiumStatus {\n  tier: PremiumTier;\n  subscriptionId?: string;\n  subscriptionStartDate?: number;\n  subscriptionEndDate?: number;\n  trialEndDate?: number;\n  features: PremiumFeatures;\n}\n\nconst FREE_FEATURES: PremiumFeatures = {\n  advancedAnalytics: false,\n  extendedHistory: false,\n  multipleChildren: false, // Free: up to 3 children\n  prioritySupport: false,\n  customAlerts: false,\n  exportData: false,\n  aiRecommendations: false,\n};\n\nconst PREMIUM_FEATURES: PremiumFeatures = {\n  advancedAnalytics: true,\n  extendedHistory: true,\n  multipleChildren: true, // Premium: unlimited children\n  prioritySupport: true,\n  customAlerts: true,\n  exportData: true,\n  aiRecommendations: true,\n};\n\nconst TRIAL_DURATION_DAYS = 14; // 14-day free trial\n\nexport interface PremiumContextValue {\n  premiumStatus: PremiumStatus;\n  isPremium: boolean;\n  isTrial: boolean;\n  hasFeature: (feature: keyof PremiumFeatures) => boolean;\n  startTrial: () => Promise<void>;\n  subscribe: (subscriptionId: string) => Promise<void>;\n  cancelSubscription: () => Promise<void>;\n  checkSubscriptionStatus: () => Promise<void>;\n}\n\nconst DEFAULT_PREMIUM_STATUS: PremiumStatus = {\n  tier: 'free',\n  features: FREE_FEATURES,\n};\n\nexport const [PremiumProvider, usePremium] = createContextHook<PremiumContextValue>(() => {\n  const [premiumStatus, setPremiumStatus] = useState<PremiumStatus>(DEFAULT_PREMIUM_STATUS);\n  const isMountedRef = useRef(true);\n\n  useEffect(() => {\n    return () => {\n      isMountedRef.current = false;\n    };\n  }, []);\n\n  // Загрузка статуса премиум при инициализации\n  useEffect(() => {\n    const loadPremiumStatus = async () => {\n      try {\n        const stored = await AsyncStorage.getItem(PREMIUM_STORAGE_KEY);\n        if (stored && isMountedRef.current) {\n          const parsed = JSON.parse(stored);\n          setPremiumStatus(parsed);\n          \n          // Проверка истечения trial/subscription\n          await checkSubscriptionStatus();\n        }\n      } catch (error) {\n        console.error('[PremiumContext] Failed to load premium status:', error);\n      }\n    };\n    loadPremiumStatus();\n  }, []);\n\n  // Сохранение статуса премиум\n  const savePremiumStatus = useCallback(async (status: PremiumStatus) => {\n    try {\n      await AsyncStorage.setItem(PREMIUM_STORAGE_KEY, JSON.stringify(status));\n      if (isMountedRef.current) {\n        setPremiumStatus(status);\n      }\n    } catch (error) {\n      console.error('[PremiumContext] Failed to save premium status:', error);\n    }\n  }, []);\n\n  // Проверка статуса подписки (истечение trial/subscription)\n  // Используем чистую функцию для тестируемости\n  const checkSubscriptionStatus = useCallback(async () => {\n    const now = Date.now();\n    const result = checkStatus(premiumStatus, now);\n\n    if (result.updated) {\n      await savePremiumStatus(result.newStatus);\n    }\n  }, [premiumStatus, savePremiumStatus]);\n\n  // Начать trial\n  const startTrial = useCallback(async () => {\n    const trialEndDate = Date.now() + (TRIAL_DURATION_DAYS * 24 * 60 * 60 * 1000);\n    const newStatus: PremiumStatus = {\n      tier: 'trial',\n      trialEndDate,\n      features: PREMIUM_FEATURES,\n    };\n    await savePremiumStatus(newStatus);\n  }, [savePremiumStatus]);\n\n  // Подписаться на premium\n  const subscribe = useCallback(async (subscriptionId: string) => {\n    const now = Date.now();\n    // Предполагаем месячную подписку (можно расширить)\n    const subscriptionEndDate = now + (30 * 24 * 60 * 60 * 1000);\n    const newStatus: PremiumStatus = {\n      tier: 'premium',\n      subscriptionId,\n      subscriptionStartDate: now,\n      subscriptionEndDate,\n      features: PREMIUM_FEATURES,\n    };\n    await savePremiumStatus(newStatus);\n  }, [savePremiumStatus]);\n\n  // Отменить подписку\n  const cancelSubscription = useCallback(async () => {\n    const newStatus: PremiumStatus = {\n      tier: 'free',\n      features: FREE_FEATURES,\n    };\n    await savePremiumStatus(newStatus);\n  }, [savePremiumStatus]);\n\n  // Проверка наличия функции\n  const hasFeature = useCallback((feature: keyof PremiumFeatures): boolean => {\n    return premiumStatus.features[feature] || false;\n  }, [premiumStatus.features]);\n\n  const isPremium = premiumStatus.tier === 'premium';\n  const isTrial = premiumStatus.tier === 'trial';\n\n  return {\n    premiumStatus,\n    isPremium,\n    isTrial,\n    hasFeature,\n    startTrial,\n    subscribe,\n    cancelSubscription,\n    checkSubscriptionStatus,\n  };\n});\n"],"mappings":"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","ignoreList":[]}
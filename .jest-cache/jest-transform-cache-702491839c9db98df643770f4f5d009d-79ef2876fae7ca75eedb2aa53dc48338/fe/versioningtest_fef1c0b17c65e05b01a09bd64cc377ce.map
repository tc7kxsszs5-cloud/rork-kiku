{"version":3,"names":["_versioning","require","_asyncStorage","_interopRequireDefault","jest","doMock","mock","getItem","fn","Promise","resolve","setItem","removeItem","clear","getAllKeys","multiGet","multiSet","multiRemove","Object","assign","default","describe","beforeEach","clearAllMocks","AsyncStorage","mockClear","it","versionInfo","getVersionInfo","expect","toHaveProperty","appVersion","toBe","dataVersion","apiVersion","schemaVersion","data","test","versioned","createVersionedData","version","migratedAt","toBeDefined","needsMigration","result","_asyncToGenerator2","mockResolvedValue","getStoredVersion","toHaveBeenCalledWith","mockRejectedValue","Error","undefined","saveStoredVersion","originalError","console","error","errorSpy","errorThrown","toHaveBeenCalled"],"sources":["versioning.test.ts"],"sourcesContent":["/**\n * Тесты для системы версионирования\n * AsyncStorage мокается в jest.setup.js (default + named exports).\n * Для динамического импорта используем дополнительный мок.\n */\n\nimport {\n  getVersionInfo,\n  createVersionedData,\n  needsMigration,\n  getStoredVersion,\n  saveStoredVersion,\n} from '@/utils/versioning';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\n\n// Мокаем модуль для динамического импорта (дополнительно к jest.setup.js)\n// Это нужно, так как динамический импорт может не использовать глобальный мок\njest.doMock('@react-native-async-storage/async-storage', () => {\n  const mock = {\n    getItem: jest.fn(() => Promise.resolve(null)),\n    setItem: jest.fn(() => Promise.resolve()),\n    removeItem: jest.fn(() => Promise.resolve()),\n    clear: jest.fn(() => Promise.resolve()),\n    getAllKeys: jest.fn(() => Promise.resolve([])),\n    multiGet: jest.fn(() => Promise.resolve([])),\n    multiSet: jest.fn(() => Promise.resolve()),\n    multiRemove: jest.fn(() => Promise.resolve()),\n  };\n  return { ...mock, default: mock };\n});\n\ndescribe('versioning', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n    // Сбрасываем моки перед каждым тестом\n    (AsyncStorage.getItem as jest.Mock).mockClear();\n    (AsyncStorage.setItem as jest.Mock).mockClear();\n  });\n\n  describe('getVersionInfo', () => {\n    it('должен вернуть информацию о версиях', () => {\n      const versionInfo = getVersionInfo();\n\n      expect(versionInfo).toHaveProperty('appVersion');\n      expect(versionInfo).toHaveProperty('dataVersion');\n      expect(versionInfo).toHaveProperty('apiVersion');\n      expect(versionInfo).toHaveProperty('schemaVersion');\n      expect(typeof versionInfo.appVersion).toBe('string');\n      expect(typeof versionInfo.dataVersion).toBe('number');\n      expect(typeof versionInfo.apiVersion).toBe('number');\n      expect(typeof versionInfo.schemaVersion).toBe('number');\n    });\n  });\n\n  describe('createVersionedData', () => {\n    it('должен создать версионированные данные', () => {\n      const data = { test: 'data' };\n      const versioned = createVersionedData(data, 2);\n\n      expect(versioned.version).toBe(2);\n      expect(versioned.data).toBe(data);\n      expect(versioned.migratedAt).toBeDefined();\n    });\n\n    it('должен использовать дефолтную версию если не указана', () => {\n      const data = { test: 'data' };\n      const versioned = createVersionedData(data);\n\n      expect(versioned.version).toBeDefined();\n      expect(typeof versioned.version).toBe('number');\n    });\n  });\n\n  describe('needsMigration', () => {\n    it('должен вернуть true если версия меньше целевой', () => {\n      expect(needsMigration(1, 2)).toBe(true);\n      expect(needsMigration(1, 3)).toBe(true);\n    });\n\n    it('должен вернуть false если версия равна целевой', () => {\n      expect(needsMigration(2, 2)).toBe(false);\n    });\n\n    it('должен вернуть false если версия больше целевой', () => {\n      expect(needsMigration(3, 2)).toBe(false);\n    });\n\n    it('должен использовать дефолтную целевую версию', () => {\n      const result = needsMigration(1);\n      expect(typeof result).toBe('boolean');\n    });\n  });\n\n  describe('getStoredVersion', () => {\n    it('должен получить версию из хранилища', async () => {\n      (AsyncStorage.getItem as jest.Mock).mockResolvedValue('2');\n\n      const version = await getStoredVersion('@test_key');\n\n      expect(version).toBe(2);\n      expect(AsyncStorage.getItem).toHaveBeenCalledWith('@test_key_version');\n    });\n\n    it('должен вернуть 1 если версия не найдена', async () => {\n      (AsyncStorage.getItem as jest.Mock).mockResolvedValue(null);\n\n      const version = await getStoredVersion('@test_key');\n\n      expect(version).toBe(1);\n      expect(AsyncStorage.getItem).toHaveBeenCalledWith('@test_key_version');\n    });\n\n    it('должен вернуть 1 при ошибке', async () => {\n      (AsyncStorage.getItem as jest.Mock).mockRejectedValue(new Error('Storage error'));\n\n      const version = await getStoredVersion('@test_key');\n\n      expect(version).toBe(1);\n    });\n  });\n\n  describe('saveStoredVersion', () => {\n    it('должен сохранить версию в хранилище', async () => {\n      (AsyncStorage.setItem as jest.Mock).mockResolvedValue(undefined);\n\n      await saveStoredVersion('@test_key', 2);\n\n      expect(AsyncStorage.setItem).toHaveBeenCalledWith('@test_key_version', '2');\n    });\n\n    it('должен обработать ошибку при сохранении', async () => {\n      // Подавляем вывод ошибки в консоль для этого теста\n      const originalError = console.error;\n      const errorSpy = jest.fn();\n      console.error = errorSpy;\n\n      try {\n        (AsyncStorage.setItem as jest.Mock).mockRejectedValue(new Error('Storage error'));\n\n        // Функция не должна выбросить ошибку, должна обработать её внутри\n        let errorThrown = false;\n        try {\n          await saveStoredVersion('@test_key', 2);\n        } catch (error) {\n          errorThrown = true;\n        }\n\n        expect(errorThrown).toBe(false);\n        expect(AsyncStorage.setItem).toHaveBeenCalledWith('@test_key_version', '2');\n        // Проверяем, что ошибка была залогирована\n        expect(errorSpy).toHaveBeenCalled();\n      } finally {\n        // Восстанавливаем console.error\n        console.error = originalError;\n      }\n    });\n  });\n});\n"],"mappings":"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","ignoreList":[]}
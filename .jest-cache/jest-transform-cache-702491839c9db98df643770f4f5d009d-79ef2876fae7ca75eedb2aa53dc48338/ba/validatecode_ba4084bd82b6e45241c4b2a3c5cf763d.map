{"version":3,"names":["z","publicProcedure","supabase","rateLimiters","validateParentCode","_x","_validateParentCode","apply","arguments","_asyncToGenerator","code","_data$parents","cov_1t6by1s0aj","f","s","b","valid","error","test","_ref3","from","select","eq","single","data","expires_at","Date","now","used_count","max_uses","parentId","parent_id","parentName","parents","name","remainingUses","validateParentCodeProcedure","use","general","input","object","string","regex","query","_ref2","_ref","validation","console","Error","message","_x2"],"sources":["validate-code.ts"],"sourcesContent":["import { z } from \"zod\";\nimport { publicProcedure } from \"../../create-context.js\";\nimport { supabase } from \"../../../utils/supabase.js\";\nimport { rateLimiters } from \"../../middleware/rateLimit.js\";\n\n/**\n * Валидация кода родителя\n */\nasync function validateParentCode(code: string): Promise<{ valid: boolean; parentId?: string; parentName?: string; remainingUses?: number; error?: string }> {\n  if (!supabase) {\n    return { valid: false, error: 'Supabase клиент не инициализирован' };\n  }\n\n  // Проверяем формат кода\n  if (!/^KIKU-[A-Z0-9]{6}$/.test(code)) {\n    return { valid: false, error: 'Неверный формат кода' };\n  }\n\n  const { data, error } = await supabase\n    .from('parent_codes')\n    .select('*, parents(name)')\n    .eq('code', code)\n    .eq('is_active', true)\n    .single();\n\n  if (error || !data) {\n    return { valid: false, error: 'Код не найден или недействителен' };\n  }\n\n  // Проверяем срок действия\n  if (data.expires_at && data.expires_at < Date.now()) {\n    return { valid: false, error: 'Срок действия кода истек' };\n  }\n\n  // Проверяем количество использований\n  if (data.used_count >= data.max_uses) {\n    return { valid: false, error: 'Код использован максимальное количество раз' };\n  }\n\n  return {\n    valid: true,\n    parentId: data.parent_id,\n    parentName: (data.parents as any)?.name || 'Родитель',\n    remainingUses: data.max_uses - data.used_count - 1,\n  };\n}\n\nexport const validateParentCodeProcedure = publicProcedure\n  .use(rateLimiters.general)\n  .input(\n    z.object({\n      code: z.string().regex(/^KIKU-[A-Z0-9]{6}$/, 'Неверный формат кода'),\n    })\n  )\n  .query(async ({ input }) => {\n    try {\n      const validation = await validateParentCode(input.code);\n      \n      return {\n        valid: validation.valid,\n        parentName: validation.parentName,\n        remainingUses: validation.remainingUses,\n        error: validation.error,\n      };\n    } catch (error) {\n      console.error('[validateParentCodeProcedure] Error:', error);\n      return {\n        valid: false,\n        error: error instanceof Error ? error.message : 'Ошибка при проверке кода',\n      };\n    }\n  });\n"],"mappings":"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","ignoreList":[]}
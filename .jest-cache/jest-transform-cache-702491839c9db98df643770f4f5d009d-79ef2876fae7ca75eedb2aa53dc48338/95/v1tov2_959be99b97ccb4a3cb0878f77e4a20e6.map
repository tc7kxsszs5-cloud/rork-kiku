{"version":3,"names":["messagesV1ToV2","cov_13nc5r9ige","s","fromVersion","toVersion","name","description","migrate","_migrate","_asyncToGenerator","data","f","b","chats","Array","isArray","map","chat","messages","message","metadata","Object","assign","source","version","migratedAt","Date","now","migratedFrom","_x","apply","arguments","rollback","_rollback","_ref","rest","_objectWithoutProperties","_excluded","keys","length","_ref2","_excluded2","_x2"],"sources":["v1-to-v2.ts"],"sourcesContent":["/**\n * Миграция Messages данных с версии 1 на версию 2\n * \n * Добавляет:\n * - metadata к сообщениям (source, editedAt, reactions)\n * - version к сообщениям\n */\n\nimport { Migration } from '../types';\n\nexport const messagesV1ToV2: Migration = {\n  fromVersion: 1,\n  toVersion: 2,\n  name: 'Add metadata to messages',\n  description: 'Добавляет metadata (source, editedAt, reactions) к сообщениям',\n\n  async migrate(data: any) {\n    // Мигрируем чаты\n    if (data.chats && Array.isArray(data.chats)) {\n      data.chats = data.chats.map((chat: any) => {\n        // Мигрируем сообщения в чате\n        if (chat.messages && Array.isArray(chat.messages)) {\n          chat.messages = chat.messages.map((message: any) => {\n            // Добавляем metadata если его нет\n            if (!message.metadata) {\n              return {\n                ...message,\n                metadata: {\n                  source: 'sms', // Дефолтное значение для старых сообщений\n                },\n                version: 2,\n              };\n            }\n\n            // Если metadata есть, добавляем version\n            return {\n              ...message,\n              version: 2,\n            };\n          });\n        }\n\n        return chat;\n      });\n    }\n\n    // Если данные на верхнем уровне (старая структура)\n    if (data.messages && Array.isArray(data.messages)) {\n      data.messages = data.messages.map((message: any) => {\n        if (!message.metadata) {\n          return {\n            ...message,\n            metadata: {\n              source: 'sms',\n            },\n            version: 2,\n          };\n        }\n        return {\n          ...message,\n          version: 2,\n        };\n      });\n    }\n\n    // Обновляем версию\n    data.version = 2;\n    data.migratedAt = Date.now();\n    data.migratedFrom = 1;\n\n    return data;\n  },\n\n  async rollback(data: any) {\n    // Откат миграции\n    if (data.chats && Array.isArray(data.chats)) {\n      data.chats = data.chats.map((chat: any) => {\n        if (chat.messages && Array.isArray(chat.messages)) {\n          chat.messages = chat.messages.map((message: any) => {\n            const { metadata, version, ...rest } = message;\n            // Удаляем metadata если это дефолтное значение\n            if (metadata && metadata.source === 'sms' && Object.keys(metadata).length === 1) {\n              return rest;\n            }\n            // Иначе оставляем metadata но удаляем version\n            return { ...rest, metadata };\n          });\n        }\n        return chat;\n      });\n    }\n\n    if (data.messages && Array.isArray(data.messages)) {\n      data.messages = data.messages.map((message: any) => {\n        const { metadata, version, ...rest } = message;\n        if (metadata && metadata.source === 'sms' && Object.keys(metadata).length === 1) {\n          return rest;\n        }\n        return { ...rest, metadata };\n      });\n    }\n\n    data.version = 1;\n    return data;\n  },\n};\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}
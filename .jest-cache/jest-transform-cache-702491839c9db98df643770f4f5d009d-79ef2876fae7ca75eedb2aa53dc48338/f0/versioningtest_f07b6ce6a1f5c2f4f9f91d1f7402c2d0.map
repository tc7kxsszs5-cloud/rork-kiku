{"version":3,"names":["_versioning","require","_asyncStorage","_interopRequireDefault","describe","beforeEach","jest","clearAllMocks","it","versionInfo","getVersionInfo","expect","toHaveProperty","appVersion","toBe","dataVersion","apiVersion","schemaVersion","data","test","versioned","createVersionedData","version","migratedAt","toBeDefined","needsMigration","result","_asyncToGenerator2","default","AsyncStorage","getItem","mockResolvedValue","getStoredVersion","toHaveBeenCalledWith","mockRejectedValue","Error","setItem","undefined","saveStoredVersion","originalError","console","error","errorSpy","fn","errorThrown","toHaveBeenCalled"],"sources":["versioning.test.ts"],"sourcesContent":["/**\n * Тесты для системы версионирования\n * AsyncStorage мокается в jest.setup.js (default + named exports).\n */\n\nimport {\n  getVersionInfo,\n  createVersionedData,\n  needsMigration,\n  getStoredVersion,\n  saveStoredVersion,\n} from '@/utils/versioning';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\n\ndescribe('versioning', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n  });\n\n  describe('getVersionInfo', () => {\n    it('должен вернуть информацию о версиях', () => {\n      const versionInfo = getVersionInfo();\n\n      expect(versionInfo).toHaveProperty('appVersion');\n      expect(versionInfo).toHaveProperty('dataVersion');\n      expect(versionInfo).toHaveProperty('apiVersion');\n      expect(versionInfo).toHaveProperty('schemaVersion');\n      expect(typeof versionInfo.appVersion).toBe('string');\n      expect(typeof versionInfo.dataVersion).toBe('number');\n      expect(typeof versionInfo.apiVersion).toBe('number');\n      expect(typeof versionInfo.schemaVersion).toBe('number');\n    });\n  });\n\n  describe('createVersionedData', () => {\n    it('должен создать версионированные данные', () => {\n      const data = { test: 'data' };\n      const versioned = createVersionedData(data, 2);\n\n      expect(versioned.version).toBe(2);\n      expect(versioned.data).toBe(data);\n      expect(versioned.migratedAt).toBeDefined();\n    });\n\n    it('должен использовать дефолтную версию если не указана', () => {\n      const data = { test: 'data' };\n      const versioned = createVersionedData(data);\n\n      expect(versioned.version).toBeDefined();\n      expect(typeof versioned.version).toBe('number');\n    });\n  });\n\n  describe('needsMigration', () => {\n    it('должен вернуть true если версия меньше целевой', () => {\n      expect(needsMigration(1, 2)).toBe(true);\n      expect(needsMigration(1, 3)).toBe(true);\n    });\n\n    it('должен вернуть false если версия равна целевой', () => {\n      expect(needsMigration(2, 2)).toBe(false);\n    });\n\n    it('должен вернуть false если версия больше целевой', () => {\n      expect(needsMigration(3, 2)).toBe(false);\n    });\n\n    it('должен использовать дефолтную целевую версию', () => {\n      const result = needsMigration(1);\n      expect(typeof result).toBe('boolean');\n    });\n  });\n\n  describe('getStoredVersion', () => {\n    it('должен получить версию из хранилища', async () => {\n      (AsyncStorage.getItem as jest.Mock).mockResolvedValue('2');\n\n      const version = await getStoredVersion('@test_key');\n\n      expect(version).toBe(2);\n      expect(AsyncStorage.getItem).toHaveBeenCalledWith('@test_key_version');\n    });\n\n    it('должен вернуть 1 если версия не найдена', async () => {\n      (AsyncStorage.getItem as jest.Mock).mockResolvedValue(null);\n\n      const version = await getStoredVersion('@test_key');\n\n      expect(version).toBe(1);\n    });\n\n    it('должен вернуть 1 при ошибке', async () => {\n      (AsyncStorage.getItem as jest.Mock).mockRejectedValue(new Error('Storage error'));\n\n      const version = await getStoredVersion('@test_key');\n\n      expect(version).toBe(1);\n    });\n  });\n\n  describe('saveStoredVersion', () => {\n    it('должен сохранить версию в хранилище', async () => {\n      (AsyncStorage.setItem as jest.Mock).mockResolvedValue(undefined);\n\n      await saveStoredVersion('@test_key', 2);\n\n      expect(AsyncStorage.setItem).toHaveBeenCalledWith('@test_key_version', '2');\n    });\n\n    it('должен обработать ошибку при сохранении', async () => {\n      // Подавляем вывод ошибки в консоль для этого теста\n      const originalError = console.error;\n      const errorSpy = jest.fn();\n      console.error = errorSpy;\n\n      try {\n        (AsyncStorage.setItem as jest.Mock).mockRejectedValue(new Error('Storage error'));\n\n        // Функция не должна выбросить ошибку, должна обработать её внутри\n        let errorThrown = false;\n        try {\n          await saveStoredVersion('@test_key', 2);\n        } catch (error) {\n          errorThrown = true;\n        }\n\n        expect(errorThrown).toBe(false);\n        expect(AsyncStorage.setItem).toHaveBeenCalled();\n        // Проверяем, что ошибка была залогирована\n        expect(errorSpy).toHaveBeenCalled();\n      } finally {\n        // Восстанавливаем console.error\n        console.error = originalError;\n      }\n    });\n  });\n});\n"],"mappings":"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","ignoreList":[]}
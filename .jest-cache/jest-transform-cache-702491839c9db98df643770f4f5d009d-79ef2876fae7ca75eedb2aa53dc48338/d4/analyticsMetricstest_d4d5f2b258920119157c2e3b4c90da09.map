{"version":3,"names":["_analyticsMetrics","require","describe","it","metrics","calculateMetrics","expect","totalMessages","toBe","totalAlerts","totalSOS","messagesAnalyzed","averageRiskLevel","mostActiveChat","toBeNull","events","event","timestamp","Date","now","eventsByType","properties","riskLevel","riskDistribution","low","medium","chatId","alertsResolved","baseTime","getTime","dailyActivity","length","toBeGreaterThan","day1","find","d","date","riskLevels","map","level","safe","high","critical"],"sources":["analyticsMetrics.test.ts"],"sourcesContent":["/**\n * Модульные тесты для вычисления аналитических метрик\n * Только детерминированные тесты - никаких интеграций/асинхронности\n */\n\nimport { calculateMetrics } from '@/utils/analyticsMetrics';\nimport { AnalyticsEventData } from '@/constants/AnalyticsContext';\n\ndescribe('calculateMetrics', () => {\n  it('должен возвращать дефолтные метрики для пустого массива событий', () => {\n    const metrics = calculateMetrics([]);\n\n    expect(metrics.totalMessages).toBe(0);\n    expect(metrics.totalAlerts).toBe(0);\n    expect(metrics.totalSOS).toBe(0);\n    expect(metrics.messagesAnalyzed).toBe(0);\n    expect(metrics.averageRiskLevel).toBe(0);\n    expect(metrics.mostActiveChat).toBeNull();\n  });\n\n  it('должен правильно подсчитывать общее количество сообщений', () => {\n    const events: AnalyticsEventData[] = [\n      { event: 'message_sent', timestamp: Date.now() },\n      { event: 'message_sent', timestamp: Date.now() },\n      { event: 'message_sent', timestamp: Date.now() },\n    ];\n\n    const metrics = calculateMetrics(events);\n\n    expect(metrics.totalMessages).toBe(3);\n    expect(metrics.eventsByType['message_sent']).toBe(3);\n  });\n\n  it('должен правильно подсчитывать проанализированные сообщения', () => {\n    const events: AnalyticsEventData[] = [\n      {\n        event: 'message_analyzed',\n        timestamp: Date.now(),\n        properties: { riskLevel: 'low' },\n      },\n      {\n        event: 'message_analyzed',\n        timestamp: Date.now(),\n        properties: { riskLevel: 'medium' },\n      },\n    ];\n\n    const metrics = calculateMetrics(events);\n\n    expect(metrics.messagesAnalyzed).toBe(2);\n    expect(metrics.riskDistribution.low).toBe(1);\n    expect(metrics.riskDistribution.medium).toBe(1);\n  });\n\n  it('должен правильно вычислять средний уровень риска', () => {\n    const events: AnalyticsEventData[] = [\n      {\n        event: 'message_analyzed',\n        timestamp: Date.now(),\n        properties: { riskLevel: 'safe' }, // 0\n      },\n      {\n        event: 'message_analyzed',\n        timestamp: Date.now(),\n        properties: { riskLevel: 'low' }, // 1\n      },\n      {\n        event: 'message_analyzed',\n        timestamp: Date.now(),\n        properties: { riskLevel: 'medium' }, // 2\n      },\n      {\n        event: 'message_analyzed',\n        timestamp: Date.now(),\n        properties: { riskLevel: 'high' }, // 3\n      },\n    ];\n\n    const metrics = calculateMetrics(events);\n\n    // (0 + 1 + 2 + 3) / 4 = 1.5\n    expect(metrics.averageRiskLevel).toBe(1.5);\n  });\n\n  it('должен правильно определять самый активный чат', () => {\n    const events: AnalyticsEventData[] = [\n      {\n        event: 'message_analyzed',\n        timestamp: Date.now(),\n        properties: { chatId: 'chat1', riskLevel: 'safe' },\n      },\n      {\n        event: 'message_analyzed',\n        timestamp: Date.now(),\n        properties: { chatId: 'chat1', riskLevel: 'safe' },\n      },\n      {\n        event: 'message_analyzed',\n        timestamp: Date.now(),\n        properties: { chatId: 'chat2', riskLevel: 'safe' },\n      },\n    ];\n\n    const metrics = calculateMetrics(events);\n\n    expect(metrics.mostActiveChat).toBe('chat1');\n  });\n\n  it('должен правильно подсчитывать alerts и SOS', () => {\n    const events: AnalyticsEventData[] = [\n      { event: 'alert_created', timestamp: Date.now() },\n      { event: 'alert_created', timestamp: Date.now() },\n      { event: 'alert_resolved', timestamp: Date.now() },\n      { event: 'sos_triggered', timestamp: Date.now() },\n    ];\n\n    const metrics = calculateMetrics(events);\n\n    expect(metrics.totalAlerts).toBe(2);\n    expect(metrics.alertsResolved).toBe(1);\n    expect(metrics.totalSOS).toBe(1);\n  });\n\n  it('должен правильно группировать события по дням', () => {\n    const baseTime = new Date('2024-01-15T10:00:00Z').getTime();\n    const events: AnalyticsEventData[] = [\n      { event: 'message_sent', timestamp: baseTime },\n      { event: 'message_sent', timestamp: baseTime + 3600000 }, // +1 час, тот же день\n      { event: 'message_sent', timestamp: baseTime + 86400000 }, // +1 день\n    ];\n\n    const metrics = calculateMetrics(events);\n\n    expect(metrics.dailyActivity.length).toBeGreaterThan(0);\n    const day1 = metrics.dailyActivity.find((d) => d.date === '2024-01-15');\n    expect(day1?.events).toBe(2);\n  });\n\n  it('должен правильно обрабатывать все уровни риска', () => {\n    const riskLevels: Array<'safe' | 'low' | 'medium' | 'high' | 'critical'> = [\n      'safe',\n      'low',\n      'medium',\n      'high',\n      'critical',\n    ];\n\n    const events: AnalyticsEventData[] = riskLevels.map((level) => ({\n      event: 'message_analyzed',\n      timestamp: Date.now(),\n      properties: { riskLevel: level },\n    }));\n\n    const metrics = calculateMetrics(events);\n\n    expect(metrics.riskDistribution.safe).toBe(1);\n    expect(metrics.riskDistribution.low).toBe(1);\n    expect(metrics.riskDistribution.medium).toBe(1);\n    expect(metrics.riskDistribution.high).toBe(1);\n    expect(metrics.riskDistribution.critical).toBe(1);\n  });\n\n  it('должен возвращать 0 для averageRiskLevel если нет проанализированных сообщений', () => {\n    const events: AnalyticsEventData[] = [\n      { event: 'message_sent', timestamp: Date.now() },\n      { event: 'alert_created', timestamp: Date.now() },\n    ];\n\n    const metrics = calculateMetrics(events);\n\n    expect(metrics.averageRiskLevel).toBe(0);\n    expect(metrics.messagesAnalyzed).toBe(0);\n  });\n});\n"],"mappings":"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","ignoreList":[]}
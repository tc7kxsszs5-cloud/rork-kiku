{"version":3,"names":["LEVEL_ORDER","KEYWORD_RULES","level","pattern","reason","category","IMAGE_RISK_KEYWORDS","evaluateMessageRisk","message","_normalized$match$len","_normalized$match","normalized","text","toLowerCase","matches","filter","rule","test","length","_message$text$match$l","_message$text$match","emphasisScore","Math","min","match","riskLevel","reasons","confidence","categories","highest","reduce","current","indexOf","Array","from","Set","map","numericPatterns","confidenceBoost","evaluateImageRisk","imageUri","hit","find","keyword","includes","blocked"],"sources":["riskEvaluation.ts"],"sourcesContent":["/**\n * Утилиты для оценки риска сообщений и изображений\n * \n * Чистые детерминированные функции для анализа безопасности контента.\n * Используются в MonitoringContext для оценки рисков в реальном времени.\n */\n\nimport { Message, RiskAnalysis, RiskLevel } from '@/constants/types';\n\nconst LEVEL_ORDER: RiskLevel[] = ['safe', 'low', 'medium', 'high', 'critical'];\n\ntype KeywordRule = {\n  level: RiskLevel;\n  pattern: RegExp;\n  reason: string;\n  category: string;\n};\n\nconst KEYWORD_RULES: KeywordRule[] = [\n  {\n    level: 'critical',\n    pattern: /(убью|убей|поконч|самоуб|умереть|взорв|бомб)/i,\n    reason: 'Угроза жизни или суицидальные мотивы',\n    category: 'threats',\n  },\n  {\n    level: 'high',\n    pattern: /(адрес|домашн|парол|паспорт|номер карты|cvv|секретный код)/i,\n    reason: 'Запрос личных данных',\n    category: 'privacy',\n  },\n  {\n    level: 'high',\n    pattern: /(перевед[ие]|деньг|карта|плати|5000|срочно оплат)/i,\n    reason: 'Финансовое давление',\n    category: 'fraud',\n  },\n  {\n    level: 'high',\n    pattern: /(оруж|пистолет|нож|наркот|взрывчат)/i,\n    reason: 'Упоминание оружия или запрещённых веществ',\n    category: 'safety',\n  },\n  {\n    level: 'medium',\n    pattern: /(никому не говори|встреча без взрослых|секретная встреча|ночью|приди один)/i,\n    reason: 'Секретные встречи без взрослых',\n    category: 'grooming',\n  },\n  {\n    level: 'medium',\n    pattern: /(дурак|тупой|ненавижу тебя|жирный|урод|никчем)/i,\n    reason: 'Травля и унижения',\n    category: 'bullying',\n  },\n  {\n    level: 'medium',\n    pattern: /(страшно|мне плохо|я боюсь|меня преследуют|издеваются)/i,\n    reason: 'Запрос помощи или признаки давления',\n    category: 'distress',\n  },\n  {\n    level: 'low',\n    pattern: /(ночью играть|спорим не расскажешь|скинь фотку|отправь фото)/i,\n    reason: 'Подозрительные просьбы',\n    category: 'boundaries',\n  },\n];\n\nconst IMAGE_RISK_KEYWORDS = ['weapon', 'blood', 'nsfw', 'violence', 'gun', 'knife'];\n\n/**\n * Оценивает уровень риска сообщения на основе ключевых слов и паттернов\n * \n * @param message - Сообщение для оценки\n * @returns Анализ риска с уровнем, причинами, уверенностью и категориями\n */\nexport function evaluateMessageRisk(message: Message): RiskAnalysis {\n  const normalized = message.text.toLowerCase();\n  const matches = KEYWORD_RULES.filter((rule) => rule.pattern.test(normalized));\n\n  if (!matches.length) {\n    const emphasisScore = Math.min(0.4, (message.text.match(/!/g)?.length ?? 0) * 0.05);\n    return {\n      riskLevel: 'safe',\n      reasons: [],\n      confidence: 0.2 + emphasisScore,\n      categories: [],\n    };\n  }\n\n  const highest = matches.reduce<RiskLevel>((current, rule) => {\n    return LEVEL_ORDER.indexOf(rule.level) > LEVEL_ORDER.indexOf(current) ? rule.level : current;\n  }, 'safe');\n\n  const reasons = Array.from(new Set(matches.map((match) => match.reason)));\n  const categories = Array.from(new Set(matches.map((match) => match.category)));\n  const numericPatterns = normalized.match(/\\d{4,}/g)?.length ?? 0;\n  const confidenceBoost = matches.length * 0.1 + (/[A-ZА-Я]{4,}/.test(message.text) ? 0.05 : 0) + numericPatterns * 0.04;\n\n  return {\n    riskLevel: highest,\n    reasons,\n    confidence: Math.min(0.99, 0.55 + confidenceBoost),\n    categories,\n  };\n}\n\n/**\n * Оценивает уровень риска изображения на основе ключевых слов в URI\n * \n * @param imageUri - URI изображения для оценки\n * @returns Объект с флагом блокировки и причинами\n */\nexport function evaluateImageRisk(imageUri: string): { blocked: boolean; reasons: string[] } {\n  const normalized = imageUri.toLowerCase();\n  const hit = IMAGE_RISK_KEYWORDS.find((keyword) => normalized.includes(keyword));\n  if (!hit) {\n    return { blocked: false, reasons: [] };\n  }\n\n  return {\n    blocked: true,\n    reasons: [`Изображение отмечено как рискованное по ключевому слову \"${hit}\"`],\n  };\n}\n"],"mappings":"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","ignoreList":[]}
{"version":3,"names":["TRPCError","rateLimitStore","cov_14suw1t0ue","s","Map","rateLimitMiddleware","options","f","_ref","maxRequests","windowMs","_ref$identifier","identifier","b","_ref2","_asyncToGenerator","opts","_opts$ctx$req","_opts$ctx$req2","clientId","ctx","req","headers","get","split","trim","key","now","Date","stored","resetAt","set","count","next","retryAfter","Math","ceil","code","message","cause","size","entries","Array","from","_ref3","_ref4","_slicedToArray","k","v","delete","_x","apply","arguments","rateLimiters","ai","sync","general"],"sources":["rateLimit.ts"],"sourcesContent":["/**\n * Rate limiting middleware for tRPC procedures\n * IMPROVEMENT: Adds rate limiting without changing functionality\n */\n\nimport { TRPCError } from '@trpc/server';\n\n// In-memory rate limit store (in production, use Redis)\nconst rateLimitStore = new Map<string, { count: number; resetAt: number }>();\n\ninterface RateLimitOptions {\n  maxRequests: number;\n  windowMs: number;\n  identifier?: string;\n}\n\n/**\n * Creates rate limiting middleware\n * IMPROVEMENT: Protects against abuse without breaking functionality\n */\nexport const rateLimitMiddleware = (options: RateLimitOptions) => {\n  const { maxRequests, windowMs, identifier = 'default' } = options;\n\n  return async (opts: { ctx: any; next: () => Promise<any> }) => {\n    // Get client identifier (IP address or deviceId)\n    const clientId = opts.ctx.req?.headers?.get('x-forwarded-for')?.split(',')[0]?.trim() ||\n                     opts.ctx.req?.headers?.get('x-real-ip') ||\n                     'unknown';\n\n    const key = `${identifier}:${clientId}`;\n    const now = Date.now();\n    const stored = rateLimitStore.get(key);\n\n    // Check if window expired\n    if (!stored || now > stored.resetAt) {\n      rateLimitStore.set(key, {\n        count: 1,\n        resetAt: now + windowMs,\n      });\n      return opts.next();\n    }\n\n    // Check if limit exceeded\n    if (stored.count >= maxRequests) {\n      const retryAfter = Math.ceil((stored.resetAt - now) / 1000);\n      throw new TRPCError({\n        code: 'TOO_MANY_REQUESTS',\n        message: `Rate limit exceeded. Try again in ${retryAfter} seconds.`,\n        cause: { retryAfter },\n      });\n    }\n\n    // Increment counter\n    stored.count++;\n    rateLimitStore.set(key, stored);\n\n    // Cleanup old entries periodically (every 1000 requests)\n    if (rateLimitStore.size > 1000) {\n      const entries = Array.from(rateLimitStore.entries());\n      for (const [k, v] of entries) {\n        if (now > v.resetAt) {\n          rateLimitStore.delete(k);\n        }\n      }\n    }\n\n    return opts.next();\n  };\n};\n\n/**\n * Pre-configured rate limiters for different use cases\n */\nexport const rateLimiters = {\n  // AI analysis - more restrictive (expensive operations)\n  ai: rateLimitMiddleware({\n    maxRequests: 10,\n    windowMs: 60000, // 1 minute\n    identifier: 'ai',\n  }),\n\n  // Sync operations - moderate limit\n  sync: rateLimitMiddleware({\n    maxRequests: 30,\n    windowMs: 60000, // 1 minute\n    identifier: 'sync',\n  }),\n\n  // General API - more permissive\n  general: rateLimitMiddleware({\n    maxRequests: 100,\n    windowMs: 60000, // 1 minute\n    identifier: 'general',\n  }),\n};\n"],"mappings":"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","ignoreList":[]}
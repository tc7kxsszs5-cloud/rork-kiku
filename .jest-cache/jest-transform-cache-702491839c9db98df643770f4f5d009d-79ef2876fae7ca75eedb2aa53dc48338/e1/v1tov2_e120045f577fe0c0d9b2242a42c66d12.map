{"version":3,"names":["analyticsV1ToV2","exports","cov_tz39z0ppw","s","fromVersion","toVersion","name","description","migrate","_migrate","_asyncToGenerator2","default","data","f","generateDeviceId","Date","now","Math","random","toString","substr","generateSessionId","deviceId","b","events","Array","isArray","currentSessionId","lastSessionEndTime","SESSION_TIMEOUT","map","event","timestamp","migratedEvent","Object","assign","sessionId","metadata","migrated","migratedAt","version","migratedFrom","_x","apply","arguments","rollback","_rollback","_ref","rest","_objectWithoutProperties2","_excluded","_ref2","restMetadata","_excluded2","keys","length","startsWith","_x2"],"sources":["v1-to-v2.ts"],"sourcesContent":["/**\n * Миграция Analytics данных с версии 1 на версию 2\n * \n * Добавляет:\n * - sessionId к событиям\n * - deviceId к событиям\n * - metadata к событиям\n */\n\nimport { Migration } from '../types';\n\nexport const analyticsV1ToV2: Migration = {\n  fromVersion: 1,\n  toVersion: 2,\n  name: 'Add session and device tracking to analytics',\n  description: 'Добавляет sessionId, deviceId и metadata к событиям аналитики',\n\n  async migrate(data: any) {\n    // Генерируем deviceId если его нет\n    const generateDeviceId = () => {\n      return `device_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    };\n\n    // Генерируем sessionId если его нет\n    const generateSessionId = () => {\n      return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    };\n\n    // Получаем или создаём deviceId\n    let deviceId = data.deviceId;\n    if (!deviceId) {\n      deviceId = generateDeviceId();\n      data.deviceId = deviceId;\n    }\n\n    // Мигрируем события\n    if (data.events && Array.isArray(data.events)) {\n      let currentSessionId: string | null = null;\n      let lastSessionEndTime = 0;\n      const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 минут\n\n      data.events = data.events.map((event: any) => {\n        // Определяем sessionId\n        if (event.event === 'session_started') {\n          // Новый сеанс\n          currentSessionId = generateSessionId();\n          lastSessionEndTime = event.timestamp;\n        } else if (event.event === 'session_ended') {\n          // Конец сеанса\n          lastSessionEndTime = event.timestamp;\n          currentSessionId = null;\n        } else if (currentSessionId && event.timestamp - lastSessionEndTime < SESSION_TIMEOUT) {\n          // Событие в текущем сеансе\n          // currentSessionId уже установлен\n        } else if (!currentSessionId && event.timestamp - lastSessionEndTime > SESSION_TIMEOUT) {\n          // Новый сеанс (прошло больше 30 минут)\n          currentSessionId = generateSessionId();\n          lastSessionEndTime = event.timestamp;\n        }\n\n        // Добавляем новые поля\n        const migratedEvent = {\n          ...event,\n          sessionId: event.sessionId || currentSessionId || generateSessionId(),\n          deviceId: event.deviceId || deviceId,\n          metadata: {\n            ...event.metadata,\n            migrated: true,\n            migratedAt: Date.now(),\n          },\n        };\n\n        return migratedEvent;\n      });\n    }\n\n    // Обновляем версию\n    data.version = 2;\n    data.migratedAt = Date.now();\n    data.migratedFrom = 1;\n\n    return data;\n  },\n\n  async rollback(data: any) {\n    // Откат миграции - удаляем новые поля\n    if (data.events && Array.isArray(data.events)) {\n      data.events = data.events.map((event: any) => {\n        const { sessionId, deviceId, metadata, ...rest } = event;\n        // Удаляем metadata.migrated если есть\n        if (metadata && metadata.migrated) {\n          const { migrated, migratedAt, ...restMetadata } = metadata;\n          if (Object.keys(restMetadata).length > 0) {\n            return { ...rest, metadata: restMetadata };\n          }\n        }\n        return rest;\n      });\n    }\n\n    // Удаляем deviceId из корня если был добавлен\n    if (data.deviceId && data.deviceId.startsWith('device_')) {\n      delete data.deviceId;\n    }\n\n    data.version = 1;\n    return data;\n  },\n};\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}
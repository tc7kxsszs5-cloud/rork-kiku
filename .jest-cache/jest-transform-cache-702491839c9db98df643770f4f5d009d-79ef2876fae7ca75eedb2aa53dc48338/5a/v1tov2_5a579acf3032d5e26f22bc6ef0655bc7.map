{"version":3,"names":["analyticsV1ToV2","exports","fromVersion","toVersion","name","description","migrate","_migrate","_asyncToGenerator2","default","data","generateDeviceId","Date","now","Math","random","toString","substr","generateSessionId","deviceId","events","Array","isArray","currentSessionId","lastSessionEndTime","SESSION_TIMEOUT","map","event","timestamp","migratedEvent","Object","assign","sessionId","metadata","migrated","migratedAt","version","migratedFrom","_x","apply","arguments","rollback","_rollback","rest","_objectWithoutProperties2","_excluded","restMetadata","_excluded2","keys","length","startsWith","_x2"],"sources":["v1-to-v2.ts"],"sourcesContent":["/**\n * Миграция Analytics данных с версии 1 на версию 2\n * \n * Добавляет:\n * - sessionId к событиям\n * - deviceId к событиям\n * - metadata к событиям\n */\n\nimport { Migration } from '../types';\n\nexport const analyticsV1ToV2: Migration = {\n  fromVersion: 1,\n  toVersion: 2,\n  name: 'Add session and device tracking to analytics',\n  description: 'Добавляет sessionId, deviceId и metadata к событиям аналитики',\n\n  async migrate(data: any) {\n    // Генерируем deviceId если его нет\n    const generateDeviceId = () => {\n      return `device_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    };\n\n    // Генерируем sessionId если его нет\n    const generateSessionId = () => {\n      return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    };\n\n    // Получаем или создаём deviceId\n    let deviceId = data.deviceId;\n    if (!deviceId) {\n      deviceId = generateDeviceId();\n      data.deviceId = deviceId;\n    }\n\n    // Мигрируем события\n    if (data.events && Array.isArray(data.events)) {\n      let currentSessionId: string | null = null;\n      let lastSessionEndTime = 0;\n      const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 минут\n\n      data.events = data.events.map((event: any) => {\n        // Определяем sessionId\n        if (event.event === 'session_started') {\n          // Новый сеанс\n          currentSessionId = generateSessionId();\n          lastSessionEndTime = event.timestamp;\n        } else if (event.event === 'session_ended') {\n          // Конец сеанса\n          lastSessionEndTime = event.timestamp;\n          currentSessionId = null;\n        } else if (currentSessionId && event.timestamp - lastSessionEndTime < SESSION_TIMEOUT) {\n          // Событие в текущем сеансе\n          // currentSessionId уже установлен\n        } else if (!currentSessionId && event.timestamp - lastSessionEndTime > SESSION_TIMEOUT) {\n          // Новый сеанс (прошло больше 30 минут)\n          currentSessionId = generateSessionId();\n          lastSessionEndTime = event.timestamp;\n        }\n\n        // Добавляем новые поля\n        const migratedEvent = {\n          ...event,\n          sessionId: event.sessionId || currentSessionId || generateSessionId(),\n          deviceId: event.deviceId || deviceId,\n          metadata: {\n            ...event.metadata,\n            migrated: true,\n            migratedAt: Date.now(),\n          },\n        };\n\n        return migratedEvent;\n      });\n    }\n\n    // Обновляем версию\n    data.version = 2;\n    data.migratedAt = Date.now();\n    data.migratedFrom = 1;\n\n    return data;\n  },\n\n  async rollback(data: any) {\n    // Откат миграции - удаляем новые поля\n    if (data.events && Array.isArray(data.events)) {\n      data.events = data.events.map((event: any) => {\n        const { sessionId, deviceId, metadata, ...rest } = event;\n        // Удаляем metadata.migrated если есть\n        if (metadata && metadata.migrated) {\n          const { migrated, migratedAt, ...restMetadata } = metadata;\n          if (Object.keys(restMetadata).length > 0) {\n            return { ...rest, metadata: restMetadata };\n          }\n        }\n        return rest;\n      });\n    }\n\n    // Удаляем deviceId из корня если был добавлен\n    if (data.deviceId && data.deviceId.startsWith('device_')) {\n      delete data.deviceId;\n    }\n\n    data.version = 1;\n    return data;\n  },\n};\n"],"mappings":"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","ignoreList":[]}
{"version":3,"names":["publicProcedure","supabase","dbCheckProcedure","cov_1bnej9gdna","s","query","_asyncToGenerator","f","SUPABASE_URL","process","env","SUPABASE_ANON_KEY","b","success","error","message","missing","supabaseUrl","_ref2","auth","getSession","authData","data","authError","isConnectionError","includes","details","tableExists","tableError","_ref3","from","select","limit","tableCheckError","code","err","Error","method","replace","note","authCheck","tableCheck","parents","errorMessage","errorStack","stack","undefined"],"sources":["db-check.ts"],"sourcesContent":["import { publicProcedure } from \"../../create-context.js\";\nimport { supabase } from \"../../../utils/supabase.js\";\n\n/**\n * Тестовый endpoint для проверки подключения к базе данных через Supabase SDK\n * Доступен через: /api/trpc/test.dbCheck\n */\nexport const dbCheckProcedure = publicProcedure.query(async () => {\n  const SUPABASE_URL = process.env.SUPABASE_URL;\n  const SUPABASE_ANON_KEY = process.env.SUPABASE_ANON_KEY;\n\n  if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {\n    return {\n      success: false,\n      error: \"Supabase переменные не установлены\",\n      message: \"SUPABASE_URL и SUPABASE_ANON_KEY должны быть установлены в Vercel Environment Variables\",\n      missing: {\n        SUPABASE_URL: !SUPABASE_URL,\n        SUPABASE_ANON_KEY: !SUPABASE_ANON_KEY,\n      },\n    };\n  }\n\n  if (!supabase) {\n    return {\n      success: false,\n      error: \"Supabase клиент не инициализирован\",\n      message: \"Не удалось создать Supabase клиент\",\n      supabaseUrl: SUPABASE_URL,\n    };\n  }\n\n  try {\n    // Простая проверка подключения - проверяем что клиент работает\n    // Не делаем запрос к таблице, так как таблицы могут еще не существовать\n    \n    // Проверяем что клиент инициализирован правильно\n    if (!supabase) {\n      return {\n        success: false,\n        error: \"Supabase клиент не инициализирован\",\n        supabaseUrl: SUPABASE_URL,\n      };\n    }\n\n    // Простая проверка - получаем информацию о проекте через auth\n    // Это не требует существования таблиц\n    const { data: authData, error: authError } = await supabase.auth.getSession();\n    \n    // Ошибка auth нормальна если нет сессии - главное что подключение работает\n    // Если ошибка не связана с подключением, значит все работает\n    const isConnectionError = authError && (\n      authError.message.includes('fetch') || \n      authError.message.includes('network') ||\n      authError.message.includes('ENOTFOUND')\n    );\n\n    if (isConnectionError) {\n      return {\n        success: false,\n        error: \"Ошибка подключения к Supabase\",\n        details: authError.message,\n      };\n    }\n\n    // Проверяем существование таблицы parents\n    let tableExists = false;\n    let tableError: string | null = null;\n    \n    try {\n      const { error: tableCheckError } = await supabase\n        .from('parents')\n        .select('id')\n        .limit(1);\n      \n      // Если ошибка связана с отсутствием таблицы\n      if (tableCheckError) {\n        if (tableCheckError.code === '42P01' || tableCheckError.message.includes('does not exist')) {\n          tableExists = false;\n          tableError = 'Таблица parents не существует. Нужно применить SQL схему в Supabase.';\n        } else {\n          tableError = tableCheckError.message;\n        }\n      } else {\n        tableExists = true;\n      }\n    } catch (err) {\n      tableError = err instanceof Error ? err.message : 'Неизвестная ошибка';\n    }\n\n    // Подключение работает!\n    return {\n      success: true,\n      message: \"Подключение к Supabase работает!\",\n      method: \"Supabase SDK\",\n      supabaseUrl: SUPABASE_URL.replace(/\\/$/, ''),\n      note: \"Используется Supabase Client SDK. Готов к работе с базой данных!\",\n      authCheck: authError ? \"Нет активной сессии (нормально для backend)\" : \"Сессия активна\",\n      tableCheck: {\n        parents: tableExists ? 'Существует' : 'Не существует',\n        error: tableError,\n      },\n    };\n  } catch (error) {\n    const errorMessage = error instanceof Error ? error.message : \"Unknown error\";\n    const errorStack = error instanceof Error ? error.stack : undefined;\n\n    return {\n      success: false,\n      error: errorMessage,\n      details: errorStack,\n      supabaseUrl: SUPABASE_URL?.replace(/\\/$/, ''),\n    };\n  }\n});\n"],"mappings":"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","ignoreList":[]}
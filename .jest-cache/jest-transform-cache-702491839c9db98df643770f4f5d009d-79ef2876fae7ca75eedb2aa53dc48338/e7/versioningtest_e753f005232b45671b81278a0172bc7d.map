{"version":3,"names":["_getJestObj","mock","Object","assign","__esModule","default","mockAsyncStorage","_interopRequireDefault","require","_asyncToGenerator2","_versioning","_require","jest","getItem","fn","Promise","resolve","setItem","removeItem","clear","getAllKeys","multiGet","multiSet","multiRemove","describe","beforeEach","clearAllMocks","mockClear","it","versionInfo","getVersionInfo","expect","toHaveProperty","appVersion","toBe","dataVersion","apiVersion","schemaVersion","data","test","versioned","createVersionedData","version","migratedAt","toBeDefined","needsMigration","result","mockResolvedValue","getStoredVersion","toHaveBeenCalledWith","mockRejectedValue","Error","undefined","saveStoredVersion","originalError","console","error","errorSpy","errorThrown","toHaveBeenCalled"],"sources":["versioning.test.ts"],"sourcesContent":["/**\n * Тесты для системы версионирования\n * AsyncStorage мокается в jest.setup.js (default + named exports).\n */\n\nimport {\n  getVersionInfo,\n  createVersionedData,\n  needsMigration,\n  getStoredVersion,\n  saveStoredVersion,\n} from '@/utils/versioning';\n\n// Мокаем модуль для динамического импорта\nconst mockAsyncStorage = {\n  getItem: jest.fn(() => Promise.resolve(null)),\n  setItem: jest.fn(() => Promise.resolve()),\n  removeItem: jest.fn(() => Promise.resolve()),\n  clear: jest.fn(() => Promise.resolve()),\n  getAllKeys: jest.fn(() => Promise.resolve([])),\n  multiGet: jest.fn(() => Promise.resolve([])),\n  multiSet: jest.fn(() => Promise.resolve()),\n  multiRemove: jest.fn(() => Promise.resolve()),\n};\n\n// Мокаем модуль так, чтобы он работал и для статического, и для динамического импорта\njest.mock('@react-native-async-storage/async-storage', () => ({\n  __esModule: true,\n  default: mockAsyncStorage,\n  ...mockAsyncStorage,\n}));\n\ndescribe('versioning', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n    // Сбрасываем моки перед каждым тестом\n    mockAsyncStorage.getItem.mockClear();\n    mockAsyncStorage.setItem.mockClear();\n  });\n\n  describe('getVersionInfo', () => {\n    it('должен вернуть информацию о версиях', () => {\n      const versionInfo = getVersionInfo();\n\n      expect(versionInfo).toHaveProperty('appVersion');\n      expect(versionInfo).toHaveProperty('dataVersion');\n      expect(versionInfo).toHaveProperty('apiVersion');\n      expect(versionInfo).toHaveProperty('schemaVersion');\n      expect(typeof versionInfo.appVersion).toBe('string');\n      expect(typeof versionInfo.dataVersion).toBe('number');\n      expect(typeof versionInfo.apiVersion).toBe('number');\n      expect(typeof versionInfo.schemaVersion).toBe('number');\n    });\n  });\n\n  describe('createVersionedData', () => {\n    it('должен создать версионированные данные', () => {\n      const data = { test: 'data' };\n      const versioned = createVersionedData(data, 2);\n\n      expect(versioned.version).toBe(2);\n      expect(versioned.data).toBe(data);\n      expect(versioned.migratedAt).toBeDefined();\n    });\n\n    it('должен использовать дефолтную версию если не указана', () => {\n      const data = { test: 'data' };\n      const versioned = createVersionedData(data);\n\n      expect(versioned.version).toBeDefined();\n      expect(typeof versioned.version).toBe('number');\n    });\n  });\n\n  describe('needsMigration', () => {\n    it('должен вернуть true если версия меньше целевой', () => {\n      expect(needsMigration(1, 2)).toBe(true);\n      expect(needsMigration(1, 3)).toBe(true);\n    });\n\n    it('должен вернуть false если версия равна целевой', () => {\n      expect(needsMigration(2, 2)).toBe(false);\n    });\n\n    it('должен вернуть false если версия больше целевой', () => {\n      expect(needsMigration(3, 2)).toBe(false);\n    });\n\n    it('должен использовать дефолтную целевую версию', () => {\n      const result = needsMigration(1);\n      expect(typeof result).toBe('boolean');\n    });\n  });\n\n  describe('getStoredVersion', () => {\n    it('должен получить версию из хранилища', async () => {\n      mockAsyncStorage.getItem.mockResolvedValue('2');\n\n      const version = await getStoredVersion('@test_key');\n\n      expect(version).toBe(2);\n      expect(mockAsyncStorage.getItem).toHaveBeenCalledWith('@test_key_version');\n    });\n\n    it('должен вернуть 1 если версия не найдена', async () => {\n      mockAsyncStorage.getItem.mockResolvedValue(null);\n\n      const version = await getStoredVersion('@test_key');\n\n      expect(version).toBe(1);\n      expect(mockAsyncStorage.getItem).toHaveBeenCalledWith('@test_key_version');\n    });\n\n    it('должен вернуть 1 при ошибке', async () => {\n      mockAsyncStorage.getItem.mockRejectedValue(new Error('Storage error'));\n\n      const version = await getStoredVersion('@test_key');\n\n      expect(version).toBe(1);\n    });\n  });\n\n  describe('saveStoredVersion', () => {\n    it('должен сохранить версию в хранилище', async () => {\n      mockAsyncStorage.setItem.mockResolvedValue(undefined);\n\n      await saveStoredVersion('@test_key', 2);\n\n      expect(mockAsyncStorage.setItem).toHaveBeenCalledWith('@test_key_version', '2');\n    });\n\n    it('должен обработать ошибку при сохранении', async () => {\n      // Подавляем вывод ошибки в консоль для этого теста\n      const originalError = console.error;\n      const errorSpy = jest.fn();\n      console.error = errorSpy;\n\n      try {\n        mockAsyncStorage.setItem.mockRejectedValue(new Error('Storage error'));\n\n        // Функция не должна выбросить ошибку, должна обработать её внутри\n        let errorThrown = false;\n        try {\n          await saveStoredVersion('@test_key', 2);\n        } catch (error) {\n          errorThrown = true;\n        }\n\n        expect(errorThrown).toBe(false);\n        expect(mockAsyncStorage.setItem).toHaveBeenCalledWith('@test_key_version', '2');\n        // Проверяем, что ошибка была залогирована\n        expect(errorSpy).toHaveBeenCalled();\n      } finally {\n        // Восстанавливаем console.error\n        console.error = originalError;\n      }\n    });\n  });\n});\n"],"mappings":"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","ignoreList":[]}
{"version":3,"names":["_asyncStorage","_interopRequireDefault","require","MigrationManager","exports","_classCallCheck2","default","migrations","backupEnabled","_createClass2","key","value","register","migration","conflict","find","m","fromVersion","toVersion","console","warn","name","push","sort","a","b","_migrate","_asyncToGenerator2","data","_this","success","currentData","currentVersion","saveBackup","_loop","nextVersion","Error","log","migrate","version","migratedAt","Date","now","migratedFrom","error","String","_x","_x2","_x3","apply","arguments","_rollback","_this2","_loop2","prevVersion","rollback","_x4","_x5","_x6","_saveBackup","backupKey","AsyncStorage","setItem","JSON","stringify","keys","getAllKeys","backupKeys","filter","k","startsWith","length","keysToRemove","slice","multiRemove","_x7","_x8","getMigrations","_toConsumableArray2","setBackupEnabled","enabled"],"sources":["migrationManager.ts"],"sourcesContent":["/**\n * Менеджер миграций данных\n * \n * Управляет миграциями между версиями данных\n */\n\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nimport { Migration, MigrationResult } from './types';\n\nexport class MigrationManager {\n  private migrations: Migration[] = [];\n  private backupEnabled: boolean = true;\n\n  /**\n   * Зарегистрировать миграцию\n   */\n  register(migration: Migration): void {\n    // Проверяем что нет конфликтов\n    const conflict = this.migrations.find(\n      m => m.fromVersion === migration.fromVersion && m.toVersion === migration.toVersion\n    );\n    \n    if (conflict) {\n      console.warn(`[MigrationManager] Migration conflict: ${migration.name} conflicts with ${conflict.name}`);\n    }\n    \n    this.migrations.push(migration);\n    // Сортируем по версиям\n    this.migrations.sort((a, b) => a.fromVersion - b.fromVersion);\n  }\n\n  /**\n   * Выполнить миграцию данных\n   */\n  async migrate(\n    data: any,\n    fromVersion: number,\n    toVersion: number\n  ): Promise<MigrationResult> {\n    if (fromVersion >= toVersion) {\n      return {\n        success: true,\n        data,\n        fromVersion,\n        toVersion,\n      };\n    }\n\n    let currentData = data;\n    let currentVersion = fromVersion;\n\n    try {\n      // Сохраняем резервную копию перед миграцией\n      if (this.backupEnabled) {\n        await this.saveBackup(currentData, currentVersion);\n      }\n\n      // Выполняем миграции пошагово\n      while (currentVersion < toVersion) {\n        const nextVersion = currentVersion + 1;\n        const migration = this.migrations.find(\n          m => m.fromVersion === currentVersion && m.toVersion === nextVersion\n        );\n\n        if (!migration) {\n          throw new Error(\n            `No migration found from version ${currentVersion} to ${nextVersion}`\n          );\n        }\n\n        console.log(`[MigrationManager] Migrating from ${currentVersion} to ${nextVersion}: ${migration.name}`);\n\n        // Выполняем миграцию\n        currentData = await migration.migrate(currentData);\n        currentVersion = migration.toVersion;\n\n        // Обновляем версию в данных\n        if (currentData && typeof currentData === 'object') {\n          currentData.version = currentVersion;\n          currentData.migratedAt = Date.now();\n          currentData.migratedFrom = migration.fromVersion;\n        }\n      }\n\n      return {\n        success: true,\n        data: currentData,\n        fromVersion,\n        toVersion: currentVersion,\n      };\n    } catch (error) {\n      console.error('[MigrationManager] Migration failed:', error);\n      return {\n        success: false,\n        data: currentData,\n        fromVersion,\n        toVersion: currentVersion,\n        error: error instanceof Error ? error : new Error(String(error)),\n      };\n    }\n  }\n\n  /**\n   * Откатить миграцию\n   */\n  async rollback(\n    data: any,\n    fromVersion: number,\n    toVersion: number\n  ): Promise<MigrationResult> {\n    if (fromVersion <= toVersion) {\n      return {\n        success: true,\n        data,\n        fromVersion,\n        toVersion,\n      };\n    }\n\n    let currentData = data;\n    let currentVersion = fromVersion;\n\n    try {\n      // Выполняем откат пошагово\n      while (currentVersion > toVersion) {\n        const prevVersion = currentVersion - 1;\n        const migration = this.migrations.find(\n          m => m.fromVersion === prevVersion && m.toVersion === currentVersion\n        );\n\n        if (!migration || !migration.rollback) {\n          throw new Error(\n            `No rollback found from version ${currentVersion} to ${prevVersion}`\n          );\n        }\n\n        console.log(`[MigrationManager] Rolling back from ${currentVersion} to ${prevVersion}: ${migration.name}`);\n\n        // Выполняем откат\n        currentData = await migration.rollback(currentData);\n        currentVersion = prevVersion;\n      }\n\n      return {\n        success: true,\n        data: currentData,\n        fromVersion,\n        toVersion: currentVersion,\n      };\n    } catch (error) {\n      console.error('[MigrationManager] Rollback failed:', error);\n      return {\n        success: false,\n        data: currentData,\n        fromVersion,\n        toVersion: currentVersion,\n        error: error instanceof Error ? error : new Error(String(error)),\n      };\n    }\n  }\n\n  /**\n   * Сохранить резервную копию\n   */\n  private async saveBackup(data: any, version: number): Promise<void> {\n    try {\n      const backupKey = `@backup_v${version}_${Date.now()}`;\n      await AsyncStorage.setItem(backupKey, JSON.stringify(data));\n      \n      // Ограничиваем количество резервных копий (последние 5)\n      const keys = await AsyncStorage.getAllKeys();\n      const backupKeys = keys.filter(k => k.startsWith('@backup_')).sort();\n      if (backupKeys.length > 5) {\n        const keysToRemove = backupKeys.slice(0, backupKeys.length - 5);\n        await AsyncStorage.multiRemove(keysToRemove);\n      }\n    } catch (error) {\n      console.error('[MigrationManager] Failed to save backup:', error);\n    }\n  }\n\n  /**\n   * Получить список зарегистрированных миграций\n   */\n  getMigrations(): Migration[] {\n    return [...this.migrations];\n  }\n\n  /**\n   * Включить/выключить резервные копии\n   */\n  setBackupEnabled(enabled: boolean): void {\n    this.backupEnabled = enabled;\n  }\n}\n"],"mappings":"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","ignoreList":[]}
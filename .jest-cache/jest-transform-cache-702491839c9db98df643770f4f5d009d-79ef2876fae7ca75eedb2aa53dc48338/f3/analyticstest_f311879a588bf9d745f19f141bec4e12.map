{"version":3,"names":["analyticsV1ToV2","describe","it","_asyncToGenerator","v1Data","version","events","event","timestamp","Date","now","properties","chatId","migrated","migrate","expect","toBe","migratedAt","toBeDefined","migratedFrom","toHaveLength","sessionId","deviceId","metadata","toMatch","existingDeviceId","v2Data","rolledBack","rollback","toBeUndefined","toEqual"],"sources":["analytics.test.ts"],"sourcesContent":["/**\n * Тесты для миграции Analytics v1 → v2\n */\n\nimport { analyticsV1ToV2 } from '@/utils/migrations/analytics/v1-to-v2';\n\ndescribe('analyticsV1ToV2', () => {\n  it('должен мигрировать события с версии 1 на версию 2', async () => {\n    const v1Data = {\n      version: 1,\n      events: [\n        { \n          event: 'message_sent', \n          timestamp: Date.now(),\n          properties: { chatId: 'chat_1' },\n        },\n        { \n          event: 'session_started', \n          timestamp: Date.now() + 1000,\n        },\n      ],\n    };\n\n    const migrated = await analyticsV1ToV2.migrate(v1Data);\n\n    expect(migrated.version).toBe(2);\n    expect(migrated.migratedAt).toBeDefined();\n    expect(migrated.migratedFrom).toBe(1);\n    expect(migrated.events).toHaveLength(2);\n    \n    // Проверяем что добавлены новые поля\n    expect(migrated.events[0].sessionId).toBeDefined();\n    expect(migrated.events[0].deviceId).toBeDefined();\n    expect(migrated.events[0].metadata).toBeDefined();\n    expect(migrated.events[0].metadata.migrated).toBe(true);\n  });\n\n  it('должен сохранить deviceId в корне данных', async () => {\n    const v1Data = {\n      version: 1,\n      events: [\n        { event: 'message_sent', timestamp: Date.now() },\n      ],\n    };\n\n    const migrated = await analyticsV1ToV2.migrate(v1Data);\n\n    expect(migrated.deviceId).toBeDefined();\n    expect(migrated.deviceId).toMatch(/^device_/);\n  });\n\n  it('должен использовать существующий deviceId если есть', async () => {\n    const existingDeviceId = 'device_existing_123';\n    const v1Data = {\n      version: 1,\n      deviceId: existingDeviceId,\n      events: [\n        { event: 'message_sent', timestamp: Date.now() },\n      ],\n    };\n\n    const migrated = await analyticsV1ToV2.migrate(v1Data);\n\n    expect(migrated.deviceId).toBe(existingDeviceId);\n    expect(migrated.events[0].deviceId).toBe(existingDeviceId);\n  });\n\n  it('должен откатывать миграцию', async () => {\n    const v2Data = {\n      version: 2,\n      deviceId: 'device_123',\n      events: [\n        { \n          event: 'message_sent', \n          timestamp: Date.now(),\n          sessionId: 'session_123',\n          deviceId: 'device_123',\n          metadata: {\n            migrated: true,\n            migratedAt: Date.now(),\n          },\n        },\n      ],\n    };\n\n    const rolledBack = await analyticsV1ToV2.rollback!(v2Data);\n\n    expect(rolledBack.version).toBe(1);\n    expect(rolledBack.events[0].sessionId).toBeUndefined();\n    expect(rolledBack.events[0].deviceId).toBeUndefined();\n    expect(rolledBack.events[0].metadata).toBeUndefined();\n  });\n\n  it('должен обработать пустой массив событий', async () => {\n    const v1Data = {\n      version: 1,\n      events: [],\n    };\n\n    const migrated = await analyticsV1ToV2.migrate(v1Data);\n\n    expect(migrated.version).toBe(2);\n    expect(migrated.events).toEqual([]);\n  });\n\n  it('должен обработать данные без событий', async () => {\n    const v1Data = {\n      version: 1,\n    };\n\n    const migrated = await analyticsV1ToV2.migrate(v1Data);\n\n    expect(migrated.version).toBe(2);\n  });\n});\n"],"mappings":"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","ignoreList":[]}
{"version":3,"names":["_getJestObj","mock","logger","error","jest","fn","warn","info","default","expoConfig","extra","openaiApiKey","undefined","aiProvider","openaiApiBaseUrl","_asyncToGenerator","_require","require","getAIConfig","analyzeMessageWithRealAI","global","fetch","describe","beforeEach","clearAllMocks","mockClear","it","config","expect","toBeDefined","provider","toBe","endpoint","Constants","apiKey","originalEnv","process","env","OPENAI_API_KEY","AI_PROVIDER","result","riskLevel","confidence","reasons","toEqual","categories","mockResponse","results","flagged","category_scores","mockResolvedValueOnce","ok","json","_json","apply","arguments","toHaveBeenCalledWith","objectContaining","method","headers","mockRejectedValueOnce","Error","text","result1","result2","hate","violence","_json2","toContain","length","toBeGreaterThan"],"sources":["aiService.test.ts"],"sourcesContent":["/**\n * Тесты для aiService\n * Проверяет конфигурацию, OpenAI интеграцию, кэширование\n */\n\nimport { getAIConfig, analyzeMessageWithRealAI } from '@/utils/aiService';\nimport { RiskLevel } from '@/constants/types';\n\n// Мок для fetch\nglobal.fetch = jest.fn();\n\n// Мок для logger\njest.mock('@/utils/logger', () => ({\n  logger: {\n    error: jest.fn(),\n    warn: jest.fn(),\n    info: jest.fn(),\n  },\n}));\n\n// Мок для expo-constants\njest.mock('expo-constants', () => ({\n  default: {\n    expoConfig: {\n      extra: {\n        openaiApiKey: undefined,\n        aiProvider: 'local',\n        openaiApiBaseUrl: 'https://api.openai.com/v1',\n      },\n    },\n  },\n}));\n\ndescribe('aiService', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n    (global.fetch as jest.Mock).mockClear();\n  });\n\n  describe('getAIConfig', () => {\n    it('должен возвращать конфигурацию по умолчанию', () => {\n      const config = getAIConfig();\n      \n      expect(config).toBeDefined();\n      expect(config.provider).toBe('local');\n      expect(config.endpoint).toBe('https://api.openai.com/v1');\n    });\n\n    it('должен читать конфигурацию из expo-constants', () => {\n      const Constants = require('expo-constants');\n      Constants.default.expoConfig.extra.openaiApiKey = 'test-key';\n      Constants.default.expoConfig.extra.aiProvider = 'openai';\n\n      const config = getAIConfig();\n      \n      expect(config.provider).toBe('openai');\n      expect(config.apiKey).toBe('test-key');\n    });\n\n    it('должен использовать process.env если expo-constants не доступен', () => {\n      const originalEnv = process.env.OPENAI_API_KEY;\n      process.env.OPENAI_API_KEY = 'env-key';\n      process.env.AI_PROVIDER = 'openai';\n\n      const config = getAIConfig();\n      \n      expect(config.apiKey).toBe('env-key');\n      expect(config.provider).toBe('openai');\n\n      process.env.OPENAI_API_KEY = originalEnv;\n      delete process.env.AI_PROVIDER;\n    });\n  });\n\n  describe('analyzeMessageWithRealAI', () => {\n    it('должен возвращать safe анализ при provider=local', async () => {\n      const config = { provider: 'local' as const, apiKey: undefined };\n      const result = await analyzeMessageWithRealAI('test message', config);\n\n      expect(result.riskLevel).toBe('safe');\n      expect(result.confidence).toBe(0.5);\n      expect(result.reasons).toEqual([]);\n      expect(result.categories).toEqual([]);\n    });\n\n    it('должен вызывать OpenAI API при provider=openai и наличии ключа', async () => {\n      const mockResponse = {\n        results: [{\n          flagged: false,\n          categories: {},\n          category_scores: {},\n        }],\n      };\n\n      (global.fetch as jest.Mock).mockResolvedValueOnce({\n        ok: true,\n        json: async () => mockResponse,\n      });\n\n      const config = {\n        provider: 'openai' as const,\n        apiKey: 'test-key',\n        endpoint: 'https://api.openai.com/v1',\n      };\n\n      const result = await analyzeMessageWithRealAI('test message', config);\n\n      expect(global.fetch).toHaveBeenCalledWith(\n        'https://api.openai.com/v1/moderations',\n        expect.objectContaining({\n          method: 'POST',\n          headers: expect.objectContaining({\n            'Authorization': 'Bearer test-key',\n          }),\n        })\n      );\n\n      expect(result.riskLevel).toBe('safe');\n    });\n\n    it('должен обрабатывать ошибки OpenAI API и fallback на local', async () => {\n      (global.fetch as jest.Mock).mockRejectedValueOnce(new Error('API Error'));\n\n      const config = {\n        provider: 'openai' as const,\n        apiKey: 'test-key',\n        endpoint: 'https://api.openai.com/v1',\n      };\n\n      const result = await analyzeMessageWithRealAI('test message', config);\n\n      expect(result.riskLevel).toBe('safe');\n    });\n\n    it('должен кэшировать результаты', async () => {\n      const config = { provider: 'local' as const, apiKey: undefined };\n      const text = 'same message';\n\n      const result1 = await analyzeMessageWithRealAI(text, config);\n      const result2 = await analyzeMessageWithRealAI(text, config);\n\n      // Второй вызов должен использовать кэш\n      expect(result1).toEqual(result2);\n    });\n\n    it('должен обрабатывать flagged сообщения от OpenAI', async () => {\n      const mockResponse = {\n        results: [{\n          flagged: true,\n          categories: {\n            hate: true,\n            violence: false,\n          },\n          category_scores: {\n            hate: 0.8,\n            violence: 0.3,\n          },\n        }],\n      };\n\n      (global.fetch as jest.Mock).mockResolvedValueOnce({\n        ok: true,\n        json: async () => mockResponse,\n      });\n\n      const config = {\n        provider: 'openai' as const,\n        apiKey: 'test-key',\n        endpoint: 'https://api.openai.com/v1',\n      };\n\n      const result = await analyzeMessageWithRealAI('hateful message', config);\n\n      expect(result.riskLevel).toBe('high');\n      expect(result.categories).toContain('hate');\n      expect(result.reasons.length).toBeGreaterThan(0);\n    });\n  });\n});\n"],"mappings":"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","ignoreList":[]}
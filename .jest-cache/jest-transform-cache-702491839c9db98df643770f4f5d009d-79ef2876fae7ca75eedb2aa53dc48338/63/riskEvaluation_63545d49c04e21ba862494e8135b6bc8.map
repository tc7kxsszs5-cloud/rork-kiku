{"version":3,"names":["LEVEL_ORDER","cov_24fon389fx","s","KEYWORD_RULES","level","pattern","reason","category","IMAGE_RISK_KEYWORDS","evaluateMessageRisk","message","_ref2","_normalized$match","f","normalized","text","toLowerCase","matches","filter","rule","test","length","_ref","_message$text$match","b","emphasisScore","Math","min","match","riskLevel","reasons","confidence","categories","highest","reduce","current","indexOf","Array","from","Set","map","numericPatterns","confidenceBoost","evaluateImageRisk","imageUri","hit","find","keyword","includes","blocked"],"sources":["riskEvaluation.ts"],"sourcesContent":["/**\n * Утилиты для оценки риска сообщений и изображений\n * \n * Чистые детерминированные функции для анализа безопасности контента.\n * Используются в MonitoringContext для оценки рисков в реальном времени.\n */\n\nimport { Message, RiskAnalysis, RiskLevel } from '@/constants/types';\n\nconst LEVEL_ORDER: RiskLevel[] = ['safe', 'low', 'medium', 'high', 'critical'];\n\ntype KeywordRule = {\n  level: RiskLevel;\n  pattern: RegExp;\n  reason: string;\n  category: string;\n};\n\nconst KEYWORD_RULES: KeywordRule[] = [\n  {\n    level: 'critical',\n    pattern: /(убью|убей|поконч|самоуб|умереть|взорв|бомб)/i,\n    reason: 'Угроза жизни или суицидальные мотивы',\n    category: 'threats',\n  },\n  {\n    level: 'high',\n    pattern: /(адрес|домашн|парол|паспорт|номер карты|cvv|секретный код)/i,\n    reason: 'Запрос личных данных',\n    category: 'privacy',\n  },\n  {\n    level: 'high',\n    pattern: /(перевед[ие]|деньг|карта|плати|5000|срочно оплат)/i,\n    reason: 'Финансовое давление',\n    category: 'fraud',\n  },\n  {\n    level: 'high',\n    pattern: /(оруж|пистолет|нож|наркот|взрывчат)/i,\n    reason: 'Упоминание оружия или запрещённых веществ',\n    category: 'safety',\n  },\n  {\n    level: 'medium',\n    pattern: /(никому не говори|встреча без взрослых|секретная встреча|ночью|приди один)/i,\n    reason: 'Секретные встречи без взрослых',\n    category: 'grooming',\n  },\n  {\n    level: 'medium',\n    pattern: /(дурак|тупой|ненавижу тебя|жирный|урод|никчем)/i,\n    reason: 'Травля и унижения',\n    category: 'bullying',\n  },\n  {\n    level: 'medium',\n    pattern: /(страшно|мне плохо|я боюсь|меня преследуют|издеваются)/i,\n    reason: 'Запрос помощи или признаки давления',\n    category: 'distress',\n  },\n  {\n    level: 'low',\n    pattern: /(ночью играть|спорим не расскажешь|скинь фотку|отправь фото)/i,\n    reason: 'Подозрительные просьбы',\n    category: 'boundaries',\n  },\n];\n\nconst IMAGE_RISK_KEYWORDS = ['weapon', 'blood', 'nsfw', 'violence', 'gun', 'knife'];\n\n/**\n * Оценивает уровень риска сообщения на основе ключевых слов и паттернов\n * \n * @param message - Сообщение для оценки\n * @returns Анализ риска с уровнем, причинами, уверенностью и категориями\n */\nexport function evaluateMessageRisk(message: Message): RiskAnalysis {\n  const normalized = message.text.toLowerCase();\n  const matches = KEYWORD_RULES.filter((rule) => rule.pattern.test(normalized));\n\n  if (!matches.length) {\n    const emphasisScore = Math.min(0.4, (message.text.match(/!/g)?.length ?? 0) * 0.05);\n    return {\n      riskLevel: 'safe',\n      reasons: [],\n      confidence: 0.2 + emphasisScore,\n      categories: [],\n    };\n  }\n\n  const highest = matches.reduce<RiskLevel>((current, rule) => {\n    return LEVEL_ORDER.indexOf(rule.level) > LEVEL_ORDER.indexOf(current) ? rule.level : current;\n  }, 'safe');\n\n  const reasons = Array.from(new Set(matches.map((match) => match.reason)));\n  const categories = Array.from(new Set(matches.map((match) => match.category)));\n  const numericPatterns = normalized.match(/\\d{4,}/g)?.length ?? 0;\n  const confidenceBoost = matches.length * 0.1 + (/[A-ZА-Я]{4,}/.test(message.text) ? 0.05 : 0) + numericPatterns * 0.04;\n\n  return {\n    riskLevel: highest,\n    reasons,\n    confidence: Math.min(0.99, 0.55 + confidenceBoost),\n    categories,\n  };\n}\n\n/**\n * Оценивает уровень риска изображения на основе ключевых слов в URI\n * \n * @param imageUri - URI изображения для оценки\n * @returns Объект с флагом блокировки и причинами\n */\nexport function evaluateImageRisk(imageUri: string): { blocked: boolean; reasons: string[] } {\n  const normalized = imageUri.toLowerCase();\n  const hit = IMAGE_RISK_KEYWORDS.find((keyword) => normalized.includes(keyword));\n  if (!hit) {\n    return { blocked: false, reasons: [] };\n  }\n\n  return {\n    blocked: true,\n    reasons: [`Изображение отмечено как рискованное по ключевому слову \"${hit}\"`],\n  };\n}\n"],"mappings":"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","ignoreList":[]}
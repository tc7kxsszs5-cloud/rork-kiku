{"version":3,"names":["getVersionInfo","createVersionedData","needsMigration","getStoredVersion","saveStoredVersion","AsyncStorage","describe","beforeEach","jest","clearAllMocks","getItem","mockClear","setItem","it","versionInfo","expect","toHaveProperty","appVersion","toBe","dataVersion","apiVersion","schemaVersion","data","test","versioned","version","migratedAt","toBeDefined","result","_asyncToGenerator","mockResolvedValue","toHaveBeenCalledWith","mockRejectedValue","Error","undefined","originalError","console","error","errorSpy","fn","errorThrown","toHaveBeenCalled"],"sources":["versioning.test.ts"],"sourcesContent":["/**\n * Тесты для системы версионирования\n * AsyncStorage мокается в jest.setup.js (default + named exports).\n * Мок настроен так, чтобы работать и для статического, и для динамического импорта.\n */\n\nimport {\n  getVersionInfo,\n  createVersionedData,\n  needsMigration,\n  getStoredVersion,\n  saveStoredVersion,\n} from '@/utils/versioning';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\n\ndescribe('versioning', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n    // Сбрасываем моки перед каждым тестом\n    (AsyncStorage.getItem as jest.Mock).mockClear();\n    (AsyncStorage.setItem as jest.Mock).mockClear();\n  });\n\n  describe('getVersionInfo', () => {\n    it('должен вернуть информацию о версиях', () => {\n      const versionInfo = getVersionInfo();\n\n      expect(versionInfo).toHaveProperty('appVersion');\n      expect(versionInfo).toHaveProperty('dataVersion');\n      expect(versionInfo).toHaveProperty('apiVersion');\n      expect(versionInfo).toHaveProperty('schemaVersion');\n      expect(typeof versionInfo.appVersion).toBe('string');\n      expect(typeof versionInfo.dataVersion).toBe('number');\n      expect(typeof versionInfo.apiVersion).toBe('number');\n      expect(typeof versionInfo.schemaVersion).toBe('number');\n    });\n  });\n\n  describe('createVersionedData', () => {\n    it('должен создать версионированные данные', () => {\n      const data = { test: 'data' };\n      const versioned = createVersionedData(data, 2);\n\n      expect(versioned.version).toBe(2);\n      expect(versioned.data).toBe(data);\n      expect(versioned.migratedAt).toBeDefined();\n    });\n\n    it('должен использовать дефолтную версию если не указана', () => {\n      const data = { test: 'data' };\n      const versioned = createVersionedData(data);\n\n      expect(versioned.version).toBeDefined();\n      expect(typeof versioned.version).toBe('number');\n    });\n  });\n\n  describe('needsMigration', () => {\n    it('должен вернуть true если версия меньше целевой', () => {\n      expect(needsMigration(1, 2)).toBe(true);\n      expect(needsMigration(1, 3)).toBe(true);\n    });\n\n    it('должен вернуть false если версия равна целевой', () => {\n      expect(needsMigration(2, 2)).toBe(false);\n    });\n\n    it('должен вернуть false если версия больше целевой', () => {\n      expect(needsMigration(3, 2)).toBe(false);\n    });\n\n    it('должен использовать дефолтную целевую версию', () => {\n      const result = needsMigration(1);\n      expect(typeof result).toBe('boolean');\n    });\n  });\n\n  describe('getStoredVersion', () => {\n    it('должен получить версию из хранилища', async () => {\n      (AsyncStorage.getItem as jest.Mock).mockResolvedValue('2');\n\n      const version = await getStoredVersion('@test_key');\n\n      expect(version).toBe(2);\n      expect(AsyncStorage.getItem).toHaveBeenCalledWith('@test_key_version');\n    });\n\n    it('должен вернуть 1 если версия не найдена', async () => {\n      (AsyncStorage.getItem as jest.Mock).mockResolvedValue(null);\n\n      const version = await getStoredVersion('@test_key');\n\n      expect(version).toBe(1);\n      expect(AsyncStorage.getItem).toHaveBeenCalledWith('@test_key_version');\n    });\n\n    it('должен вернуть 1 при ошибке', async () => {\n      (AsyncStorage.getItem as jest.Mock).mockRejectedValue(new Error('Storage error'));\n\n      const version = await getStoredVersion('@test_key');\n\n      expect(version).toBe(1);\n    });\n  });\n\n  describe('saveStoredVersion', () => {\n    it('должен сохранить версию в хранилище', async () => {\n      (AsyncStorage.setItem as jest.Mock).mockResolvedValue(undefined);\n\n      await saveStoredVersion('@test_key', 2);\n\n      expect(AsyncStorage.setItem).toHaveBeenCalledWith('@test_key_version', '2');\n    });\n\n    it('должен обработать ошибку при сохранении', async () => {\n      // Подавляем вывод ошибки в консоль для этого теста\n      const originalError = console.error;\n      const errorSpy = jest.fn();\n      console.error = errorSpy;\n\n      try {\n        (AsyncStorage.setItem as jest.Mock).mockRejectedValue(new Error('Storage error'));\n\n        // Функция не должна выбросить ошибку, должна обработать её внутри\n        let errorThrown = false;\n        try {\n          await saveStoredVersion('@test_key', 2);\n        } catch (error) {\n          errorThrown = true;\n        }\n\n        expect(errorThrown).toBe(false);\n        expect(AsyncStorage.setItem).toHaveBeenCalledWith('@test_key_version', '2');\n        // Проверяем, что ошибка была залогирована\n        expect(errorSpy).toHaveBeenCalled();\n      } finally {\n        // Восстанавливаем console.error\n        console.error = originalError;\n      }\n    });\n  });\n});\n"],"mappings":"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","ignoreList":[]}
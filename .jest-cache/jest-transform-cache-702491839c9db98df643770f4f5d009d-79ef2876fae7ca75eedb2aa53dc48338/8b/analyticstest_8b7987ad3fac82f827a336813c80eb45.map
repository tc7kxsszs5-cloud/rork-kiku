{"version":3,"names":["_v1ToV","require","describe","it","_asyncToGenerator2","default","v1Data","version","events","event","timestamp","Date","now","properties","chatId","migrated","analyticsV1ToV2","migrate","expect","toBe","migratedAt","toBeDefined","migratedFrom","toHaveLength","sessionId","deviceId","metadata","toMatch","existingDeviceId","v2Data","rolledBack","rollback","toBeUndefined","toEqual"],"sources":["analytics.test.ts"],"sourcesContent":["/**\n * Тесты для миграции Analytics v1 → v2\n */\n\nimport { analyticsV1ToV2 } from '@/utils/migrations/analytics/v1-to-v2';\n\ndescribe('analyticsV1ToV2', () => {\n  it('должен мигрировать события с версии 1 на версию 2', async () => {\n    const v1Data = {\n      version: 1,\n      events: [\n        { \n          event: 'message_sent', \n          timestamp: Date.now(),\n          properties: { chatId: 'chat_1' },\n        },\n        { \n          event: 'session_started', \n          timestamp: Date.now() + 1000,\n        },\n      ],\n    };\n\n    const migrated = await analyticsV1ToV2.migrate(v1Data);\n\n    expect(migrated.version).toBe(2);\n    expect(migrated.migratedAt).toBeDefined();\n    expect(migrated.migratedFrom).toBe(1);\n    expect(migrated.events).toHaveLength(2);\n    \n    // Проверяем что добавлены новые поля\n    expect(migrated.events[0].sessionId).toBeDefined();\n    expect(migrated.events[0].deviceId).toBeDefined();\n    expect(migrated.events[0].metadata).toBeDefined();\n    expect(migrated.events[0].metadata.migrated).toBe(true);\n  });\n\n  it('должен сохранить deviceId в корне данных', async () => {\n    const v1Data = {\n      version: 1,\n      events: [\n        { event: 'message_sent', timestamp: Date.now() },\n      ],\n    };\n\n    const migrated = await analyticsV1ToV2.migrate(v1Data);\n\n    expect(migrated.deviceId).toBeDefined();\n    expect(migrated.deviceId).toMatch(/^device_/);\n  });\n\n  it('должен использовать существующий deviceId если есть', async () => {\n    const existingDeviceId = 'device_existing_123';\n    const v1Data = {\n      version: 1,\n      deviceId: existingDeviceId,\n      events: [\n        { event: 'message_sent', timestamp: Date.now() },\n      ],\n    };\n\n    const migrated = await analyticsV1ToV2.migrate(v1Data);\n\n    expect(migrated.deviceId).toBe(existingDeviceId);\n    expect(migrated.events[0].deviceId).toBe(existingDeviceId);\n  });\n\n  it('должен откатывать миграцию', async () => {\n    const v2Data = {\n      version: 2,\n      deviceId: 'device_123',\n      events: [\n        { \n          event: 'message_sent', \n          timestamp: Date.now(),\n          sessionId: 'session_123',\n          deviceId: 'device_123',\n          metadata: {\n            migrated: true,\n            migratedAt: Date.now(),\n          },\n        },\n      ],\n    };\n\n    const rolledBack = await analyticsV1ToV2.rollback!(v2Data);\n\n    expect(rolledBack.version).toBe(1);\n    expect(rolledBack.events[0].sessionId).toBeUndefined();\n    expect(rolledBack.events[0].deviceId).toBeUndefined();\n    expect(rolledBack.events[0].metadata).toBeUndefined();\n  });\n\n  it('должен обработать пустой массив событий', async () => {\n    const v1Data = {\n      version: 1,\n      events: [],\n    };\n\n    const migrated = await analyticsV1ToV2.migrate(v1Data);\n\n    expect(migrated.version).toBe(2);\n    expect(migrated.events).toEqual([]);\n  });\n\n  it('должен обработать данные без событий', async () => {\n    const v1Data = {\n      version: 1,\n    };\n\n    const migrated = await analyticsV1ToV2.migrate(v1Data);\n\n    expect(migrated.version).toBe(2);\n  });\n});\n"],"mappings":"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","ignoreList":[]}
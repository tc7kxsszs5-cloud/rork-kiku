97d7e7354df9e710f6c489336784ce08
import _slicedToArray from "@babel/runtime/helpers/slicedToArray";
import _asyncToGenerator from "@babel/runtime/helpers/asyncToGenerator";
import _toConsumableArray from "@babel/runtime/helpers/toConsumableArray";
import { logger } from './logger';
import Constants from 'expo-constants';
export function getAIConfig() {
  var _Constants$expoConfig, _Constants$expoConfig2, _Constants$expoConfig3;
  var apiKey = ((_Constants$expoConfig = Constants.expoConfig) == null || (_Constants$expoConfig = _Constants$expoConfig.extra) == null ? void 0 : _Constants$expoConfig.openaiApiKey) || process.env.OPENAI_API_KEY || undefined;
  var provider = ((_Constants$expoConfig2 = Constants.expoConfig) == null || (_Constants$expoConfig2 = _Constants$expoConfig2.extra) == null ? void 0 : _Constants$expoConfig2.aiProvider) || process.env.AI_PROVIDER || 'local';
  var endpoint = ((_Constants$expoConfig3 = Constants.expoConfig) == null || (_Constants$expoConfig3 = _Constants$expoConfig3.extra) == null ? void 0 : _Constants$expoConfig3.openaiApiBaseUrl) || process.env.OPENAI_API_BASE_URL || 'https://api.openai.com/v1';
  return {
    provider: provider,
    apiKey: apiKey,
    endpoint: endpoint
  };
}
function mapOpenAICategoriesToRiskCategories(categories) {
  var mapped = [];
  if (categories.hate) mapped.push('hate');
  if (categories['hate/threatening']) mapped.push('hate_threatening');
  if (categories['self-harm']) mapped.push('self_harm');
  if (categories.sexual) mapped.push('sexual');
  if (categories['sexual/minors']) mapped.push('sexual_minors');
  if (categories.violence) mapped.push('violence');
  if (categories['violence/graphic']) mapped.push('violence_graphic');
  return mapped;
}
function mapOpenAIToRiskLevel(flagged, categoryScores) {
  if (!flagged) {
    return 'safe';
  }
  var maxScore = Math.max.apply(Math, _toConsumableArray(Object.values(categoryScores)));
  if (maxScore >= 0.9) return 'critical';
  if (maxScore >= 0.7) return 'high';
  if (maxScore >= 0.5) return 'medium';
  return 'low';
}
function analyzeWithOpenAI(_x, _x2) {
  return _analyzeWithOpenAI.apply(this, arguments);
}
function _analyzeWithOpenAI() {
  _analyzeWithOpenAI = _asyncToGenerator(function* (text, apiKey) {
    var endpoint = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 'https://api.openai.com/v1';
    try {
      var response = yield fetch(`${endpoint}/moderations`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${apiKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          input: text
        })
      });
      if (!response.ok) {
        var errorText = yield response.text();
        throw new Error(`OpenAI API error: ${response.status} - ${errorText}`);
      }
      var data = yield response.json();
      var result = data.results[0];
      if (!result) {
        throw new Error('Invalid response from OpenAI API');
      }
      var riskLevel = mapOpenAIToRiskLevel(result.flagged, result.category_scores);
      var categories = mapOpenAICategoriesToRiskCategories(result.categories);
      var reasons = [];
      if (result.flagged) {
        Object.entries(result.categories).forEach(function (_ref) {
          var _ref2 = _slicedToArray(_ref, 2),
            category = _ref2[0],
            flagged = _ref2[1];
          if (flagged) {
            reasons.push(`Detected: ${category}`);
          }
        });
      }
      var maxScore = Math.max.apply(Math, _toConsumableArray(Object.values(result.category_scores)));
      var confidence = result.flagged ? maxScore : 1 - maxScore;
      return {
        riskLevel: riskLevel,
        confidence: confidence,
        reasons: reasons,
        categories: categories
      };
    } catch (error) {
      logger.error('OpenAI API error', error instanceof Error ? error : new Error(String(error)), {
        context: 'aiService',
        action: 'analyzeWithOpenAI'
      });
      throw error;
    }
  });
  return _analyzeWithOpenAI.apply(this, arguments);
}
var analysisCache = new Map();
var CACHE_TTL = 24 * 60 * 60 * 1000;
function getCacheKey(text) {
  return `ai_analysis_${text.substring(0, 100)}_${text.length}`;
}
function getCachedAnalysis(text) {
  var cacheKey = getCacheKey(text);
  var cached = analysisCache.get(cacheKey);
  if (cached && Date.now() - cached.timestamp < CACHE_TTL) {
    return cached.result;
  }
  if (cached) {
    analysisCache.delete(cacheKey);
  }
  return null;
}
function cacheAnalysis(text, result) {
  var cacheKey = getCacheKey(text);
  analysisCache.set(cacheKey, {
    result: result,
    timestamp: Date.now()
  });
  if (analysisCache.size > 1000) {
    var firstKey = analysisCache.keys().next().value;
    analysisCache.delete(firstKey);
  }
}
export function analyzeMessageWithRealAI(_x3, _x4) {
  return _analyzeMessageWithRealAI.apply(this, arguments);
}
function _analyzeMessageWithRealAI() {
  _analyzeMessageWithRealAI = _asyncToGenerator(function* (text, config) {
    var cached = getCachedAnalysis(text);
    if (cached) {
      logger.info('Using cached AI analysis', {
        context: 'aiService',
        action: 'analyzeMessageWithRealAI'
      });
      return cached;
    }
    if (config.provider === 'openai' && config.apiKey) {
      try {
        var result = yield analyzeWithOpenAI(text, config.apiKey, config.endpoint);
        cacheAnalysis(text, result);
        return result;
      } catch (error) {
        logger.warn('OpenAI API failed, falling back to local analysis', {
          context: 'aiService',
          action: 'analyzeMessageWithRealAI',
          error: error instanceof Error ? error.message : String(error)
        });
      }
    }
    var fallbackResult = {
      riskLevel: 'safe',
      confidence: 0.5,
      reasons: [],
      categories: []
    };
    cacheAnalysis(text, fallbackResult);
    return fallbackResult;
  });
  return _analyzeMessageWithRealAI.apply(this, arguments);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJsb2dnZXIiLCJDb25zdGFudHMiLCJnZXRBSUNvbmZpZyIsIl9Db25zdGFudHMkZXhwb0NvbmZpZyIsIl9Db25zdGFudHMkZXhwb0NvbmZpZzIiLCJfQ29uc3RhbnRzJGV4cG9Db25maWczIiwiYXBpS2V5IiwiZXhwb0NvbmZpZyIsImV4dHJhIiwib3BlbmFpQXBpS2V5IiwicHJvY2VzcyIsImVudiIsIk9QRU5BSV9BUElfS0VZIiwidW5kZWZpbmVkIiwicHJvdmlkZXIiLCJhaVByb3ZpZGVyIiwiQUlfUFJPVklERVIiLCJlbmRwb2ludCIsIm9wZW5haUFwaUJhc2VVcmwiLCJPUEVOQUlfQVBJX0JBU0VfVVJMIiwibWFwT3BlbkFJQ2F0ZWdvcmllc1RvUmlza0NhdGVnb3JpZXMiLCJjYXRlZ29yaWVzIiwibWFwcGVkIiwiaGF0ZSIsInB1c2giLCJzZXh1YWwiLCJ2aW9sZW5jZSIsIm1hcE9wZW5BSVRvUmlza0xldmVsIiwiZmxhZ2dlZCIsImNhdGVnb3J5U2NvcmVzIiwibWF4U2NvcmUiLCJNYXRoIiwibWF4IiwiYXBwbHkiLCJfdG9Db25zdW1hYmxlQXJyYXkiLCJPYmplY3QiLCJ2YWx1ZXMiLCJhbmFseXplV2l0aE9wZW5BSSIsIl94IiwiX3gyIiwiX2FuYWx5emVXaXRoT3BlbkFJIiwiYXJndW1lbnRzIiwiX2FzeW5jVG9HZW5lcmF0b3IiLCJ0ZXh0IiwibGVuZ3RoIiwicmVzcG9uc2UiLCJmZXRjaCIsIm1ldGhvZCIsImhlYWRlcnMiLCJib2R5IiwiSlNPTiIsInN0cmluZ2lmeSIsImlucHV0Iiwib2siLCJlcnJvclRleHQiLCJFcnJvciIsInN0YXR1cyIsImRhdGEiLCJqc29uIiwicmVzdWx0IiwicmVzdWx0cyIsInJpc2tMZXZlbCIsImNhdGVnb3J5X3Njb3JlcyIsInJlYXNvbnMiLCJlbnRyaWVzIiwiZm9yRWFjaCIsIl9yZWYiLCJfcmVmMiIsIl9zbGljZWRUb0FycmF5IiwiY2F0ZWdvcnkiLCJjb25maWRlbmNlIiwiZXJyb3IiLCJTdHJpbmciLCJjb250ZXh0IiwiYWN0aW9uIiwiYW5hbHlzaXNDYWNoZSIsIk1hcCIsIkNBQ0hFX1RUTCIsImdldENhY2hlS2V5Iiwic3Vic3RyaW5nIiwiZ2V0Q2FjaGVkQW5hbHlzaXMiLCJjYWNoZUtleSIsImNhY2hlZCIsImdldCIsIkRhdGUiLCJub3ciLCJ0aW1lc3RhbXAiLCJkZWxldGUiLCJjYWNoZUFuYWx5c2lzIiwic2V0Iiwic2l6ZSIsImZpcnN0S2V5Iiwia2V5cyIsIm5leHQiLCJ2YWx1ZSIsImFuYWx5emVNZXNzYWdlV2l0aFJlYWxBSSIsIl94MyIsIl94NCIsIl9hbmFseXplTWVzc2FnZVdpdGhSZWFsQUkiLCJjb25maWciLCJpbmZvIiwid2FybiIsIm1lc3NhZ2UiLCJmYWxsYmFja1Jlc3VsdCJdLCJzb3VyY2VzIjpbImFpU2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEFJIFNlcnZpY2VcbiAqIFByb3ZpZGVzIEFJIGFuYWx5c2lzIGNhcGFiaWxpdGllcyBmb3IgbWVzc2FnZXMgYW5kIGltYWdlc1xuICovXG5cbmltcG9ydCB7IFJpc2tBbmFseXNpcywgUmlza0xldmVsIH0gZnJvbSAnQC9jb25zdGFudHMvdHlwZXMnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IENvbnN0YW50cyBmcm9tICdleHBvLWNvbnN0YW50cyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQUlDb25maWcge1xuICBwcm92aWRlcjogJ2xvY2FsJyB8ICdvcGVuYWknIHwgJ2FudGhyb3BpYycgfCAnY3VzdG9tJztcbiAgYXBpS2V5Pzogc3RyaW5nO1xuICBlbmRwb2ludD86IHN0cmluZztcbn1cblxuLyoqXG4gKiBHZXQgQUkgY29uZmlndXJhdGlvbiBmcm9tIGVudmlyb25tZW50IG9yIGRlZmF1bHRzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRBSUNvbmZpZygpOiBBSUNvbmZpZyB7XG4gIC8vIFJlYWQgZnJvbSBlbnZpcm9ubWVudCB2YXJpYWJsZXMgKHZpYSBleHBvLWNvbnN0YW50cylcbiAgY29uc3QgYXBpS2V5ID0gQ29uc3RhbnRzLmV4cG9Db25maWc/LmV4dHJhPy5vcGVuYWlBcGlLZXkgfHwgXG4gICAgICAgICAgICAgICAgIHByb2Nlc3MuZW52Lk9QRU5BSV9BUElfS0VZIHx8IFxuICAgICAgICAgICAgICAgICB1bmRlZmluZWQ7XG4gIFxuICBjb25zdCBwcm92aWRlciA9IChDb25zdGFudHMuZXhwb0NvbmZpZz8uZXh0cmE/LmFpUHJvdmlkZXIgfHwgXG4gICAgICAgICAgICAgICAgICAgIHByb2Nlc3MuZW52LkFJX1BST1ZJREVSIHx8IFxuICAgICAgICAgICAgICAgICAgICAnbG9jYWwnKSBhcyBBSUNvbmZpZ1sncHJvdmlkZXInXTtcblxuICBjb25zdCBlbmRwb2ludCA9IENvbnN0YW50cy5leHBvQ29uZmlnPy5leHRyYT8ub3BlbmFpQXBpQmFzZVVybCB8fCBcbiAgICAgICAgICAgICAgICAgICBwcm9jZXNzLmVudi5PUEVOQUlfQVBJX0JBU0VfVVJMIHx8IFxuICAgICAgICAgICAgICAgICAgICdodHRwczovL2FwaS5vcGVuYWkuY29tL3YxJztcblxuICByZXR1cm4ge1xuICAgIHByb3ZpZGVyLFxuICAgIGFwaUtleSxcbiAgICBlbmRwb2ludCxcbiAgfTtcbn1cblxuLyoqXG4gKiBNYXAgT3BlbkFJIG1vZGVyYXRpb24gY2F0ZWdvcmllcyB0byBvdXIgcmlzayBjYXRlZ29yaWVzXG4gKi9cbmZ1bmN0aW9uIG1hcE9wZW5BSUNhdGVnb3JpZXNUb1Jpc2tDYXRlZ29yaWVzKGNhdGVnb3JpZXM6IFJlY29yZDxzdHJpbmcsIGJvb2xlYW4+KTogc3RyaW5nW10ge1xuICBjb25zdCBtYXBwZWQ6IHN0cmluZ1tdID0gW107XG4gIFxuICBpZiAoY2F0ZWdvcmllcy5oYXRlKSBtYXBwZWQucHVzaCgnaGF0ZScpO1xuICBpZiAoY2F0ZWdvcmllc1snaGF0ZS90aHJlYXRlbmluZyddKSBtYXBwZWQucHVzaCgnaGF0ZV90aHJlYXRlbmluZycpO1xuICBpZiAoY2F0ZWdvcmllc1snc2VsZi1oYXJtJ10pIG1hcHBlZC5wdXNoKCdzZWxmX2hhcm0nKTtcbiAgaWYgKGNhdGVnb3JpZXMuc2V4dWFsKSBtYXBwZWQucHVzaCgnc2V4dWFsJyk7XG4gIGlmIChjYXRlZ29yaWVzWydzZXh1YWwvbWlub3JzJ10pIG1hcHBlZC5wdXNoKCdzZXh1YWxfbWlub3JzJyk7XG4gIGlmIChjYXRlZ29yaWVzLnZpb2xlbmNlKSBtYXBwZWQucHVzaCgndmlvbGVuY2UnKTtcbiAgaWYgKGNhdGVnb3JpZXNbJ3Zpb2xlbmNlL2dyYXBoaWMnXSkgbWFwcGVkLnB1c2goJ3Zpb2xlbmNlX2dyYXBoaWMnKTtcbiAgXG4gIHJldHVybiBtYXBwZWQ7XG59XG5cbi8qKlxuICogTWFwIE9wZW5BSSBtb2RlcmF0aW9uIHJlc3VsdCB0byBvdXIgUmlza0xldmVsXG4gKi9cbmZ1bmN0aW9uIG1hcE9wZW5BSVRvUmlza0xldmVsKGZsYWdnZWQ6IGJvb2xlYW4sIGNhdGVnb3J5U2NvcmVzOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+KTogUmlza0xldmVsIHtcbiAgaWYgKCFmbGFnZ2VkKSB7XG4gICAgcmV0dXJuICdzYWZlJztcbiAgfVxuXG4gIC8vINCe0L/RgNC10LTQtdC70Y/QtdC8INGD0YDQvtCy0LXQvdGMINGA0LjRgdC60LAg0L3QsCDQvtGB0L3QvtCy0LUg0LzQsNC60YHQuNC80LDQu9GM0L3QvtCz0L4gc2NvcmVcbiAgY29uc3QgbWF4U2NvcmUgPSBNYXRoLm1heCguLi5PYmplY3QudmFsdWVzKGNhdGVnb3J5U2NvcmVzKSk7XG4gIFxuICBpZiAobWF4U2NvcmUgPj0gMC45KSByZXR1cm4gJ2NyaXRpY2FsJztcbiAgaWYgKG1heFNjb3JlID49IDAuNykgcmV0dXJuICdoaWdoJztcbiAgaWYgKG1heFNjb3JlID49IDAuNSkgcmV0dXJuICdtZWRpdW0nO1xuICByZXR1cm4gJ2xvdyc7XG59XG5cbi8qKlxuICogQW5hbHl6ZSBtZXNzYWdlIHdpdGggT3BlbkFJIE1vZGVyYXRpb24gQVBJXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGFuYWx5emVXaXRoT3BlbkFJKFxuICB0ZXh0OiBzdHJpbmcsXG4gIGFwaUtleTogc3RyaW5nLFxuICBlbmRwb2ludDogc3RyaW5nID0gJ2h0dHBzOi8vYXBpLm9wZW5haS5jb20vdjEnXG4pOiBQcm9taXNlPFJpc2tBbmFseXNpcz4ge1xuICB0cnkge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goYCR7ZW5kcG9pbnR9L21vZGVyYXRpb25zYCwge1xuICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke2FwaUtleX1gLFxuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgfSxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgaW5wdXQ6IHRleHQsXG4gICAgICB9KSxcbiAgICB9KTtcblxuICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgIGNvbnN0IGVycm9yVGV4dCA9IGF3YWl0IHJlc3BvbnNlLnRleHQoKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgT3BlbkFJIEFQSSBlcnJvcjogJHtyZXNwb25zZS5zdGF0dXN9IC0gJHtlcnJvclRleHR9YCk7XG4gICAgfVxuXG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTtcbiAgICBjb25zdCByZXN1bHQgPSBkYXRhLnJlc3VsdHNbMF07XG5cbiAgICBpZiAoIXJlc3VsdCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHJlc3BvbnNlIGZyb20gT3BlbkFJIEFQSScpO1xuICAgIH1cblxuICAgIGNvbnN0IHJpc2tMZXZlbCA9IG1hcE9wZW5BSVRvUmlza0xldmVsKHJlc3VsdC5mbGFnZ2VkLCByZXN1bHQuY2F0ZWdvcnlfc2NvcmVzKTtcbiAgICBjb25zdCBjYXRlZ29yaWVzID0gbWFwT3BlbkFJQ2F0ZWdvcmllc1RvUmlza0NhdGVnb3JpZXMocmVzdWx0LmNhdGVnb3JpZXMpO1xuICAgIFxuICAgIGNvbnN0IHJlYXNvbnM6IHN0cmluZ1tdID0gW107XG4gICAgaWYgKHJlc3VsdC5mbGFnZ2VkKSB7XG4gICAgICBPYmplY3QuZW50cmllcyhyZXN1bHQuY2F0ZWdvcmllcykuZm9yRWFjaCgoW2NhdGVnb3J5LCBmbGFnZ2VkXSkgPT4ge1xuICAgICAgICBpZiAoZmxhZ2dlZCkge1xuICAgICAgICAgIHJlYXNvbnMucHVzaChgRGV0ZWN0ZWQ6ICR7Y2F0ZWdvcnl9YCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IG1heFNjb3JlID0gTWF0aC5tYXgoLi4uT2JqZWN0LnZhbHVlcyhyZXN1bHQuY2F0ZWdvcnlfc2NvcmVzIGFzIFJlY29yZDxzdHJpbmcsIG51bWJlcj4pKTtcbiAgICBjb25zdCBjb25maWRlbmNlID0gcmVzdWx0LmZsYWdnZWQgPyBtYXhTY29yZSA6IDEgLSBtYXhTY29yZTtcblxuICAgIHJldHVybiB7XG4gICAgICByaXNrTGV2ZWwsXG4gICAgICBjb25maWRlbmNlLFxuICAgICAgcmVhc29ucyxcbiAgICAgIGNhdGVnb3JpZXMsXG4gICAgfTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ09wZW5BSSBBUEkgZXJyb3InLCBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IgOiBuZXcgRXJyb3IoU3RyaW5nKGVycm9yKSksIHtcbiAgICAgIGNvbnRleHQ6ICdhaVNlcnZpY2UnLFxuICAgICAgYWN0aW9uOiAnYW5hbHl6ZVdpdGhPcGVuQUknLFxuICAgIH0pO1xuICAgIHRocm93IGVycm9yO1xuICB9XG59XG5cbi8vIFNpbXBsZSBpbi1tZW1vcnkgY2FjaGUgZm9yIEFJIGFuYWx5c2lzIHJlc3VsdHNcbi8vIEluIHByb2R1Y3Rpb24sIHRoaXMgc2hvdWxkIHVzZSBSZWRpcyBvciBzaW1pbGFyXG5jb25zdCBhbmFseXNpc0NhY2hlID0gbmV3IE1hcDxzdHJpbmcsIHsgcmVzdWx0OiBSaXNrQW5hbHlzaXM7IHRpbWVzdGFtcDogbnVtYmVyIH0+KCk7XG5jb25zdCBDQUNIRV9UVEwgPSAyNCAqIDYwICogNjAgKiAxMDAwOyAvLyAyNCBob3Vyc1xuXG4vKipcbiAqIEdldCBjYWNoZSBrZXkgZm9yIHRleHQgYW5hbHlzaXNcbiAqL1xuZnVuY3Rpb24gZ2V0Q2FjaGVLZXkodGV4dDogc3RyaW5nKTogc3RyaW5nIHtcbiAgLy8gU2ltcGxlIGhhc2ggZm9yIGNhY2hlIGtleSAoaW4gcHJvZHVjdGlvbiwgdXNlIHByb3BlciBoYXNoaW5nKVxuICByZXR1cm4gYGFpX2FuYWx5c2lzXyR7dGV4dC5zdWJzdHJpbmcoMCwgMTAwKX1fJHt0ZXh0Lmxlbmd0aH1gO1xufVxuXG4vKipcbiAqIEdldCBjYWNoZWQgYW5hbHlzaXMgcmVzdWx0IGlmIGF2YWlsYWJsZVxuICovXG5mdW5jdGlvbiBnZXRDYWNoZWRBbmFseXNpcyh0ZXh0OiBzdHJpbmcpOiBSaXNrQW5hbHlzaXMgfCBudWxsIHtcbiAgY29uc3QgY2FjaGVLZXkgPSBnZXRDYWNoZUtleSh0ZXh0KTtcbiAgY29uc3QgY2FjaGVkID0gYW5hbHlzaXNDYWNoZS5nZXQoY2FjaGVLZXkpO1xuICBcbiAgaWYgKGNhY2hlZCAmJiBEYXRlLm5vdygpIC0gY2FjaGVkLnRpbWVzdGFtcCA8IENBQ0hFX1RUTCkge1xuICAgIHJldHVybiBjYWNoZWQucmVzdWx0O1xuICB9XG4gIFxuICBpZiAoY2FjaGVkKSB7XG4gICAgYW5hbHlzaXNDYWNoZS5kZWxldGUoY2FjaGVLZXkpOyAvLyBSZW1vdmUgZXhwaXJlZCBjYWNoZVxuICB9XG4gIFxuICByZXR1cm4gbnVsbDtcbn1cblxuLyoqXG4gKiBDYWNoZSBhbmFseXNpcyByZXN1bHRcbiAqL1xuZnVuY3Rpb24gY2FjaGVBbmFseXNpcyh0ZXh0OiBzdHJpbmcsIHJlc3VsdDogUmlza0FuYWx5c2lzKTogdm9pZCB7XG4gIGNvbnN0IGNhY2hlS2V5ID0gZ2V0Q2FjaGVLZXkodGV4dCk7XG4gIGFuYWx5c2lzQ2FjaGUuc2V0KGNhY2hlS2V5LCB7XG4gICAgcmVzdWx0LFxuICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgfSk7XG4gIFxuICAvLyBMaW1pdCBjYWNoZSBzaXplIChrZWVwIGxhc3QgMTAwMCBlbnRyaWVzKVxuICBpZiAoYW5hbHlzaXNDYWNoZS5zaXplID4gMTAwMCkge1xuICAgIGNvbnN0IGZpcnN0S2V5ID0gYW5hbHlzaXNDYWNoZS5rZXlzKCkubmV4dCgpLnZhbHVlO1xuICAgIGFuYWx5c2lzQ2FjaGUuZGVsZXRlKGZpcnN0S2V5KTtcbiAgfVxufVxuXG4vKipcbiAqIEFuYWx5emUgbWVzc2FnZSB3aXRoIHJlYWwgQUkgQVBJXG4gKiBTdXBwb3J0cyBPcGVuQUkgTW9kZXJhdGlvbiBBUEkgd2l0aCBmYWxsYmFjayB0byBsb2NhbCBhbmFseXNpc1xuICogSW5jbHVkZXMgY2FjaGluZyB0byByZWR1Y2UgQVBJIGNhbGxzXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBhbmFseXplTWVzc2FnZVdpdGhSZWFsQUkoXG4gIHRleHQ6IHN0cmluZyxcbiAgY29uZmlnOiBBSUNvbmZpZ1xuKTogUHJvbWlzZTxSaXNrQW5hbHlzaXM+IHtcbiAgLy8gQ2hlY2sgY2FjaGUgZmlyc3RcbiAgY29uc3QgY2FjaGVkID0gZ2V0Q2FjaGVkQW5hbHlzaXModGV4dCk7XG4gIGlmIChjYWNoZWQpIHtcbiAgICBsb2dnZXIuaW5mbygnVXNpbmcgY2FjaGVkIEFJIGFuYWx5c2lzJywge1xuICAgICAgY29udGV4dDogJ2FpU2VydmljZScsXG4gICAgICBhY3Rpb246ICdhbmFseXplTWVzc2FnZVdpdGhSZWFsQUknLFxuICAgIH0pO1xuICAgIHJldHVybiBjYWNoZWQ7XG4gIH1cblxuICAvLyDQldGB0LvQuCBPcGVuQUkg0L3QsNGB0YLRgNC+0LXQvSDQuCDQtdGB0YLRjCBBUEkg0LrQu9GO0YdcbiAgaWYgKGNvbmZpZy5wcm92aWRlciA9PT0gJ29wZW5haScgJiYgY29uZmlnLmFwaUtleSkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBhbmFseXplV2l0aE9wZW5BSSh0ZXh0LCBjb25maWcuYXBpS2V5LCBjb25maWcuZW5kcG9pbnQpO1xuICAgICAgLy8gQ2FjaGUgdGhlIHJlc3VsdFxuICAgICAgY2FjaGVBbmFseXNpcyh0ZXh0LCByZXN1bHQpO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgLy8gRmFsbGJhY2sg0L3QsCDQu9C+0LrQsNC70YzQvdGL0Lkg0LDQvdCw0LvQuNC3INC/0YDQuCDQvtGI0LjQsdC60LUgQVBJXG4gICAgICBsb2dnZXIud2FybignT3BlbkFJIEFQSSBmYWlsZWQsIGZhbGxpbmcgYmFjayB0byBsb2NhbCBhbmFseXNpcycsIHtcbiAgICAgICAgY29udGV4dDogJ2FpU2VydmljZScsXG4gICAgICAgIGFjdGlvbjogJ2FuYWx5emVNZXNzYWdlV2l0aFJlYWxBSScsXG4gICAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvciksXG4gICAgICB9KTtcbiAgICAgIC8vINCf0YDQvtC00L7Qu9C20LDQtdC8INC6INC70L7QutCw0LvRjNC90L7QvNGDINCw0L3QsNC70LjQt9GDXG4gICAgfVxuICB9XG5cbiAgLy8g0JvQvtC60LDQu9GM0L3Ri9C5INCw0L3QsNC70LjQtyAoZmFsbGJhY2sg0LjQu9C4INC10YHQu9C4IHByb3ZpZGVyPSdsb2NhbCcpXG4gIC8vINCt0YLQviDQsdGD0LTQtdGCINC+0LHRgNCw0LHQvtGC0LDQvdC+INCyIEFJTW9kZXJhdGlvblNlcnZpY2VcbiAgY29uc3QgZmFsbGJhY2tSZXN1bHQ6IFJpc2tBbmFseXNpcyA9IHtcbiAgICByaXNrTGV2ZWw6ICdzYWZlJyBhcyBSaXNrTGV2ZWwsXG4gICAgY29uZmlkZW5jZTogMC41LFxuICAgIHJlYXNvbnM6IFtdLFxuICAgIGNhdGVnb3JpZXM6IFtdLFxuICB9O1xuICBcbiAgLy8gQ2FjaGUgZmFsbGJhY2sgcmVzdWx0IHRvbyAoc2hvcnRlciBUVEwgY291bGQgYmUgdXNlZClcbiAgY2FjaGVBbmFseXNpcyh0ZXh0LCBmYWxsYmFja1Jlc3VsdCk7XG4gIFxuICByZXR1cm4gZmFsbGJhY2tSZXN1bHQ7XG59XG4iXSwibWFwcGluZ3MiOiI7OztBQU1BLFNBQVNBLE1BQU0sUUFBUSxVQUFVO0FBQ2pDLE9BQU9DLFNBQVMsTUFBTSxnQkFBZ0I7QUFXdEMsT0FBTyxTQUFTQyxXQUFXQSxDQUFBLEVBQWE7RUFBQSxJQUFBQyxxQkFBQSxFQUFBQyxzQkFBQSxFQUFBQyxzQkFBQTtFQUV0QyxJQUFNQyxNQUFNLEdBQUcsRUFBQUgscUJBQUEsR0FBQUYsU0FBUyxDQUFDTSxVQUFVLGNBQUFKLHFCQUFBLEdBQXBCQSxxQkFBQSxDQUFzQkssS0FBSyxxQkFBM0JMLHFCQUFBLENBQTZCTSxZQUFZLEtBQ3pDQyxPQUFPLENBQUNDLEdBQUcsQ0FBQ0MsY0FBYyxJQUMxQkMsU0FBUztFQUV4QixJQUFNQyxRQUFRLEdBQUksRUFBQVYsc0JBQUEsR0FBQUgsU0FBUyxDQUFDTSxVQUFVLGNBQUFILHNCQUFBLEdBQXBCQSxzQkFBQSxDQUFzQkksS0FBSyxxQkFBM0JKLHNCQUFBLENBQTZCVyxVQUFVLEtBQ3ZDTCxPQUFPLENBQUNDLEdBQUcsQ0FBQ0ssV0FBVyxJQUN2QixPQUFnQztFQUVsRCxJQUFNQyxRQUFRLEdBQUcsRUFBQVosc0JBQUEsR0FBQUosU0FBUyxDQUFDTSxVQUFVLGNBQUFGLHNCQUFBLEdBQXBCQSxzQkFBQSxDQUFzQkcsS0FBSyxxQkFBM0JILHNCQUFBLENBQTZCYSxnQkFBZ0IsS0FDN0NSLE9BQU8sQ0FBQ0MsR0FBRyxDQUFDUSxtQkFBbUIsSUFDL0IsMkJBQTJCO0VBRTVDLE9BQU87SUFDTEwsUUFBUSxFQUFSQSxRQUFRO0lBQ1JSLE1BQU0sRUFBTkEsTUFBTTtJQUNOVyxRQUFRLEVBQVJBO0VBQ0YsQ0FBQztBQUNIO0FBS0EsU0FBU0csbUNBQW1DQSxDQUFDQyxVQUFtQyxFQUFZO0VBQzFGLElBQU1DLE1BQWdCLEdBQUcsRUFBRTtFQUUzQixJQUFJRCxVQUFVLENBQUNFLElBQUksRUFBRUQsTUFBTSxDQUFDRSxJQUFJLENBQUMsTUFBTSxDQUFDO0VBQ3hDLElBQUlILFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFQyxNQUFNLENBQUNFLElBQUksQ0FBQyxrQkFBa0IsQ0FBQztFQUNuRSxJQUFJSCxVQUFVLENBQUMsV0FBVyxDQUFDLEVBQUVDLE1BQU0sQ0FBQ0UsSUFBSSxDQUFDLFdBQVcsQ0FBQztFQUNyRCxJQUFJSCxVQUFVLENBQUNJLE1BQU0sRUFBRUgsTUFBTSxDQUFDRSxJQUFJLENBQUMsUUFBUSxDQUFDO0VBQzVDLElBQUlILFVBQVUsQ0FBQyxlQUFlLENBQUMsRUFBRUMsTUFBTSxDQUFDRSxJQUFJLENBQUMsZUFBZSxDQUFDO0VBQzdELElBQUlILFVBQVUsQ0FBQ0ssUUFBUSxFQUFFSixNQUFNLENBQUNFLElBQUksQ0FBQyxVQUFVLENBQUM7RUFDaEQsSUFBSUgsVUFBVSxDQUFDLGtCQUFrQixDQUFDLEVBQUVDLE1BQU0sQ0FBQ0UsSUFBSSxDQUFDLGtCQUFrQixDQUFDO0VBRW5FLE9BQU9GLE1BQU07QUFDZjtBQUtBLFNBQVNLLG9CQUFvQkEsQ0FBQ0MsT0FBZ0IsRUFBRUMsY0FBc0MsRUFBYTtFQUNqRyxJQUFJLENBQUNELE9BQU8sRUFBRTtJQUNaLE9BQU8sTUFBTTtFQUNmO0VBR0EsSUFBTUUsUUFBUSxHQUFHQyxJQUFJLENBQUNDLEdBQUcsQ0FBQUMsS0FBQSxDQUFSRixJQUFJLEVBQUFHLGtCQUFBLENBQVFDLE1BQU0sQ0FBQ0MsTUFBTSxDQUFDUCxjQUFjLENBQUMsRUFBQztFQUUzRCxJQUFJQyxRQUFRLElBQUksR0FBRyxFQUFFLE9BQU8sVUFBVTtFQUN0QyxJQUFJQSxRQUFRLElBQUksR0FBRyxFQUFFLE9BQU8sTUFBTTtFQUNsQyxJQUFJQSxRQUFRLElBQUksR0FBRyxFQUFFLE9BQU8sUUFBUTtFQUNwQyxPQUFPLEtBQUs7QUFDZDtBQUFDLFNBS2NPLGlCQUFpQkEsQ0FBQUMsRUFBQSxFQUFBQyxHQUFBO0VBQUEsT0FBQUMsa0JBQUEsQ0FBQVAsS0FBQSxPQUFBUSxTQUFBO0FBQUE7QUFBQSxTQUFBRCxtQkFBQTtFQUFBQSxrQkFBQSxHQUFBRSxpQkFBQSxDQUFoQyxXQUNFQyxJQUFZLEVBQ1pyQyxNQUFjLEVBRVM7SUFBQSxJQUR2QlcsUUFBZ0IsR0FBQXdCLFNBQUEsQ0FBQUcsTUFBQSxRQUFBSCxTQUFBLFFBQUE1QixTQUFBLEdBQUE0QixTQUFBLE1BQUcsMkJBQTJCO0lBRTlDLElBQUk7TUFDRixJQUFNSSxRQUFRLFNBQVNDLEtBQUssQ0FBQyxHQUFHN0IsUUFBUSxjQUFjLEVBQUU7UUFDdEQ4QixNQUFNLEVBQUUsTUFBTTtRQUNkQyxPQUFPLEVBQUU7VUFDUCxlQUFlLEVBQUUsVUFBVTFDLE1BQU0sRUFBRTtVQUNuQyxjQUFjLEVBQUU7UUFDbEIsQ0FBQztRQUNEMkMsSUFBSSxFQUFFQyxJQUFJLENBQUNDLFNBQVMsQ0FBQztVQUNuQkMsS0FBSyxFQUFFVDtRQUNULENBQUM7TUFDSCxDQUFDLENBQUM7TUFFRixJQUFJLENBQUNFLFFBQVEsQ0FBQ1EsRUFBRSxFQUFFO1FBQ2hCLElBQU1DLFNBQVMsU0FBU1QsUUFBUSxDQUFDRixJQUFJLENBQUMsQ0FBQztRQUN2QyxNQUFNLElBQUlZLEtBQUssQ0FBQyxxQkFBcUJWLFFBQVEsQ0FBQ1csTUFBTSxNQUFNRixTQUFTLEVBQUUsQ0FBQztNQUN4RTtNQUVBLElBQU1HLElBQUksU0FBU1osUUFBUSxDQUFDYSxJQUFJLENBQUMsQ0FBQztNQUNsQyxJQUFNQyxNQUFNLEdBQUdGLElBQUksQ0FBQ0csT0FBTyxDQUFDLENBQUMsQ0FBQztNQUU5QixJQUFJLENBQUNELE1BQU0sRUFBRTtRQUNYLE1BQU0sSUFBSUosS0FBSyxDQUFDLGtDQUFrQyxDQUFDO01BQ3JEO01BRUEsSUFBTU0sU0FBUyxHQUFHbEMsb0JBQW9CLENBQUNnQyxNQUFNLENBQUMvQixPQUFPLEVBQUUrQixNQUFNLENBQUNHLGVBQWUsQ0FBQztNQUM5RSxJQUFNekMsVUFBVSxHQUFHRCxtQ0FBbUMsQ0FBQ3VDLE1BQU0sQ0FBQ3RDLFVBQVUsQ0FBQztNQUV6RSxJQUFNMEMsT0FBaUIsR0FBRyxFQUFFO01BQzVCLElBQUlKLE1BQU0sQ0FBQy9CLE9BQU8sRUFBRTtRQUNsQk8sTUFBTSxDQUFDNkIsT0FBTyxDQUFDTCxNQUFNLENBQUN0QyxVQUFVLENBQUMsQ0FBQzRDLE9BQU8sQ0FBQyxVQUFBQyxJQUFBLEVBQXlCO1VBQUEsSUFBQUMsS0FBQSxHQUFBQyxjQUFBLENBQUFGLElBQUE7WUFBdkJHLFFBQVEsR0FBQUYsS0FBQTtZQUFFdkMsT0FBTyxHQUFBdUMsS0FBQTtVQUMzRCxJQUFJdkMsT0FBTyxFQUFFO1lBQ1htQyxPQUFPLENBQUN2QyxJQUFJLENBQUMsYUFBYTZDLFFBQVEsRUFBRSxDQUFDO1VBQ3ZDO1FBQ0YsQ0FBQyxDQUFDO01BQ0o7TUFFQSxJQUFNdkMsUUFBUSxHQUFHQyxJQUFJLENBQUNDLEdBQUcsQ0FBQUMsS0FBQSxDQUFSRixJQUFJLEVBQUFHLGtCQUFBLENBQVFDLE1BQU0sQ0FBQ0MsTUFBTSxDQUFDdUIsTUFBTSxDQUFDRyxlQUF5QyxDQUFDLEVBQUM7TUFDN0YsSUFBTVEsVUFBVSxHQUFHWCxNQUFNLENBQUMvQixPQUFPLEdBQUdFLFFBQVEsR0FBRyxDQUFDLEdBQUdBLFFBQVE7TUFFM0QsT0FBTztRQUNMK0IsU0FBUyxFQUFUQSxTQUFTO1FBQ1RTLFVBQVUsRUFBVkEsVUFBVTtRQUNWUCxPQUFPLEVBQVBBLE9BQU87UUFDUDFDLFVBQVUsRUFBVkE7TUFDRixDQUFDO0lBQ0gsQ0FBQyxDQUFDLE9BQU9rRCxLQUFLLEVBQUU7TUFDZHZFLE1BQU0sQ0FBQ3VFLEtBQUssQ0FBQyxrQkFBa0IsRUFBRUEsS0FBSyxZQUFZaEIsS0FBSyxHQUFHZ0IsS0FBSyxHQUFHLElBQUloQixLQUFLLENBQUNpQixNQUFNLENBQUNELEtBQUssQ0FBQyxDQUFDLEVBQUU7UUFDMUZFLE9BQU8sRUFBRSxXQUFXO1FBQ3BCQyxNQUFNLEVBQUU7TUFDVixDQUFDLENBQUM7TUFDRixNQUFNSCxLQUFLO0lBQ2I7RUFDRixDQUFDO0VBQUEsT0FBQS9CLGtCQUFBLENBQUFQLEtBQUEsT0FBQVEsU0FBQTtBQUFBO0FBSUQsSUFBTWtDLGFBQWEsR0FBRyxJQUFJQyxHQUFHLENBQXNELENBQUM7QUFDcEYsSUFBTUMsU0FBUyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUk7QUFLckMsU0FBU0MsV0FBV0EsQ0FBQ25DLElBQVksRUFBVTtFQUV6QyxPQUFPLGVBQWVBLElBQUksQ0FBQ29DLFNBQVMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLElBQUlwQyxJQUFJLENBQUNDLE1BQU0sRUFBRTtBQUMvRDtBQUtBLFNBQVNvQyxpQkFBaUJBLENBQUNyQyxJQUFZLEVBQXVCO0VBQzVELElBQU1zQyxRQUFRLEdBQUdILFdBQVcsQ0FBQ25DLElBQUksQ0FBQztFQUNsQyxJQUFNdUMsTUFBTSxHQUFHUCxhQUFhLENBQUNRLEdBQUcsQ0FBQ0YsUUFBUSxDQUFDO0VBRTFDLElBQUlDLE1BQU0sSUFBSUUsSUFBSSxDQUFDQyxHQUFHLENBQUMsQ0FBQyxHQUFHSCxNQUFNLENBQUNJLFNBQVMsR0FBR1QsU0FBUyxFQUFFO0lBQ3ZELE9BQU9LLE1BQU0sQ0FBQ3ZCLE1BQU07RUFDdEI7RUFFQSxJQUFJdUIsTUFBTSxFQUFFO0lBQ1ZQLGFBQWEsQ0FBQ1ksTUFBTSxDQUFDTixRQUFRLENBQUM7RUFDaEM7RUFFQSxPQUFPLElBQUk7QUFDYjtBQUtBLFNBQVNPLGFBQWFBLENBQUM3QyxJQUFZLEVBQUVnQixNQUFvQixFQUFRO0VBQy9ELElBQU1zQixRQUFRLEdBQUdILFdBQVcsQ0FBQ25DLElBQUksQ0FBQztFQUNsQ2dDLGFBQWEsQ0FBQ2MsR0FBRyxDQUFDUixRQUFRLEVBQUU7SUFDMUJ0QixNQUFNLEVBQU5BLE1BQU07SUFDTjJCLFNBQVMsRUFBRUYsSUFBSSxDQUFDQyxHQUFHLENBQUM7RUFDdEIsQ0FBQyxDQUFDO0VBR0YsSUFBSVYsYUFBYSxDQUFDZSxJQUFJLEdBQUcsSUFBSSxFQUFFO0lBQzdCLElBQU1DLFFBQVEsR0FBR2hCLGFBQWEsQ0FBQ2lCLElBQUksQ0FBQyxDQUFDLENBQUNDLElBQUksQ0FBQyxDQUFDLENBQUNDLEtBQUs7SUFDbERuQixhQUFhLENBQUNZLE1BQU0sQ0FBQ0ksUUFBUSxDQUFDO0VBQ2hDO0FBQ0Y7QUFPQSxnQkFBc0JJLHdCQUF3QkEsQ0FBQUMsR0FBQSxFQUFBQyxHQUFBO0VBQUEsT0FBQUMseUJBQUEsQ0FBQWpFLEtBQUEsT0FBQVEsU0FBQTtBQUFBO0FBNkM3QyxTQUFBeUQsMEJBQUE7RUFBQUEseUJBQUEsR0FBQXhELGlCQUFBLENBN0NNLFdBQ0xDLElBQVksRUFDWndELE1BQWdCLEVBQ087SUFFdkIsSUFBTWpCLE1BQU0sR0FBR0YsaUJBQWlCLENBQUNyQyxJQUFJLENBQUM7SUFDdEMsSUFBSXVDLE1BQU0sRUFBRTtNQUNWbEYsTUFBTSxDQUFDb0csSUFBSSxDQUFDLDBCQUEwQixFQUFFO1FBQ3RDM0IsT0FBTyxFQUFFLFdBQVc7UUFDcEJDLE1BQU0sRUFBRTtNQUNWLENBQUMsQ0FBQztNQUNGLE9BQU9RLE1BQU07SUFDZjtJQUdBLElBQUlpQixNQUFNLENBQUNyRixRQUFRLEtBQUssUUFBUSxJQUFJcUYsTUFBTSxDQUFDN0YsTUFBTSxFQUFFO01BQ2pELElBQUk7UUFDRixJQUFNcUQsTUFBTSxTQUFTdEIsaUJBQWlCLENBQUNNLElBQUksRUFBRXdELE1BQU0sQ0FBQzdGLE1BQU0sRUFBRTZGLE1BQU0sQ0FBQ2xGLFFBQVEsQ0FBQztRQUU1RXVFLGFBQWEsQ0FBQzdDLElBQUksRUFBRWdCLE1BQU0sQ0FBQztRQUMzQixPQUFPQSxNQUFNO01BQ2YsQ0FBQyxDQUFDLE9BQU9ZLEtBQUssRUFBRTtRQUVkdkUsTUFBTSxDQUFDcUcsSUFBSSxDQUFDLG1EQUFtRCxFQUFFO1VBQy9ENUIsT0FBTyxFQUFFLFdBQVc7VUFDcEJDLE1BQU0sRUFBRSwwQkFBMEI7VUFDbENILEtBQUssRUFBRUEsS0FBSyxZQUFZaEIsS0FBSyxHQUFHZ0IsS0FBSyxDQUFDK0IsT0FBTyxHQUFHOUIsTUFBTSxDQUFDRCxLQUFLO1FBQzlELENBQUMsQ0FBQztNQUVKO0lBQ0Y7SUFJQSxJQUFNZ0MsY0FBNEIsR0FBRztNQUNuQzFDLFNBQVMsRUFBRSxNQUFtQjtNQUM5QlMsVUFBVSxFQUFFLEdBQUc7TUFDZlAsT0FBTyxFQUFFLEVBQUU7TUFDWDFDLFVBQVUsRUFBRTtJQUNkLENBQUM7SUFHRG1FLGFBQWEsQ0FBQzdDLElBQUksRUFBRTRELGNBQWMsQ0FBQztJQUVuQyxPQUFPQSxjQUFjO0VBQ3ZCLENBQUM7RUFBQSxPQUFBTCx5QkFBQSxDQUFBakUsS0FBQSxPQUFBUSxTQUFBO0FBQUEiLCJpZ25vcmVMaXN0IjpbXX0=
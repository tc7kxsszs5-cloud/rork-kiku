{"version":3,"names":["logger","Constants","getAIConfig","_Constants$expoConfig","_Constants$expoConfig2","_Constants$expoConfig3","apiKey","expoConfig","extra","openaiApiKey","process","env","OPENAI_API_KEY","undefined","provider","aiProvider","AI_PROVIDER","endpoint","openaiApiBaseUrl","OPENAI_API_BASE_URL","mapOpenAICategoriesToRiskCategories","categories","mapped","hate","push","sexual","violence","mapOpenAIToRiskLevel","flagged","categoryScores","maxScore","Math","max","apply","_toConsumableArray","Object","values","analyzeWithOpenAI","_x","_x2","_analyzeWithOpenAI","arguments","_asyncToGenerator","text","length","response","fetch","method","headers","body","JSON","stringify","input","ok","errorText","Error","status","data","json","result","results","riskLevel","category_scores","reasons","entries","forEach","_ref","_ref2","_slicedToArray","category","confidence","error","String","context","action","analysisCache","Map","CACHE_TTL","getCacheKey","substring","getCachedAnalysis","cacheKey","cached","get","Date","now","timestamp","delete","cacheAnalysis","set","size","firstKey","keys","next","value","analyzeMessageWithRealAI","_x3","_x4","_analyzeMessageWithRealAI","config","info","warn","message","fallbackResult"],"sources":["aiService.ts"],"sourcesContent":["/**\n * AI Service\n * Provides AI analysis capabilities for messages and images\n */\n\nimport { RiskAnalysis, RiskLevel } from '@/constants/types';\nimport { logger } from './logger';\nimport Constants from 'expo-constants';\n\nexport interface AIConfig {\n  provider: 'local' | 'openai' | 'anthropic' | 'custom';\n  apiKey?: string;\n  endpoint?: string;\n}\n\n/**\n * Get AI configuration from environment or defaults\n */\nexport function getAIConfig(): AIConfig {\n  // Read from environment variables (via expo-constants)\n  const apiKey = Constants.expoConfig?.extra?.openaiApiKey || \n                 process.env.OPENAI_API_KEY || \n                 undefined;\n  \n  const provider = (Constants.expoConfig?.extra?.aiProvider || \n                    process.env.AI_PROVIDER || \n                    'local') as AIConfig['provider'];\n\n  const endpoint = Constants.expoConfig?.extra?.openaiApiBaseUrl || \n                   process.env.OPENAI_API_BASE_URL || \n                   'https://api.openai.com/v1';\n\n  return {\n    provider,\n    apiKey,\n    endpoint,\n  };\n}\n\n/**\n * Map OpenAI moderation categories to our risk categories\n */\nfunction mapOpenAICategoriesToRiskCategories(categories: Record<string, boolean>): string[] {\n  const mapped: string[] = [];\n  \n  if (categories.hate) mapped.push('hate');\n  if (categories['hate/threatening']) mapped.push('hate_threatening');\n  if (categories['self-harm']) mapped.push('self_harm');\n  if (categories.sexual) mapped.push('sexual');\n  if (categories['sexual/minors']) mapped.push('sexual_minors');\n  if (categories.violence) mapped.push('violence');\n  if (categories['violence/graphic']) mapped.push('violence_graphic');\n  \n  return mapped;\n}\n\n/**\n * Map OpenAI moderation result to our RiskLevel\n */\nfunction mapOpenAIToRiskLevel(flagged: boolean, categoryScores: Record<string, number>): RiskLevel {\n  if (!flagged) {\n    return 'safe';\n  }\n\n  // Определяем уровень риска на основе максимального score\n  const maxScore = Math.max(...Object.values(categoryScores));\n  \n  if (maxScore >= 0.9) return 'critical';\n  if (maxScore >= 0.7) return 'high';\n  if (maxScore >= 0.5) return 'medium';\n  return 'low';\n}\n\n/**\n * Analyze message with OpenAI Moderation API\n */\nasync function analyzeWithOpenAI(\n  text: string,\n  apiKey: string,\n  endpoint: string = 'https://api.openai.com/v1'\n): Promise<RiskAnalysis> {\n  try {\n    const response = await fetch(`${endpoint}/moderations`, {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${apiKey}`,\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        input: text,\n      }),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(`OpenAI API error: ${response.status} - ${errorText}`);\n    }\n\n    const data = await response.json();\n    const result = data.results[0];\n\n    if (!result) {\n      throw new Error('Invalid response from OpenAI API');\n    }\n\n    const riskLevel = mapOpenAIToRiskLevel(result.flagged, result.category_scores);\n    const categories = mapOpenAICategoriesToRiskCategories(result.categories);\n    \n    const reasons: string[] = [];\n    if (result.flagged) {\n      Object.entries(result.categories).forEach(([category, flagged]) => {\n        if (flagged) {\n          reasons.push(`Detected: ${category}`);\n        }\n      });\n    }\n\n    const maxScore = Math.max(...Object.values(result.category_scores as Record<string, number>));\n    const confidence = result.flagged ? maxScore : 1 - maxScore;\n\n    return {\n      riskLevel,\n      confidence,\n      reasons,\n      categories,\n    };\n  } catch (error) {\n    logger.error('OpenAI API error', error instanceof Error ? error : new Error(String(error)), {\n      context: 'aiService',\n      action: 'analyzeWithOpenAI',\n    });\n    throw error;\n  }\n}\n\n// Simple in-memory cache for AI analysis results\n// In production, this should use Redis or similar\nconst analysisCache = new Map<string, { result: RiskAnalysis; timestamp: number }>();\nconst CACHE_TTL = 24 * 60 * 60 * 1000; // 24 hours\n\n/**\n * Get cache key for text analysis\n */\nfunction getCacheKey(text: string): string {\n  // Simple hash for cache key (in production, use proper hashing)\n  return `ai_analysis_${text.substring(0, 100)}_${text.length}`;\n}\n\n/**\n * Get cached analysis result if available\n */\nfunction getCachedAnalysis(text: string): RiskAnalysis | null {\n  const cacheKey = getCacheKey(text);\n  const cached = analysisCache.get(cacheKey);\n  \n  if (cached && Date.now() - cached.timestamp < CACHE_TTL) {\n    return cached.result;\n  }\n  \n  if (cached) {\n    analysisCache.delete(cacheKey); // Remove expired cache\n  }\n  \n  return null;\n}\n\n/**\n * Cache analysis result\n */\nfunction cacheAnalysis(text: string, result: RiskAnalysis): void {\n  const cacheKey = getCacheKey(text);\n  analysisCache.set(cacheKey, {\n    result,\n    timestamp: Date.now(),\n  });\n  \n  // Limit cache size (keep last 1000 entries)\n  if (analysisCache.size > 1000) {\n    const firstKey = analysisCache.keys().next().value;\n    analysisCache.delete(firstKey);\n  }\n}\n\n/**\n * Analyze message with real AI API\n * Supports OpenAI Moderation API with fallback to local analysis\n * Includes caching to reduce API calls\n */\nexport async function analyzeMessageWithRealAI(\n  text: string,\n  config: AIConfig\n): Promise<RiskAnalysis> {\n  // Check cache first\n  const cached = getCachedAnalysis(text);\n  if (cached) {\n    logger.info('Using cached AI analysis', {\n      context: 'aiService',\n      action: 'analyzeMessageWithRealAI',\n    });\n    return cached;\n  }\n\n  // Если OpenAI настроен и есть API ключ\n  if (config.provider === 'openai' && config.apiKey) {\n    try {\n      const result = await analyzeWithOpenAI(text, config.apiKey, config.endpoint);\n      // Cache the result\n      cacheAnalysis(text, result);\n      return result;\n    } catch (error) {\n      // Fallback на локальный анализ при ошибке API\n      logger.warn('OpenAI API failed, falling back to local analysis', {\n        context: 'aiService',\n        action: 'analyzeMessageWithRealAI',\n        error: error instanceof Error ? error.message : String(error),\n      });\n      // Продолжаем к локальному анализу\n    }\n  }\n\n  // Локальный анализ (fallback или если provider='local')\n  // Это будет обработано в AIModerationService\n  const fallbackResult: RiskAnalysis = {\n    riskLevel: 'safe' as RiskLevel,\n    confidence: 0.5,\n    reasons: [],\n    categories: [],\n  };\n  \n  // Cache fallback result too (shorter TTL could be used)\n  cacheAnalysis(text, fallbackResult);\n  \n  return fallbackResult;\n}\n"],"mappings":"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","ignoreList":[]}
# 🔍 Как Playwright находит и запускает ваш проект

## 🎯 Короткий ответ

**Playwright автоматически запускает ваше приложение** перед тестами через настройку `webServer` в конфигурации. Вам **не нужно** запускать приложение вручную!

---

## 📋 Как это работает (пошагово)

### 1. Вы запускаете тесты

```bash
bun run test:playwright
```

### 2. Playwright читает конфигурацию

В файле `playwright.config.ts` есть секция `webServer`:

```typescript
webServer: {
  command: 'bun run start:web',        // ← Команда для запуска приложения
  url: 'http://localhost:8082',        // ← URL, который нужно проверить
  reuseExistingServer: !process.env.CI, // ← Использовать уже запущенный сервер
  timeout: 120 * 1000,                  // ← Ждать до 2 минут
  stdout: 'ignore',
  stderr: 'pipe',
}
```

### 3. Playwright автоматически запускает приложение

```bash
# Playwright выполняет эту команду за вас:
bun run start:web
```

Это запускает:
```bash
bunx expo start --web --port 8082
```

### 4. Playwright ждет, пока приложение запустится

Playwright проверяет URL `http://localhost:8082` каждые 500ms:
- ✅ Если приложение отвечает → тесты начинаются
- ❌ Если не отвечает за 2 минуты → ошибка

### 5. Тесты выполняются

Теперь Playwright может открывать страницы:
```typescript
await page.goto('/');  // → http://localhost:8082/
```

### 6. После тестов Playwright останавливает сервер

Автоматически закрывает процесс, если вы не запускали его вручную.

---

## 🔄 Два режима работы

### Режим 1: Автоматический запуск (по умолчанию)

```bash
bun run test:playwright
```

**Что происходит:**
1. Playwright запускает `bun run start:web`
2. Ждет, пока приложение запустится
3. Выполняет тесты
4. Останавливает сервер

**Плюсы:** Всё автоматически, не нужно ничего запускать вручную

---

### Режим 2: Использование уже запущенного сервера

Если вы уже запустили приложение вручную:

```bash
# Терминал 1: Запускаете приложение
bun run start:web

# Терминал 2: Запускаете тесты
bun run test:playwright
```

**Что происходит:**
1. Playwright видит, что сервер уже запущен на `http://localhost:8082`
2. Использует его (благодаря `reuseExistingServer: true`)
3. Выполняет тесты
4. **НЕ останавливает** ваш сервер

**Плюсы:** Можете видеть логи приложения во время тестов

---

## 🎛️ Настройка URL

### По умолчанию

Playwright использует `http://localhost:8082` (из конфигурации).

### Изменить URL

Если ваше приложение запущено на другом порту:

```bash
# Вариант 1: Через переменную окружения
PLAYWRIGHT_BASE_URL=http://localhost:3000 bun run test:playwright

# Вариант 2: Изменить в playwright.config.ts
baseURL: 'http://localhost:3000',
```

---

## 🔍 Как Playwright понимает, что приложение готово?

Playwright проверяет URL через HTTP запросы:

```typescript
// Playwright делает примерно так:
fetch('http://localhost:8082')
  .then(response => {
    if (response.ok) {
      // ✅ Приложение готово, можно начинать тесты
    } else {
      // ⏳ Еще не готово, подождать еще
    }
  })
```

Проверка происходит каждые 500ms до таймаута (2 минуты).

---

## 📊 Визуальная схема

```
┌─────────────────────────────────────────┐
│  Вы запускаете: bun run test:playwright │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  Playwright читает playwright.config.ts  │
│  Находит секцию webServer                │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  Playwright выполняет:                  │
│  bun run start:web                      │
│  (это запускает expo start --web)       │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  Playwright ждет ответа от:             │
│  http://localhost:8082                  │
│  (проверяет каждые 500ms)              │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  ✅ Приложение отвечает                 │
│  Playwright начинает тесты              │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  Тесты выполняются                      │
│  page.goto('/') → http://localhost:8082 │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  Тесты завершены                        │
│  Playwright останавливает сервер        │
└─────────────────────────────────────────┘
```

---

## 🛠️ Текущая конфигурация для KIKU

В вашем `playwright.config.ts`:

```typescript
webServer: {
  command: 'bun run start:web',  // ← Запускает Expo веб-сервер
  url: 'http://localhost:8082',  // ← Проверяет этот URL
  reuseExistingServer: !process.env.CI, // ← Использует уже запущенный
  timeout: 120 * 1000,           // ← Ждет до 2 минут
}
```

И в `package.json`:
```json
"start:web": "bunx expo start --web --port 8082"
```

**Итого:** Playwright знает, что нужно запустить `bun run start:web` и проверить `http://localhost:8082`.

---

## ❓ Частые вопросы

### Q: Нужно ли запускать приложение вручную?

**A:** Нет! Playwright запустит его автоматически. Но если хотите видеть логи - можете запустить вручную, Playwright использует уже запущенный сервер.

### Q: Что если порт 8082 занят?

**A:** Playwright выдаст ошибку. Освободите порт или измените порт в конфигурации.

### Q: Как узнать, что приложение запустилось?

**A:** Playwright покажет в логах:
```
Using existing web server at http://localhost:8082
```
или
```
Starting web server...
Web server is ready!
```

### Q: Можно ли тестировать на другом URL?

**A:** Да! Используйте переменную окружения:
```bash
PLAYWRIGHT_BASE_URL=https://your-app.com bun run test:playwright
```

---

## ✅ Итог

**Playwright автоматически:**
1. ✅ Запускает ваше приложение (`bun run start:web`)
2. ✅ Ждет, пока оно будет готово
3. ✅ Выполняет тесты
4. ✅ Останавливает сервер после тестов

**Вам не нужно ничего делать вручную!** Просто запустите `bun run test:playwright` и всё заработает. 🚀

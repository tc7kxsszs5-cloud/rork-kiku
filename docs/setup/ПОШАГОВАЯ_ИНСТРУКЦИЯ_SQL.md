# 📋 Пошаговая инструкция: Применение SQL политик безопасности

## 🎯 Что это такое?

**Row Level Security (RLS)** - это защита базы данных на уровне строк. Это означает, что даже если кто-то получит доступ к базе данных, он сможет видеть только свои данные (по device_id).

**Развертывание** - это публикация обновленного кода на сервер Vercel, чтобы изменения заработали в интернете.

---

## 📝 ШАГ 1: Применить SQL политики в Supabase

### Что нужно сделать:

1. **Откройте Supabase Dashboard**
   - Перейдите на: https://supabase.com/dashboard
   - Войдите в свой аккаунт
   - Выберите проект KIKU

2. **Откройте SQL Editor**
   - В левом меню найдите **"SQL Editor"** (иконка с символом `</>`)
   - Нажмите на него

3. **Откройте файл с SQL**
   - В вашем проекте откройте файл: `backend/security-policies.sql`
   - Выделите весь текст (Ctrl+A / Cmd+A)
   - Скопируйте (Ctrl+C / Cmd+C)

4. **Вставьте SQL в редактор**
   - В Supabase SQL Editor нажмите "New Query" (если нужно)
   - Вставьте скопированный SQL (Ctrl+V / Cmd+V)

5. **Выполните SQL**
   - Нажмите кнопку **"Run"** (или Ctrl+Enter / Cmd+Enter)
   - Дождитесь сообщения **"Success"**

### ✅ Проверка:

После выполнения вы должны увидеть:
- ✅ Сообщение "Success"
- ✅ В списке таблиц должны появиться политики безопасности

---

## 🚀 ШАГ 2: Развернуть обновленный backend

### Что такое развертывание?

**Развертывание (deployment)** - это процесс публикации вашего кода на сервер Vercel, чтобы он стал доступен в интернете по адресу `https://backend-three-mauve-67.vercel.app`

### Что нужно сделать:

1. **Откройте терминал**
   - В вашем проекте откройте терминал (Terminal)

2. **Перейдите в папку backend**
   ```bash
   cd backend
   ```

3. **Разверните на Vercel**
   ```bash
   bunx vercel --prod
   ```

4. **Дождитесь завершения**
   - Команда займет 20-30 секунд
   - Вы увидите сообщение: `Production: https://backend-three-mauve-67.vercel.app`

### ✅ Проверка:

После развертывания проверьте:
```bash
curl "https://backend-three-mauve-67.vercel.app/api/trpc/test.dbCheck"
```

Должен вернуться JSON с `"success": true`

---

## 📸 Визуальная инструкция:

### Supabase Dashboard:

```
┌─────────────────────────────────────┐
│  Supabase Dashboard                 │
├─────────────────────────────────────┤
│  [🏠] Home                          │
│  [📊] Table Editor                  │
│  [</>] SQL Editor  ← НАЖМИ СЮДА    │
│  [⚙️]  Settings                     │
└─────────────────────────────────────┘
```

### SQL Editor:

```
┌─────────────────────────────────────┐
│  SQL Editor                         │
├─────────────────────────────────────┤
│                                     │
│  [Вставьте SQL сюда]               │
│                                     │
│                                     │
├─────────────────────────────────────┤
│  [Run] [Save] [Format]              │
└─────────────────────────────────────┘
```

---

## ⚠️ Важно:

1. **SQL нужно выполнить ОДИН РАЗ** - после этого политики будут работать автоматически
2. **Развертывание нужно делать** каждый раз, когда вы меняете код backend
3. **Обе операции безопасны** - они не удалят ваши данные

---

## 🎯 Быстрая команда (все сразу):

Если хотите сделать все быстро:

```bash
# 1. Применить SQL (вручную в Supabase Dashboard)
# 2. Развернуть backend:
cd backend && bunx vercel --prod
```

---

## ❓ Частые вопросы:

**Q: Что если я ошибся в SQL?**  
A: Ничего страшного - можно выполнить заново. Политики обновятся.

**Q: Сколько времени занимает развертывание?**  
A: Обычно 20-30 секунд.

**Q: Нужно ли делать это каждый раз?**  
A: SQL - только один раз. Развертывание - каждый раз при изменении кода.

**Q: Что если развертывание не работает?**  
A: Проверьте, что вы в папке `backend` и у вас установлен Vercel CLI.

---

## ✅ Готово!

После выполнения этих двух шагов ваш проект будет полностью защищен!

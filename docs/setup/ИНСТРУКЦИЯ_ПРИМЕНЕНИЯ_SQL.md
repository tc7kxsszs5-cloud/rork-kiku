# Инструкция по применению SQL схемы родитель-ребенок

## Шаги для применения схемы в Supabase

1. **Откройте Supabase Dashboard**
   - Перейдите на https://supabase.com/dashboard
   - Выберите ваш проект

2. **Откройте SQL Editor**
   - В левом меню нажмите на "SQL Editor"
   - Или перейдите по прямой ссылке: `https://supabase.com/dashboard/project/[YOUR_PROJECT_ID]/sql`

3. **Скопируйте SQL код**
   - Откройте файл `SQL_РОДИТЕЛЬ_РЕБЕНОК_ДЛЯ_SUPABASE.sql`
   - Скопируйте весь содержимое файла

4. **Вставьте и выполните**
   - Вставьте скопированный SQL код в редактор
   - Нажмите кнопку "Run" или `Ctrl+Enter` (Windows/Linux) / `Cmd+Enter` (Mac)
   - Дождитесь завершения выполнения

5. **Проверьте результат**
   - В левом меню откройте "Table Editor"
   - Убедитесь, что созданы следующие таблицы:
     - `parents`
     - `parent_codes`
     - `code_usage_log`
     - `children`
     - `guardians`
     - `guardian_children`
     - `parent_activity`
     - `educational_programs`
     - `child_programs`
     - `content_monitoring`
     - `child_activity_log`
   - Также проверьте, что к существующим таблицам (`chats`, `messages`, `alerts`) добавлены новые колонки

## Важные замечания

- ⚠️ **Внимание**: SQL код использует `CREATE TABLE IF NOT EXISTS`, поэтому повторное выполнение не создаст дубликаты
- ✅ Все индексы создаются автоматически
- ✅ Foreign keys настроены с `ON DELETE CASCADE` для автоматической очистки связанных данных
- ✅ Проверки (CHECK constraints) обеспечивают валидность данных (возраст 4-15, версии UI и т.д.)

## После применения схемы

1. **Разверните backend на Vercel**:
   ```bash
   cd backend
   bunx vercel --prod
   ```

2. **Протестируйте регистрацию**:
   ```bash
   cd backend
   bun test-registration.ts
   ```

3. **Проверьте работу в приложении**:
   - Запустите приложение
   - При первом запуске должен появиться экран выбора роли
   - Выберите "Родитель" и зарегистрируйтесь
   - Получите код и используйте его для регистрации ребенка

## Устранение проблем

Если возникли ошибки:

1. **Ошибка "relation already exists"**:
   - Это нормально, таблицы уже существуют
   - Проверьте, что все таблицы созданы корректно

2. **Ошибка "column already exists"**:
   - Это нормально для `ALTER TABLE` команд
   - Колонки уже добавлены к существующим таблицам

3. **Ошибка foreign key constraint**:
   - Убедитесь, что таблицы создаются в правильном порядке
   - SQL файл уже содержит правильный порядок

4. **Проблемы с индексами**:
   - Индексы создаются с `IF NOT EXISTS`, повторное выполнение безопасно

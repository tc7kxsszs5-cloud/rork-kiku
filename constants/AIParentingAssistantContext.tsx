import createContextHook from '@nkzw/create-context-hook';
import { useState, useCallback, useMemo } from 'react';
import { useUser } from './UserContext';
import { useMonitoring } from './MonitoringContext';
import { useParentalControls } from './ParentalControlsContext';

export interface AssistantMessage {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  timestamp: number;
  suggestions?: string[];
}

export interface AIParentingAssistantContextValue {
  messages: AssistantMessage[];
  askQuestion: (question: string) => Promise<string>;
  getContextualAdvice: () => string[];
  getQuickTips: () => string[];
  clearHistory: () => void;
}

/**
 * AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª–µ–π
 * –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã
 */
export const [AIParentingAssistantProvider, useAIParentingAssistant] = createContextHook<AIParentingAssistantContextValue>(() => {
  // const { user } = useUser(); // Reserved for future use
  const { chats, alerts, unresolvedAlerts } = useMonitoring();
  const { settings, sosAlerts } = useParentalControls();
  const [messages, setMessages] = useState<AssistantMessage[]>([]);

  /**
   * –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤
   */
  const knowledgeBase: Record<string, string[]> = {
    '–∫–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å': [
      '–†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ä–µ–±–µ–Ω–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏',
      '–û–±—Å—É–∂–¥–∞–π—Ç–µ —Å —Ä–µ–±–µ–Ω–∫–æ–º –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ',
      '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –æ–±—â–µ–Ω–∏—è',
      '–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏',
      '–í–∫–ª—é—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è SOS –¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π',
    ],
    '–ª–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è': [
      '–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—É—á–∞–µ—Ç—Å—è –Ω–∞ –≤–∞—à–µ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏',
      '–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–º–µ—Ç–∏—Ç—å –ª–æ–∂–Ω–æ–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ, –∏ —Å–∏—Å—Ç–µ–º–∞ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è',
      '–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ —Å–Ω–∏–∂–∞—é—Ç –ª–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –Ω–∞ 90%',
      'Whitelist —Ñ—Ä–∞–∑—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—ã—á–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã –¥–ª—è –≤–∞—à–µ–≥–æ —Ä–µ–±–µ–Ω–∫–∞',
    ],
    '–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫': [
      '–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å —Ä–µ–±–µ–Ω–∫–æ–º',
      '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–µ—Ç–∞–ª–∏ –∞–ª–µ—Ä—Ç–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏',
      '–ï—Å–ª–∏ –Ω—É–∂–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É SOS –¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π –ø–æ–º–æ—â–∏',
      '–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É',
      '–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è',
    ],
    '–Ω–∞—Å—Ç—Ä–æ–π–∫–∏': [
      '–í —Ä–∞–∑–¥–µ–ª–µ "–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å" –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã',
      '–î–æ–±–∞–≤—å—Ç–µ email –æ–ø–µ–∫—É–Ω–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π',
      '–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏',
      '–°–æ–∑–¥–∞–π—Ç–µ –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤',
      '–í–∫–ª—é—á–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã',
    ],
    'sos': [
      '–ö–Ω–æ–ø–∫–∞ SOS –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –∫–∞–∂–¥–æ–º —á–∞—Ç–µ',
      '–ü—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º –æ–ø–µ–∫—É–Ω–∞–º',
      '–í–∫–ª—é—á–∞–µ—Ç—Å—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è',
      'SOS —Å–∏–≥–Ω–∞–ª—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è',
    ],
  };

  /**
   * –û—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   */
  const askQuestion = useCallback(
    async (question: string): Promise<string> => {
      const normalizedQuestion = question.toLowerCase();
      const userMessage: AssistantMessage = {
        id: `msg_${Date.now()}`,
        role: 'user',
        content: question,
        timestamp: Date.now(),
      };

      setMessages((prev) => [...prev, userMessage]);

      // –ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
      let answer = '';
      let suggestions: string[] = [];

      for (const [keyword, answers] of Object.entries(knowledgeBase)) {
        if (normalizedQuestion.includes(keyword)) {
          answer = answers[0];
          suggestions = answers.slice(1);
          break;
        }
      }

      // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö
      if (normalizedQuestion.includes('—Å–∫–æ–ª—å–∫–æ') || normalizedQuestion.includes('—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞')) {
        const totalChats = chats.length;
        const totalAlerts = alerts.length;
        const activeAlerts = unresolvedAlerts.length;
        answer = `–£ –≤–∞—Å ${totalChats} –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö —á–∞—Ç–æ–≤, ${totalAlerts} –≤—Å–µ–≥–æ –∞–ª–µ—Ä—Ç–æ–≤, –∏–∑ –Ω–∏—Ö ${activeAlerts} –∞–∫—Ç–∏–≤–Ω—ã—Ö.`;
      } else if (normalizedQuestion.includes('—á—Ç–æ –¥–µ–ª–∞—Ç—å') || normalizedQuestion.includes('—Å–æ–≤–µ—Ç')) {
        if (unresolvedAlerts.length > 0) {
          answer = `–£ –≤–∞—Å –µ—Å—Ç—å ${unresolvedAlerts.length} –Ω–µ—Ä–µ—à–µ–Ω–Ω—ã—Ö –∞–ª–µ—Ä—Ç–æ–≤. –†–µ–∫–æ–º–µ–Ω–¥—É—é –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Ö –≤ —Ä–∞–∑–¥–µ–ª–µ "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" –∏ –æ–±—Å—É–¥–∏—Ç—å —Å —Ä–µ–±–µ–Ω–∫–æ–º.`;
        } else {
          answer = '–û—Ç–ª–∏—á–Ω–æ! –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–µ–≤–æ–≥. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ä–µ–±–µ–Ω–∫–∞.';
        }
      } else if (normalizedQuestion.includes('—Ä–∏—Å–∫') || normalizedQuestion.includes('–æ–ø–∞—Å–Ω–æ')) {
        const highRiskAlerts = unresolvedAlerts.filter((a) => a.riskLevel === 'high' || a.riskLevel === 'critical');
        if (highRiskAlerts.length > 0) {
          answer = `–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ ${highRiskAlerts.length} –≤—ã—Å–æ–∫–∏—Ö —Ä–∏—Å–∫–æ–≤. –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–µ—Ç–∞–ª–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.`;
        } else {
          answer = '–í—ã—Å–æ–∫–∏—Ö —Ä–∏—Å–∫–æ–≤ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ. –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥.';
        }
      } else if (!answer) {
        // –û–±—â–∏–π –æ—Ç–≤–µ—Ç, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
        answer = '–Ø –º–æ–≥—É –ø–æ–º–æ—á—å –≤–∞–º —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è—Ö, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–∏—Å–∫–∞—Ö –∏ –º–Ω–æ–≥–æ–º –¥—Ä—É–≥–æ–º. –ó–∞–¥–∞–π—Ç–µ –±–æ–ª–µ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å, –∏ —è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—é –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç.';
        suggestions = [
          '–ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å —Ä–µ–±–µ–Ω–∫–∞?',
          '–ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è—Ö?',
          '–ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ?',
          '–ß—Ç–æ —Ç–∞–∫–æ–µ SOS?',
        ];
      }

      const assistantMessage: AssistantMessage = {
        id: `msg_${Date.now()}_assistant`,
        role: 'assistant',
        content: answer,
        timestamp: Date.now(),
        suggestions,
      };

      setMessages((prev) => [...prev, assistantMessage]);

      return answer;
    },
    [chats, alerts, unresolvedAlerts]
  );

  /**
   * –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏
   */
  const getContextualAdvice = useCallback((): string[] => {
    const advice: string[] = [];

    if (unresolvedAlerts.length > 0) {
      advice.push(`‚ö†Ô∏è –£ –≤–∞—Å ${unresolvedAlerts.length} –Ω–µ—Ä–µ—à–µ–Ω–Ω—ã—Ö –∞–ª–µ—Ä—Ç–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Ö –≤ —Ä–∞–∑–¥–µ–ª–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.`);
    }

    if (sosAlerts.filter((a) => !a.resolved).length > 0) {
      advice.push('üö® –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∞–∫—Ç–∏–≤–Ω—ã–µ SOS —Å–∏–≥–Ω–∞–ª—ã! –¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ.');
    }

    const highRiskChats = chats.filter((c) => c.overallRisk === 'high' || c.overallRisk === 'critical');
    if (highRiskChats.length > 0) {
      advice.push(`–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –æ–±–Ω–∞—Ä—É–∂–µ–Ω –≤ ${highRiskChats.length} —á–∞—Ç–∞—Ö. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É—Å–∏–ª–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥.`);
    }

    if (settings.blockUnknownContacts === false) {
      advice.push('üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤–∫–ª—é—á–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã.');
    }

    if (settings.guardianEmails.length === 0) {
      advice.push('üìß –î–æ–±–∞–≤—å—Ç–µ email –æ–ø–µ–∫—É–Ω–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Ä–∏—Å–∫–∞—Ö.');
    }

    if (advice.length === 0) {
      advice.push('‚úÖ –í—Å–µ –≤—ã–≥–ª—è–¥–∏—Ç —Ö–æ—Ä–æ—à–æ! –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ä–µ–±–µ–Ω–∫–∞.');
    }

    return advice;
  }, [chats, alerts, unresolvedAlerts, sosAlerts, settings]);

  /**
   * –ë—ã—Å—Ç—Ä—ã–µ —Å–æ–≤–µ—Ç—ã
   */
  const getQuickTips = useCallback((): string[] => {
    return [
      'üí° –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±—Å—É–∂–¥–∞–π—Ç–µ —Å —Ä–µ–±–µ–Ω–∫–æ–º –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ',
      'üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –æ–±—â–µ–Ω–∏—è',
      'üí° –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏',
      'üí° –û—Ç–º–µ—á–∞–π—Ç–µ –ª–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è - —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç —É—á–∏—Ç—å—Å—è',
      'üí° –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ö–æ—Ç—è –±—ã —Ä–∞–∑ –≤ –¥–µ–Ω—å',
      'üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ AI-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–≤–µ—Ç–æ–≤',
    ];
  }, []);

  const clearHistory = useCallback(() => {
    setMessages([]);
  }, []);

  return useMemo(
    () => ({
      messages,
      askQuestion,
      getContextualAdvice,
      getQuickTips,
      clearHistory,
    }),
    [messages, askQuestion, getContextualAdvice, getQuickTips, clearHistory]
  );
});

